---
author: Michael Flynn
title: "Crime Chapter"
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

# Notes

1. Year 3 Schlesinger data had some Yes values for specific crimes miscoding as 2 instead of Yes. I fix that in the data setup file.
2. The `troops_crime_type` column originates from the Qualtrics data. It's values are empty/missing for the Schlesinger data. If generating individual crime variables using this variable it will undercount the total number of reported crimes because it's missing data for six countries (Germany, Italy, Japan, Kuwait, South Korea, and the UK).


```{r setup , echo = FALSE, include = FALSE}

#devtools::install_github("lindeloev/job")
#devtools::install_github("mrjoh3/ggtrack")
#devtools::install_github("vincentarelbundock/modelsummary", force = TRUE)
##remotes::install_version("Rttf2pt1", version = "1.3.8")


library(tidyverse)
library(tidyr)
library(data.table)
library(job)
library(broom)
library(broom.mixed)
library(psych)
library(ipw)
library(modelr)
library(cshapes)
library(countrycode)
library(dagitty)
library(ggdag)
library(sf)
library(rgeos)
library(rworldmap)
library(rnaturalearth)
library(rnaturalearthdata)
library(arm)
library(brms)
library(rstan)
library(cmdstanr)
library(parallel)
library(tidybayes)
library(emmeans)
library(viridis)
library(scales)
library(ggdist)
library(ggh4x)
library(viridis)
library(kableExtra)
library(BayesPostEst)
library(texreg)
library(modelsummary)
library(gt)
library(webshot)
library(kableExtra)
library(ggExtra)
library(ggrepel)
library(ggmcmc)
library(lemon)
library(ggwaffle)
library(ggpubr)
library(ggtext)
library(ggcorrplot)
library(patchwork)
library(here)
library(arm)
library(performance)
#library(ROCR)
library(tictoc)
library(remotes)
library(emojifont)
library(formattable)
library(sparkline)
library(showtext)
library(ltxsparklines)
library(marginaleffects)
#devtools::install_github('tidyss/rroughviz')
#devtools::install_github("xvrdm/ggrough")
#devtools::install_github("vincentarelbundock/marginaleffects")
#library(ggrough)
#library(rroughviz)
# 

knitr::opts_chunk$set(comment = '', dpi = 400)

sysfonts::font_add_google("Oswald", family = "oswald")
showtext::showtext_auto()

basesize <- 30
# Regular plot theme
theme_flynn <- function(){ 
  
      theme_linedraw(base_size = basesize, base_family = "oswald") %+replace% 
        
        theme(plot.title = element_text(face = "bold", size = basesize * 1.3, hjust = 0, margin = margin(t = 0, b = 0.3, l = 0, r = 0, unit = "cm")),
              plot.subtitle = element_text(size = basesize),
              plot.caption = element_text(face = "italic", size = basesize * 0.6),
              strip.background = element_rect(fill = "gray80", color = "black"),
              strip.text = element_text(color = "black", face = "bold", margin = margin(t = 0.2, b = 0.2, l = 0.2, r = 0.2, unit = "cm")),
              panel.grid.major = element_line(color = "gray70", size = 0.15),
              panel.grid.minor = element_line(color = "gray90", size = 0.1),
              axis.title = element_text(face = "bold", size = basesize),
              axis.title.y = element_text(angle = 90, margin = margin(t = 0, r = 0.5, b = 0, l = 0, unit = "cm")),
              axis.title.x = element_text(margin = margin(t = 0.5, r = 0, b = 0, l = 0, unit = "cm")),
              axis.ticks = element_line(size = 0.1),
              axis.ticks.length = unit(0.1, "cm"),
              legend.title = element_text(face = "bold", hjust = 0, margin = margin(t = 0, b = 0, l = 0, r = 0, unit = "cm")),
              plot.margin = margin(0.5, 0.5, 0.5, 0.5, unit = "cm"),
              legend.margin=margin(t=-10, b=0, r=0, l=0),
              legend.box.margin=margin(-10,-10,-10,-10))
  }

# Map version of theme
theme_flynn_map <- function(){
  
  theme_void(base_family = "oswald") %+replace% 
    
    theme(plot.title = element_text(face = "bold", size = 18, hjust = 0, margin = margin(t = 0, b = 0.3, l = 0, r = 0, unit = "cm")),
          plot.subtitle = element_text(size = 12, hjust = 0, margin = margin(t = 0, b = 0.3, l = 0, r = 0, unit = "cm")),
          plot.caption = element_text(face = "italic", size = 8, hjust = 1, margin = margin(t = 0.2, unit = "cm")),
          strip.background = element_rect(fill = "gray80", color = "black"),
          strip.text = element_text(color = "black", face = "bold"),
          panel.grid.major = element_line(color = "white", size = 0),
          panel.grid.minor = element_line(color = "white", size = 0),
          #axis.title = element_text(face = "bold", size = 0),
          #axis.title.y = element_text(margin = margin(t = 0, r = 0.5, b = 0, l = 0, unit = "cm")),
          #axis.title.x = element_text(margin = margin(t = 0.5, r = 0, b = 0, l = 0, unit = "cm")),
          legend.title = element_text(face = "bold"),
          legend.position = "bottom",
          legend.key.height = unit(0.6, "cm"),
          legend.key.width = unit(2.5, "cm"))
}


ccode.list <- c("200", "210", "211", "230", "235", "255", "290", "325", "640", "690", "732", "740", "840", "900")


### Stan Setup ####

# Conflicted pckage really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)


# Load opinion data for individual-level protest models. Make data.table class.
load(here::here("Data/General", "opinion.data.RData")) 
o.data <- setDT(o.data)


set.seed(seed = 66502)

```




# Descriptive Figures

## Survey Figures

```{r troops-crime-pers}

troops.crime.pers <- o.data[
  !is.na(country) & !is.na(troops_crime_pers)
][
  , .N , by = .(country, troops_crime_pers)
]

# Note: there are about 200 NA values returned for the troops_crime_pers variable but these all appear to be
# bad or incomplete responses. There are almost no questions answered for these observations.
#test <- as.data.table(base.data)[
#  is.na(troops_crime_pers)
#]

ggplot(troops.crime.pers, aes(x = N, y = country, fill = troops_crime_pers)) +
  geom_bar(stat = "identity", position = "fill", color = "black", size = 0.1) +
  scale_x_continuous(labels = percent_format(), expand = c(0, 0)) + 
  scale_y_discrete(expand = c(0, 0)) + 
  viridis::scale_fill_viridis(discrete = TRUE, option = "magma", direction = -1) +
  theme_flynn() +
  theme(panel.border = element_blank(),
        axis.line =  element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "bottom",
        plot.title.position = "plot",
        legend.margin=margin(t=-20, b=0, r=0, l=0)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  labs(x = "",
       y = "",
       title = "Have you personally been the victim of a crime committed by a member of the US military?",
       fill = "Response")

ggsave(here::here("Figures/Chapter-Crime/troops-crime-pers-fig.tiff"), width = 6, height = 5.5, units = "in")
ggsave(here::here("Figures/Chapter-Crime/troops-crime-pers-fig.jpg"), width = 6, height = 5.5, units = "in")


```

```{r troops-crime-nonpers}

troops.crime.nonpers <- setDT(o.data)

troops.crime.nonpers <- troops.crime.nonpers[
  !is.na(country) & !is.na(troops_crime_nonpers)
][
  , .N , by = .(country, troops_crime_nonpers)
]

ggplot(troops.crime.nonpers, aes(x = N, y = country, fill = troops_crime_nonpers)) +
  geom_bar(stat = "identity", position = "fill", color = "black", size = 0.1) +
  scale_x_continuous(labels = percent_format(), expand = c(0, 0)) + 
  scale_y_discrete(expand = c(0, 0)) + 
  viridis::scale_fill_viridis(discrete = TRUE, option = "magma", direction = -1) +
  theme_flynn() +
  theme(panel.border = element_blank(),
        axis.line =  element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "bottom",
        plot.title.position = "plot",
        plot.title = element_markdown(size = basesize*1.2),
        legend.margin=margin(t=-20, b=0, r=0, l=0)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  labs(x = "",
       y = "",
       title = "Do you know someone who has been the victim of a crime committed by a member of the US military?",
       fill = "Response")

ggsave(here::here("Figures/Chapter-Crime/troops-crime-nonpers-fig.tiff"), width = 6, height = 5, units = "in")
ggsave(here::here("Figures/Chapter-Crime/troops-crime-nonpers-fig.jpg"), width = 6, height = 5, units = "in")

```


```{r troops-crime-pers-types}

troops.crime.pers.type <- o.data

troops.crime.pers.type <- troops.crime.pers.type[
  !is.na(country) & troops_crime_pers == "Yes"
][
 , c("country", "theft", "drugrelated", "assault", "sexualassault", "burglary", "robbery", "crimedk")
]

troops.crime.pers.type <- melt(troops.crime.pers.type, 
                               id.vars = c("country"),
                               measure.vars = c("theft", "drugrelated", "assault", "sexualassault", "burglary", "robbery", "crimedk"))

troops.crime.pers.type <- troops.crime.pers.type[
  , .N, by = c("country", "variable", "value")
][
  , variable := fcase(
    variable == "crimedk", "Don't know/decline to answer",
    variable == "theft", "Theft",
    variable == "drugrelated", "Drugs",
    variable == "assault", "Assault",
    variable == "sexualassault", "Sexual Assault",
    variable == "burglary", "Burglary",
    variable == "robbery", "Robbery"
  )
][
  , variable := factor(variable, levels = c("Don't know/decline to answer", "Theft", "Robbery", "Burglary", "Drugs", "Assault", "Sexual Assault"))
]


ggplot(troops.crime.pers.type %>% filter(value == "Yes"), aes(x = N, y = country, fill = variable)) +
  geom_bar(stat = "identity", color = "black", size = 0.1) +
  theme_flynn() +
  theme(axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_text(size = basesize * 1.1),
        plot.title.position = "plot",
        legend.position = "bottom",
        legend.text = element_text(size = basesize * 1.1, margin = margin(l = -0.3, unit = "cm")),
        legend.title = element_markdown(margin = margin(b = -0.0, unit = "cm")),
        panel.border = element_rect(size = 0.2)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_x_continuous(expand = c(0, 1), limits = c(0, 2500)) +
  viridis::scale_fill_viridis(option = "magma", discrete = TRUE, direction = 1) +
  labs(x = "Count of reported person-crime experiences",
       y = "",
       fill = "Crime Type",
       title = "Reported Experiences of Crime Committed by US Service Personnel")
  

ggsave(here::here("Figures/Chapter-Crime/troops-crime-experience-fig.tiff"), width = 6.5, height = 5, units = "in")
ggsave(here::here("Figures/Chapter-Crime/troops-crime-experience-fig.jpg"), width = 6.5, height = 5, units = "in")



```


```{r crime-N-check}

crime.n <- o.data[
  !is.na(country) & !is.na(troops_crime_pers)
][
 , c("country", "troops_crime_pers")
][
  , .N, by = c("country", "troops_crime_pers")
][
  , total := sum(N), by = c("country")
][
  , perc := N/total
]



ggplot(crime.n %>% filter(troops_crime_pers == "Yes"), aes(x = perc, y = country)) +
  geom_bar(stat = "identity", color = "black", size = 0.1) +
  theme_flynn() +
  theme(axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_text(size = basesize * 1.1),
        plot.title.position = "plot",
        panel.border = element_rect(size = 0.2)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_x_continuous(limits = c(0, 0.3), expand = c(0, 0), breaks = seq(0, 0.3, 0.1), labels = percent_format()) +
  viridis::scale_fill_viridis(option = "magma", discrete = TRUE, direction = 1) +
  labs(x = "Percent of of reported person-crime experiences",
       y = "",
       fill = "Crime Type",
       title = "Reported Experiences of Crime Committed by US Service Personnel")
  

ggsave(here::here("Figures/Chapter-Crime/troops-crime-reporters-fig.tiff"), width = 6, height = 4.5, units = "in")
ggsave(here::here("Figures/Chapter-Crime/troops-crime-reporters-fig.jpg"), width = 6, height = 4.5, units = "in")

```


```{r waffle plot crime}

waffle.data <- waffle_iron(o.data, aes_d(group = troops_crime_pers), rows = 20, na.rm = TRUE, sample_size = 0.01) %>% 
   mutate(label = fontawesome('fa-male'))

ggplot(waffle.data, aes(x, y, color = as.factor(group))) +
  geom_text(aes(label=label), family='fontawesome-webfont', size=9) +
  viridis::scale_color_viridis(discrete = TRUE, option = "magma") +
  coord_equal() +
  theme_void()

crime.n <- crime.n[order(country, troops_crime_pers, N)][
  , label := "https://cdn0.iconfinder.com/data/icons/healthcare-medical-2/512/boy-512.png"
]

p2 <- ggplot(crime.n, aes(fill = troops_crime_pers, values = N)) +
  waffle::geom_waffle(n_rows = 10, make_proportional = TRUE, size = 1, color = "white", radius = unit(2, "pt")) +
  facet_wrap(. ~ country, ncol = 7) +
  coord_equal() +
  theme_flynn() +
  theme(axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_blank(),
        legend.position = "bottom") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  viridis::scale_fill_viridis(discrete = TRUE, option = "magma", begin = 0.1, end = 0.9) +
  labs(fill = "Personal Experience with Crime") 

p2


```



```{r crime type personal and non}

crime.sex <- o.data[
  !is.na(troops_crime_pers)
][
  , .N , by = c("gender", "troops_crime_pers")
][
  troops_crime_pers == "Yes"
][
  , total := sum(N)
][
  , perc := N/total
]

p1 <- ggplot(crime.sex, aes(x = perc, y = gender)) +
  geom_bar(stat = "identity") +
  theme_flynn() +
  theme(axis.text.y = element_text(size = basesize * 1.1, face = "bold"),
        plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.border = element_blank(),
        axis.line.x.bottom = element_line(size = 0.2),
        axis.ticks.y.left = element_blank()
  ) +
  scale_x_continuous(labels = scales::percent_format(), expand = c(0, 0), limits = c(0, 1)) +
  labs(x = "Percent",
       y = "",
       title = "Gender Identity")

p1


crime.age <- o.data[
  !is.na(troops_crime_pers)
][
  , .N , by = c("age", "troops_crime_pers")
][
  troops_crime_pers == "Yes"
][
  , total := sum(N)
][
  , perc := N/total
]

p2 <- ggplot(crime.age, aes(x = perc, y = age)) +
  geom_bar(stat = "identity") +
  theme_flynn() +
  theme(axis.text.y = element_text(size = basesize * 1.1, face = "bold"),
        plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.border = element_blank(),
        axis.line.x.bottom = element_line(size = 0.2),
        axis.ticks.y.left = element_blank()
        ) +
  scale_x_continuous(labels = scales::percent_format(), expand = c(0, 0), limits = c(0, 1)) +
  labs(x = "Percent",
       y = "",
       title = "Age")

p2


crime.income <- o.data[
  !is.na(troops_crime_pers) & !is.na(income.5.cat)
][
  , .N , by = c("income.5.cat", "troops_crime_pers")
][
  troops_crime_pers == "Yes"
][
  , total := sum(N)
][
  , perc := N/total
]

p3 <- ggplot(crime.income, aes(x = perc, y = income.5.cat)) +
  geom_bar(stat = "identity") +
  theme_flynn() +
  theme(axis.text.y = element_text(size = basesize * 1.1, face = "bold"),
        plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.border = element_blank(),
        axis.line.x.bottom = element_line(size = 0.2),
        axis.ticks.y.left = element_blank()
  ) +
  scale_x_continuous(labels = scales::percent_format(), expand = c(0, 0), limits = c(0, 1)) +
  labs(x = "Percent",
       y = "",
       title = "Income Bracket")

p3

crime.minority <- o.data[
  !is.na(troops_crime_pers) & !is.na(minority)
][
  , .N , by = c("minority", "troops_crime_pers")
][
  troops_crime_pers == "Yes"
][
  , total := sum(N)
][
  , perc := N/total
][
  , minority := factor(minority, levels = c("Decline to answer", "No", "Yes"))
]

p4 <- ggplot(crime.minority, aes(x = perc, y = minority)) +
  geom_bar(stat = "identity") +
  theme_flynn() +
  theme(axis.text.y = element_text(size = basesize * 1.1, face = "bold"),
        plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.border = element_blank(),
        axis.line.x.bottom = element_line(size = 0.2),
        axis.ticks.y.left = element_blank()
  ) +
  scale_x_continuous(labels = scales::percent_format(), expand = c(0, 0), limits = c(0, 1)) +
  labs(x = "Percent",
       y = "",
       title = "Minority Self-Identification")

p4


p.com <- (p1 / p3) | (p2 / p4) 

p.com 

ggsave(here::here("Figures/Chapter-Crime/fig-crime-demographics.tiff"), width = 6, height = 6, units = "in")
ggsave(here::here("Figures/Chapter-Crime/fig-crime-demographics.jpg"), width = 6, height = 6, units = "in")

```


```{r }

crime.matrix <- o.data[
  , c("theft", "robbery", "burglary", "drugrelated", "assault", "sexualassault", "theft_nonpers", "robbery_nonpers", "burglary_nonpers", "drugrelated_nonpers", "assault_nonpers", "sexualassault_nonpers")
][
  , index := seq(1, length(theft))
]

# Arrange personal crime reports
crime.matrix.pers <- crime.matrix[
  , c("theft", "robbery", "burglary", "drugrelated", "assault", "sexualassault")
][
  , `:=` (theft = ifelse(theft == "Yes", 1, 0),
          robbery = ifelse(robbery == "Yes", 1, 0),
          burglary = ifelse(burglary == "Yes", 1, 0),
          drugrelated = ifelse(drugrelated == "Yes", 1, 0),
          assault = ifelse(assault == "Yes", 1, 0),
          sexualassault = ifelse(sexualassault == "Yes", 1, 0))
]

p.mat <- data.frame(cor(crime.matrix.pers, use = "na.or.complete")) 

rownames(p.mat) <- c("Theft", "Robbery", "Burglary", "Drug Related", "Assault", "Sexual Assault")
colnames(p.mat) <- c("Theft", "Robbery", "Burglary", "Drug Related", "Assault", "Sexual Assault")


crime.cor <- ggcorrplot(p.mat, 
                        method = "square",
                        show.diag = FALSE,
                        type = "upper",
                        lab = TRUE,
                        lab_size = 9,
                        lab_col = "white") +
  theme_flynn() +
  theme(legend.key.height = unit(0.9, "cm"),
        legend.position = "right",
        plot.title.position = "plot",
        panel.border = element_rect(size = 0.2)) +
  viridis::scale_fill_viridis(option = "magma", limits = c(0, 0.6), na.value = "black", direction = -1) +
  labs(title = "Correlation of Reported Crime Types",
       x = "",
       y = "",
       fill = "Correlation")

crime.cor


crime.tab <- crime.matrix.pers[
  , crimecount := apply(.SD, 1, sum), .SDcols = c("theft", "robbery", "burglary", "drugrelated", "assault", "sexualassault")
]


crimecount.hist <- ggplot(crime.tab %>% filter(crimecount>0), aes(x = crimecount)) +
  geom_histogram(fill = "gray50", color = "white", binwidth = 1) +
  theme_flynn() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line.x.bottom = element_line(size = 0.2),
        axis.line.y.left = element_line(size = 0.2),
        axis.ticks.length.x.bottom = unit(0.0, "cm"),
        axis.text.x.bottom = element_text(margin = margin(t = 0.25, 0, 0 , 0 , unit = "cm")),
        axis.title.x = element_text(margin = margin(t = 0.2, unit = "cm")),
        axis.title.y = element_text(margin = margin(r = -1.0, unit = "cm")),
        plot.title.position = "plot") +
  scale_x_continuous(breaks = seq(1, 6, 1), limits = c(0, 7),) +
  scale_y_continuous(expand = c(0.02, 0),breaks = seq(0, 700, 100), limits = c(0, 700)) +
  coord_capped_cart(bottom='none', left='both', ylim = c(0, 700), xlim = c(0.5, 6.5)) +
  labs(title = "Distribution of Crime Reports",
       x = "Number of Reported Crime Types",
       y = "Count")


crimecount.hist

crime.freq <- crimecount.hist / crime.cor

crime.freq +
  theme(plot.margin = margin(0, 0, 0, 0))

ggsave(here::here("Figures/Chapter-Crime/fig-crime-cor-frequency.tiff"), width = 6.2, height = 7, units = "in")
ggsave(here::here("Figures/Chapter-Crime/fig-crime-cor-frequency.jpg"), width = 6.2, height = 7, units = "in")


```

## Reported Crimes

```{r reported-crime-table}


crimereports <- setDT(fread(here::here("../Crime/Data/Handcoded Data/crime 1.0.csv")))[
  , datefull := paste(year, month, date, sep = "-")
][
  , `:=` (DUI = ifelse(!is.na(DUI), "DUI", NA),
          drug = ifelse(!is.na(drug), "Drugs", NA),
          assault = ifelse(!is.na(assault), "Assault", NA),
          homicide = ifelse(!is.na(homicide), "Homicide", NA),
          manslaughter = ifelse(!is.na(manslaughter), "Manslaughter", NA),
          arson = ifelse(!is.na(arson), "Arson", NA),
          kidnapping = ifelse(!is.na(kidnapping), "Kidnapping", NA),
          `sexual assault` = ifelse(!is.na(`sexual assault`), "Sexual Assault", NA),
          rape = ifelse(!is.na(rape), "Rape", NA),
          theft = ifelse(!is.na(theft), "Theft", NA),
          robbery = ifelse(!is.na(robbery), "Robbery", NA),
          burglary = ifelse(!is.na(burglary), "Burglary", NA),
          weaponspos = ifelse(!is.na(weaponspos), "Weapons Possession", NA))
][
  , offenses := paste(homicide, rape, manslaughter, `sexual assault`, arson, kidnapping, assault, drug, burglary, robbery, theft, weaponspos, DUI, sep = ", ")
][
  , offenses := gsub("NA, |, NA", "", offenses)
][
  , c("country", "datefull", "city", "offenses", "branch", "source")
][
  -c(1)
]

setnames(crimereports, 
         c("country", "datefull", "city", "offenses", "branch", "source"), 
         c("Country", "Date", "City", "Offenses", "Branch", "Source"))


crimereports.tab <- kable(crimereports, format = "latex", align = "lllllll", escape = TRUE,
                          booktabs = TRUE, longtable = TRUE, caption = "Crimes reported by major media outlets, 1990-2020 \\label{tab:crimenewsreports}") %>% 
  kable_styling(latex_options = c("repeat_header"),bootstrap_options = c("scale_down"), protect_latex = TRUE, font_size = 9) %>% 
  column_spec(7, width = "2cm") %>% 
  landscape() %>% 
  save_kable(here::here("Tables/Chapter-Crime/table-crime-reports.tex"),
             keep_tex = TRUE)


```


```{r reported-crime-map}

sf::sf_use_s2(FALSE) # Use this to resolve error in calculating centroids with sf package

crimereports <- setDT(fread(here::here("../Crime/Data/Handcoded Data/crime 1.0.csv")))[
 , .N , by = "country"
]


mapdata <- ne_countries(scale = "medium", returnclass = "sf") %>% 
  filter(name != "Antarctica")

centroids <- st_centroid(mapdata)
centroids <- cbind(mapdata, st_coordinates(st_centroid(mapdata$geometry)))

mapdata <- mapdata %>% 
  left_join(crimereports, by = c("admin" = "country"))



ggplot(mapdata) +
  geom_sf(data = mapdata, color = "gray90") +
  geom_sf(data = mapdata, aes(fill = N)) +
  theme_flynn_map() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_size_continuous(range = c(3, 10)) +
  coord_sf(crs = st_crs("ESRI:54030")) 


```




# Models

## Priors

### Opinion Model Priors

```{r priors}

Sys.setlocale('LC_ALL','C') # Have to add this for Mac for some reason?


# Get priors
PRIOR.LIST.T <- get_prior(troops_1_cat ~ contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + age + ed_z + ideology_z + income.5.cat + gender + minority + contact_pers + benefit_pers  + troops_crime_pers + troops_crime_nonpers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 |r| country),
                    data = o.data,
            family = categorical(link = "logit", refcat = "neutral")) 

# Default and regularizing priors
# Use the same basic data.frame for everything
PRIOR.LIST.REG <- PRIOR.LIST.T %>% 
  filter(coef == "") %>% 
  mutate(prior = case_when(
    class == "b" ~ "normal(0,2)",
    class == "sd" ~ "gamma(1, 1)",
    class == "Intercept" ~ "normal(0,3)",
    TRUE ~ prior
  )) 


# Informative beta Priors
PRIOR.LIST.T <- PRIOR.LIST.T %>% 
  filter(class == "b" & !is.na(coef) & coef != "") 

apsr.t <- readRDS(here::here("../Papers/Published/Primary Paper - Contact/Bayes Diagnostics/m1.cat.bayes.rds"))
apsr.g <- readRDS(here::here("../Papers/Published/Primary Paper - Contact/Bayes Diagnostics/m2.cat.bayes.rds"))
apsr.p <- readRDS(here::here("../Papers/Published/Primary Paper - Contact/Bayes Diagnostics/m3.cat.bayes.rds"))


# Troops Priors
PRIOR.T <- empty_prior()

coeflist <- as_tibble(apsr.t) %>% 
  dplyr::summarise_all(list(mean = mean, sd = sd)) %>% 
  pivot_longer(cols = 1:ncol(.), 
               names_to = c("coef", ".value"),
               names_pattern = "(.+)_(.+$)") %>% 
  mutate(prior = glue::glue("normal({round(mean, 2)},{round(sd, 2)})"),
         dpar = case_when(
           grepl("mupos", coef) ~ "mupos",
           grepl("muneg", coef) ~ "muneg",
           grepl("mudk", coef) ~ "mudk",
         ),
         coef = gsub("mupos_|muneg_|mudk_", "", coef),
         coef = gsub("knowDDe", "knowDde", coef)) %>% 
  filter(grepl("b_", coef)) %>% 
  mutate(coef = gsub("b_", "", coef),
         class = "b") %>% 
  dplyr::select(-c(mean, sd)) %>% 
  filter(grepl(".*contact.*|.*benefit.*|.*gender.*|.*inf.*|.*age.*|.*minority.*", coef)) %>% 
  filter(!grepl(".*minorityNo.*", coef))

PRIOR.T <- bind_rows(PRIOR.T, coeflist, PRIOR.LIST.REG) 
PRIOR.T[is.na(PRIOR.T)] <- ""


# Government Priors
PRIOR.G <- empty_prior() 


PRIOR.LIST.G <- get_prior(american_g_cat ~ contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + age + ed_z + ideology_z + income.5.cat + gender + minority + contact_pers + benefit_pers +  relig + troops_crime_pers +  american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 |r| country),
                    data = o.data,
            family = categorical(link = "logit", refcat = "neutral")) %>% 
  filter(class == "b" & !is.na(coef) & coef != "") 

coeflist <- as_tibble(apsr.g) %>% 
  dplyr::summarise_all(list(mean = mean, sd = sd)) %>% 
  pivot_longer(cols = 1:ncol(.), 
               names_to = c("coef", ".value"),
               names_pattern = "(.+)_(.+$)") %>% 
  mutate(prior = glue::glue("normal({round(mean, 2)},{round(sd, 2)})"),
         dpar = case_when(
           grepl("mupos", coef) ~ "mupos",
           grepl("muneg", coef) ~ "muneg",
           grepl("mudk", coef) ~ "mudk",
         ),
         coef = gsub("mupos_|muneg_|mudk_", "", coef),
         coef = gsub("knowDDe", "knowDde", coef)) %>% 
  filter(grepl("b_", coef)) %>% 
  mutate(coef = gsub("b_", "", coef),
         class = "b") %>% 
  dplyr::select(-c(mean, sd)) %>% 
  filter(grepl(".*contact.*|.*benefit.*|.*gender.*|.*inf.*|.*age.*|.*minority.*", coef)) %>% 
  filter(!grepl(".*minorityNo.*", coef))

PRIOR.G <- bind_rows(PRIOR.G, PRIOR.LIST.REG, coeflist) 
PRIOR.G[is.na(PRIOR.G)] <- ""




# People Priors
PRIOR.P <- empty_prior()

coeflist <- as_tibble(apsr.p) %>% 
  dplyr::summarise_all(list(mean = mean, sd = sd)) %>% 
  pivot_longer(cols = 1:ncol(.), 
               names_to = c("coef", ".value"),
               names_pattern = "(.+)_(.+$)") %>% 
  mutate(prior = glue::glue("normal({round(mean, 2)},{round(sd, 2)})"),
         dpar = case_when(
           grepl("mupos", coef) ~ "mupos",
           grepl("muneg", coef) ~ "muneg",
           grepl("mudk", coef) ~ "mudk",
         ),
         coef = gsub("mupos_|muneg_|mudk_", "", coef),
         coef = gsub("knowDDe", "knowDde", coef)) %>% 
  filter(grepl("b_", coef)) %>% 
  mutate(coef = gsub("b_", "", coef),
         class = "b") %>% 
  dplyr::select(-c(mean, sd)) %>% 
  filter(grepl(".*contact.*|.*benefit.*|.*gender.*|.*inf.*|.*age.*|.*minority.*", coef)) %>% 
  filter(!grepl(".*minorityNo.*", coef))

PRIOR.P <- bind_rows(PRIOR.P, PRIOR.LIST.REG, coeflist) 
PRIOR.P[is.na(PRIOR.P)] <- ""


```


## Multilevel Models

### Attitude Models

```{r attitudes-crime}
# Conflicted pckage really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)


ITER <- 3000
WARMUP <-  1500
CORES <- 4
CHAINS <- 4
SEED <- 123

tic()
#### Troops  ####
job::job("m.cr.t1" = {
m.cr.t1 <- brm(troops_1_cat ~ troops_crime_pers + troops_crime_nonpers + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 |r| country),
            data = o.data,
            family = categorical(link = "logit", refcat = "neutral"),
            prior = PRIOR.T,
            iter = ITER,
            warmup = WARMUP,
            cores = CORES,
            chains = CHAINS,
            thin = 1,
            #threads = threading(2),
            seed = SEED,
            control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
            backend = "cmdstanr",
            file = here::here("Output/Chapter-Crime/m.cr.t1"),
            file_refit = "on_change")

}
)


job::job(m.cr.g1 = {
#### Government ####
m.cr.g1 <- brm(american_g_cat ~ troops_crime_pers + troops_crime_nonpers + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 |r| country),
                    data = o.data,
                    family = categorical(link = "logit", refcat = "neutral"),
                    prior = PRIOR.G,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
            control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
            backend = "cmdstanr",
            file = here::here("Output/Chapter-Crime/m.cr.g1"),
            file_refit = "on_change")
}
)


job::job("m.cr.p1" = {
  
 #### People ####
m.cr.p1 <- brm(american_p_cat ~ troops_crime_pers + troops_crime_nonpers + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 |r| country),
                    data = o.data,
                    family = categorical(link = "logit", refcat = "neutral"),
                    prior = PRIOR.P,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
            control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
            backend = "cmdstanr",
            file = here::here("Output/Chapter-Crime/m.cr.p1"),
            file_refit = "on_change") 
}
)

```


### Disaggregated crime

```{r attitudes-crime-disaggregated}
# Conflicted pckage really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)


ITER <- 3000
WARMUP <-  1500
CORES <- 4
CHAINS <- 4
SEED <- 123

tic()
#### Troops  ####
job::job("m.cr.t2" = {
  m.cr.t2 <- brm(troops_1_cat ~ theft + robbery + burglary + drugrelated + assault + sexualassault + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                   (1 |r| country),
                 data = o.data,
                 family = categorical(link = "logit", refcat = "neutral"),
                 prior = PRIOR.T,
                 iter = ITER,
                 warmup = WARMUP,
                 cores = CORES,
                 chains = CHAINS,
                 thin = 1,
                 #threads = threading(2),
                 seed = SEED,
                 control = list(adapt_delta = 0.80,
                                max_treedepth = 10),
                 backend = "cmdstanr",
                 file = here::here("Output/Chapter-Crime/m.cr.t2"),
                 file_refit = "on_change")
  
}
)


job::job("m.cr.g2" = {
  #### Government ####
  m.cr.g2 <- brm(american_g_cat ~ theft + robbery + burglary + drugrelated + assault + sexualassault + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                   (1 |r| country),
                 data = o.data,
                 family = categorical(link = "logit", refcat = "neutral"),
                 prior = PRIOR.G,
                 iter = ITER,
                 warmup = WARMUP,
                 cores = CORES,
                 chains = CHAINS,
                 thin = 1,
                 seed = SEED,
                 control = list(adapt_delta = 0.80,
                                max_treedepth = 10),
                 backend = "cmdstanr",
                 file = here::here("Output/Chapter-Crime/m.cr.g2"),
                 file_refit = "on_change")
}
)


job::job("m.cr.p2" = {
  
  #### People ####
  m.cr.p2 <- brm(american_p_cat ~ theft + robbery + burglary + drugrelated + assault + sexualassault + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                   (1 |r| country),
                 data = o.data,
                 family = categorical(link = "logit", refcat = "neutral"),
                 prior = PRIOR.P,
                 iter = ITER,
                 warmup = WARMUP,
                 cores = CORES,
                 chains = CHAINS,
                 thin = 1,
                 seed = SEED,
                 control = list(adapt_delta = 0.80,
                                max_treedepth = 10),
                 backend = "cmdstanr",
                 file = here::here("Output/Chapter-Crime/m.cr.p2"),
                 file_refit = "on_change") 
}
)

```


### Varying Effects for Crime

```{r attitudes-crime}
# Conflicted pckage really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)


ITER <- 3000
WARMUP <-  1500
CORES <- 4
CHAINS <- 4
SEED <- 123

tic()
#### Troops  ####
job::job("m.cr.t3" = {
m.cr.t3 <- brm(troops_1_cat ~ troops_crime_pers + troops_crime_nonpers + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 + troops_crime_pers + troops_crime_nonpers |r| country),
            data = o.data,
            family = categorical(link = "logit", refcat = "neutral"),
            prior = PRIOR.T,
            iter = ITER,
            warmup = WARMUP,
            cores = CORES,
            chains = CHAINS,
            thin = 1,
            #threads = threading(2),
            seed = SEED,
            control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
            backend = "cmdstanr",
            file = here::here("Output/Chapter-Crime/m.cr.t3"),
            file_refit = "on_change")

}
)


job::job(m.cr.g3 = {
#### Government ####
m.cr.g3 <- brm(american_g_cat ~ troops_crime_pers + troops_crime_nonpers + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 + troops_crime_pers + troops_crime_nonpers |r| country),
                    data = o.data,
                    family = categorical(link = "logit", refcat = "neutral"),
                    prior = PRIOR.G,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
            control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
            backend = "cmdstanr",
            file = here::here("Output/Chapter-Crime/m.cr.g3"),
            file_refit = "on_change")
}
)


job::job("m.cr.p3" = {
  
 #### People ####
m.cr.p3 <- brm(american_p_cat ~ troops_crime_pers + troops_crime_nonpers + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                 (1 + troops_crime_pers + troops_crime_nonpers |r| country),
                    data = o.data,
                    family = categorical(link = "logit", refcat = "neutral"),
                    prior = PRIOR.P,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
            control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
            backend = "cmdstanr",
            file = here::here("Output/Chapter-Crime/m.cr.p3"),
            file_refit = "on_change") 
}
)

```


### Interactive Models


```{r attitudes-crime}
# Conflicted pckage really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)


ITER <- 3000
WARMUP <-  1500
CORES <- 4
CHAINS <- 4
SEED <- 123

tic()
#### Troops  ####
job::job("m.cr.t4" = {
  m.cr.t4 <- brm(troops_1_cat ~ troops_crime_pers + troops_crime_pers*contact_pers + troops_crime_nonpers + troops_crime_nonpers*contact_pers + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                   (1 |r| country),
                 data = o.data,
                 family = categorical(link = "logit", refcat = "neutral"),
                 prior = PRIOR.T,
                 iter = ITER,
                 warmup = WARMUP,
                 cores = CORES,
                 chains = CHAINS,
                 thin = 1,
                 #threads = threading(2),
                 seed = SEED,
                 control = list(adapt_delta = 0.80,
                                max_treedepth = 10),
                 backend = "cmdstanr",
                 file = here::here("Output/Chapter-Crime/m.cr.t4"),
                 file_refit = "on_change")
  
}
)


job::job(m.cr.g4 = {
  #### Government ####
  m.cr.g4 <- brm(american_g_cat ~ troops_crime_pers + troops_crime_pers*contact_pers + troops_crime_nonpers + troops_crime_nonpers*contact_pers + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z +  
                   (1 |r| country),
                 data = o.data,
                 family = categorical(link = "logit", refcat = "neutral"),
                 prior = PRIOR.G,
                 iter = ITER,
                 warmup = WARMUP,
                 cores = CORES,
                 chains = CHAINS,
                 thin = 1,
                 seed = SEED,
                 control = list(adapt_delta = 0.80,
                                max_treedepth = 10),
                 backend = "cmdstanr",
                 file = here::here("Output/Chapter-Crime/m.cr.g4"),
                 file_refit = "on_change")
}
)


job::job("m.cr.p4" = {
  
  #### People ####
  m.cr.p4 <- brm(american_p_cat ~ troops_crime_pers + troops_crime_pers*contact_pers + troops_crime_nonpers + troops_crime_nonpers*contact_pers + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + minority + age + ed_z + ideology_z + income.5.cat + gender + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z +  
                   (1 |r| country),
                 data = o.data,
                 family = categorical(link = "logit", refcat = "neutral"),
                 prior = PRIOR.P,
                 iter = ITER,
                 warmup = WARMUP,
                 cores = CORES,
                 chains = CHAINS,
                 thin = 1,
                 seed = SEED,
                 control = list(adapt_delta = 0.80,
                                max_treedepth = 10),
                 backend = "cmdstanr",
                 file = here::here("Output/Chapter-Crime/m.cr.p4"),
                 file_refit = "on_change") 
}
)

```
# Post-Estimation


## Tables

```{r table-crime-population-effect}

m.cr.t1 <- readRDS(here::here("Output/Chapter-Crime/m.cr.t1.rds"))
m.cr.p1 <- readRDS(here::here("Output/Chapter-Crime/m.cr.p1.rds"))
m.cr.g1 <- readRDS(here::here("Output/Chapter-Crime/m.cr.g1.rds"))


mod.list <- list(" " = m.cr.t1,
                 " " = m.cr.p1,
                 " " = m.cr.g1)

for (i in seq_along(mod.list)){
  class(mod.list[[i]]) <- c("custom", class(mod.list[[i]]))
}
#### 
#### Pay close attention to how brms and/or parameters is treating the % symbols in the income variable. 
#### Depending on the output the code below will need to be updated so the income variable isn't dropped.

# tidy method extracts level names into new column
tidy.custom <- function(x, conf.level=.95, ...) {
  out = parameters::parameters(x, ci=conf.level, verbose=FALSE) %>%
        parameters::standardize_names(style="broom") %>%
        mutate(y.level = case_when(grepl("mudk", term) ~ "Don't Know",
                                 grepl("muneg", term) ~ "Negative",
                                 grepl("mupos", term) ~ "Positive"),
               term = gsub("dk|neg|pos", "", term)) # remove outcome prefix brms attaches to variable names
  return(out)
}

glance.custom <- function(x, ...) {
  ret <- tibble::tibble(N = summary(x)$nobs)
  ret
}


rows <- lapply(mod.list, function(x){

  temp.sd <- parameters::parameters(x, effect = "random")  %>% 
    filter(grepl(".*sd.*", Parameter)) %>% 
    filter(grepl(".*persYes.*|.*nonpersYes.*|.*Intercept.*", Parameter)) %>% 
    dplyr::select(Parameter, Median) %>% 
    dplyr::mutate(Median = as.character(round(Median, 2)),
      y.level = case_when(
      grepl(".*mudk.*", Parameter) ~ "dk",
      grepl(".*mupos.*", Parameter) ~ "pos",
      grepl(".*muneg.*", Parameter) ~ "neg",
    ),
    Parameter = gsub("_mudk_|_mupos_|_muneg_", "_", Parameter)) %>% 
    pivot_wider(id_cols = Parameter,
                values_from = Median,
                names_from = y.level) %>% 
    mutate(Parameter = case_when(
      grepl(".*Intercept.*", Parameter) ~ "sd(Intercept)"
    ))
  
  temp.obs <- tibble::tribble(~Parameter, ~dk, ~neg, ~pos,
                              "N", as.character(nobs(x)), "", "",
                              "Group", "Country", "", "",
                              "\\# Groups", as.character(length(unique(x$data$country))), "", "")
  

  temp.com <- bind_rows(temp.obs, temp.sd)

  return(temp.com)
  
  }
)

rows.com <- bind_cols(rows[[1]], rows[[2]], rows[[3]]) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 10, 11, 12) 

names(rows.com) <- c("term", "col1", "col2", "col3", "col4", "col5", "col6", "col7", "col8", "col9")

# Turn off GOF stuff
gof.check <- modelsummary::gof_map
gof.check$omit <- TRUE

coef.list <- tibble::tribble(~raw, ~clean,
                             "b_mu_troops_crime_persYes", "Personal Crime: Yes",
                             "b_mu_troops_crime_nonpersYes", "Network Crime: Yes",
                            "b_mu_contact_persYes", "Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer", "Personal Contact: DK/Decline",
                            "b_mu_contact_nonpersYes", "Network Contact: Yes",
                            "b_mu_contact_nonpersDontknowDdeclinetoanswer", "Network Contact: DK/Decline",
                            "b_mu_benefit_persYes", "Personal Benefit: Yes",
                            "b_mu_benefit_persDontknowDdeclinetoanswer", "Personal Benefit: DK/Decline",
                            "b_mu_benefit_nonpersYes", "Network Benefit: Yes",
                            "b_mu_benefit_nonpersDontknowDdeclinetoanswer", "Network Benefit: DK/Decline",
                            "b_mu_minorityYes", "Minority: Yes",
                            "b_mu_minorityDeclinetoanswer", "Minoriy: Decline to answer",
                            "b_mu_age25to34years", "25-34",
                            "b_mu_age35to44years", "35-44",
                            "b_mu_age45to54years", "45-54",
                            "b_mu_age55to64years", "55-65",
                            "b_mu_ageAge65orolder", ">65",
                            "b_mu_income.5.cat21M40%", "21-40",
                            "b_mu_income.5.cat41M60%", "41-60",
                            "b_mu_income.5.cat61M80%", "61-80",
                            "b_mu_income.5.cat81M100%", "81-100",
                            "b_mu_genderFemale", "Female",
                            "b_mu_genderNonMbinary", "Non-binary",
                            "b_mu_genderNoneoftheabove", "None of the above",
                            "b_mu_ed_z", "Education",
                            "b_mu_ideology_z", "Ideology",
                            "b_mu_american_inf_1DontknowDdeclinetoanswer", "Influence 1: DK/Decline",
                            "b_mu_american_inf_1Alittle", "Influence 1: A little",
                            "b_mu_american_inf_1Some", "Influence 1: Some",
                            "b_mu_american_inf_1Alot", "Influence 1: A lot",
                            "b_mu_american_inf_2DontknowDdeclinetoanswer", "Influence 2: DK/Decline",
                            "b_mu_american_inf_2Veryative", "Influence 2: Very negative",
                            "b_mu_american_inf_2Negative", "Influence 2: Negative",
                            "b_mu_american_inf_2Positive", "Influence 2: Positive",
                            "b_mu_american_inf_2Veryitive", "Influence 2: Very positive",
                            "b_mu_basecount_z", "Base count",
                            "b_mu_gdp_z", "GDP",
                            "b_mu_pop_z", "Population",
                            "b_mu_troops_z", "Troop deployment size",
                            "b_mu_Intercept", "Intercept")


coef.list <- coef.list %>% 
  mutate(group = case_when(
           grepl(".*ontact.*", raw) ~ "Contact Status",
           grepl(".*enefit.*", raw) ~ "Economic Benefits",
           grepl(".*age.*", raw) ~ "Age",
           grepl(".*ncome.*", raw) ~ "Income Quintile",
           grepl(".*gender.*", raw) ~ "Gender Identification",
           grepl(".*minority.*", raw) ~ "Minority Self-Identification",
           grepl(".*relig.*", raw) ~ "Religious Identification",
           grepl(".*ed_z.*", raw) ~ "Education",
           grepl(".*ideology_z.*", raw) ~ "Ideology",
           grepl(".*crime.*", raw) ~ "Crime Experience",
           grepl(".*inf_1.*", raw) ~ "American Influence (Amount)",
           grepl(".*inf_2.*", raw) ~ "American Influence (Quality)",
           TRUE ~ "Group-Level Variables"
         )) 


# Find how long the coefficient list is for the final table hline
last.line <- length(coef.list[[1]]) * 2

coef_map <- setNames(coef.list$clean, coef.list$raw)
idx <- rle(coef.list$group)
idx <- setNames(idx$lengths  * 2, idx$values)


panel.1 <- modelsummary::modelsummary(mod.list,
                  estimate = "{estimate}",
                  statistic = "conf.int",
                  fmt = 2,
                  group = term ~ model + y.level,
                  gof_map = gof.check,
                  coef_map = coef_map,
                  add_rows = rows.com,
                  stars = FALSE,
                  longtable = TRUE,
                  output = "latex",
                  caption = "Bayesian multilevel multinomial logistic regressions predicting attitudes towards US actors. Population level effects. \\label{tab:crimetab1}") %>% 
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 4, position = "float_left") %>%
  add_header_above(c(" ", "US Presence" = 3, "US People" = 3, "US Government" = 3)) %>% 
  group_rows(index = idx, bold = TRUE, background = "gray", color = "white", hline_after = TRUE) %>% 
  row_spec(last.line, hline_after = TRUE) %>% 
  landscape() %>% 
  kableExtra::save_kable(here("Tables/Chapter-Crime/model-crime-1.tex"),
             keep_tex = TRUE)

```


```{r table-crime-disaggregated}

m.cr.t2 <- readRDS(here::here("Output/Chapter-Crime/m.cr.t2.rds"))
m.cr.p2 <- readRDS(here::here("Output/Chapter-Crime/m.cr.p2.rds"))
m.cr.g2 <- readRDS(here::here("Output/Chapter-Crime/m.cr.g2.rds"))


mod.list <- list(" " = m.cr.t2,
                 " " = m.cr.p2,
                 " " = m.cr.g2)

for (i in seq_along(mod.list)){
  class(mod.list[[i]]) <- c("custom", class(mod.list[[i]]))
}

#### Tables ####
#### 
#### Pay close attention to how brms and/or parameters is treating the % symbols in the income variable. 
#### Depending on the output the code below will need to be updated so the income variable isn't dropped.

# tidy method extracts level names into new column
tidy.custom <- function(x, conf.level=.95, ...) {
  out = parameters::parameters(x, ci=conf.level, verbose=FALSE) %>%
        parameters::standardize_names(style="broom") %>%
        mutate(y.level = case_when(grepl("mudk", term) ~ "Don't Know",
                                 grepl("muneg", term) ~ "Negative",
                                 grepl("mupos", term) ~ "Positive"),
               term = gsub("dk|neg|pos", "", term)) # remove outcome prefix brms attaches to variable names
  return(out)
}

glance.custom <- function(x, ...) {
  ret <- tibble::tibble(N = summary(x)$nobs)
  ret
}


rows <- lapply(mod.list, function(x){

  temp.sd <- parameters::parameters(x, effect = "random")  %>% 
    filter(grepl(".*sd.*", Parameter)) %>% 
    filter(grepl(".*persYes.*|.*nonpersYes.*|.*Intercept.*", Parameter)) %>% 
    dplyr::select(Parameter, Median) %>% 
    dplyr::mutate(Median = as.character(round(Median, 2)),
      y.level = case_when(
      grepl(".*mudk.*", Parameter) ~ "dk",
      grepl(".*mupos.*", Parameter) ~ "pos",
      grepl(".*muneg.*", Parameter) ~ "neg",
    ),
    Parameter = gsub("_mudk_|_mupos_|_muneg_", "_", Parameter)) %>% 
    pivot_wider(id_cols = Parameter,
                values_from = Median,
                names_from = y.level) %>% 
    mutate(Parameter = case_when(
      grepl(".*Intercept.*", Parameter) ~ "sd(Intercept)"
    ))
  
  temp.obs <- tibble::tribble(~Parameter, ~dk, ~neg, ~pos,
                              "N", as.character(nobs(x)), "", "",
                              "Group", "Country", "", "",
                              "\\# Groups", as.character(length(unique(x$data$country))), "", "")
  

  temp.com <- bind_rows(temp.obs, temp.sd)

  return(temp.com)
  
  }
)

rows.com <- bind_cols(rows[[1]], rows[[2]], rows[[3]]) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 10, 11, 12) 

names(rows.com) <- c("term", "col1", "col2", "col3", "col4", "col5", "col6", "col7", "col8", "col9")

# Turn off GOF stuff
gof.check <- modelsummary::gof_map
gof.check$omit <- TRUE

coef.list <- tibble::tribble(~raw, ~clean,
                             "b_mu_theftYes", "Theft",
                             "b_mu_robberyYes", "Robbery",
                             "b_mu_burglaryYes", "Burglary",
                             "b_mu_drugrelatedYes", "Drug Related",
                             "b_mu_assaultYes", "Assault",
                             "b_mu_sexualassaultYes", "Sexual Assault",
                            "b_mu_contact_persYes", "Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer", "Personal Contact: DK/Decline",
                            "b_mu_contact_nonpersYes", "Network Contact: Yes",
                            "b_mu_contact_nonpersDontknowDdeclinetoanswer", "Network Contact: DK/Decline",
                            "b_mu_benefit_persYes", "Personal Benefit: Yes",
                            "b_mu_benefit_persDontknowDdeclinetoanswer", "Personal Benefit: DK/Decline",
                            "b_mu_benefit_nonpersYes", "Network Benefit: Yes",
                            "b_mu_benefit_nonpersDontknowDdeclinetoanswer", "Network Benefit: DK/Decline",
                            "b_mu_minorityYes", "Minority: Yes",
                            "b_mu_minorityDeclinetoanswer", "Minoriy: Decline to answer",
                            "b_mu_age25to34years", "25-34",
                            "b_mu_age35to44years", "35-44",
                            "b_mu_age45to54years", "45-54",
                            "b_mu_age55to64years", "55-65",
                            "b_mu_ageAge65orolder", ">65",
                            "b_mu_income.5.cat21M40%", "21-40",
                            "b_mu_income.5.cat41M60%", "41-60",
                            "b_mu_income.5.cat61M80%", "61-80",
                            "b_mu_income.5.cat81M100%", "81-100",
                            "b_mu_genderFemale", "Female",
                            "b_mu_genderNonMbinary", "Non-binary",
                            "b_mu_genderNoneoftheabove", "None of the above",
                            "b_mu_ed_z", "Education",
                            "b_mu_ideology_z", "Ideology",
                            "b_mu_american_inf_1DontknowDdeclinetoanswer", "Influence 1: DK/Decline",
                            "b_mu_american_inf_1Alittle", "Influence 1: A little",
                            "b_mu_american_inf_1Some", "Influence 1: Some",
                            "b_mu_american_inf_1Alot", "Influence 1: A lot",
                            "b_mu_american_inf_2DontknowDdeclinetoanswer", "Influence 2: DK/Decline",
                            "b_mu_american_inf_2Veryative", "Influence 2: Very negative",
                            "b_mu_american_inf_2Negative", "Influence 2: Negative",
                            "b_mu_american_inf_2Positive", "Influence 2: Positive",
                            "b_mu_american_inf_2Veryitive", "Influence 2: Very positive",
                            "b_mu_basecount_z", "Base count",
                            "b_mu_gdp_z", "GDP",
                            "b_mu_pop_z", "Population",
                            "b_mu_troops_z", "Troop deployment size",
                            "b_mu_Intercept", "Intercept")


coef.list <- coef.list %>% 
  mutate(group = case_when(
           grepl(".*ontact.*", raw) ~ "Contact Status",
           grepl(".*enefit.*", raw) ~ "Economic Benefits",
           grepl(".*age.*", raw) ~ "Age",
           grepl(".*ncome.*", raw) ~ "Income Quintile",
           grepl(".*gender.*", raw) ~ "Gender Identification",
           grepl(".*minority.*", raw) ~ "Minority Self-Identification",
           grepl(".*relig.*", raw) ~ "Religious Identification",
           grepl(".*ed_z.*", raw) ~ "Education",
           grepl(".*ideology_z.*", raw) ~ "Ideology",
           grepl(".*crime.*|.*theft.*|.*robb.*|.*assault.*|.*drug.*|.*burgl.*", raw) ~ "Crime Experience Type",
           grepl(".*inf_1.*", raw) ~ "American Influence (Amount)",
           grepl(".*inf_2.*", raw) ~ "American Influence (Quality)",
           TRUE ~ "Group-Level Variables"
         )) 


# Find how long the coefficient list is for the final table hline
last.line <- length(coef.list[[1]]) * 2

coef_map <- setNames(coef.list$clean, coef.list$raw)
idx <- rle(coef.list$group)
idx <- setNames(idx$lengths  * 2, idx$values)


panel.1 <- modelsummary::modelsummary(mod.list,
                  estimate = "{estimate}",
                  statistic = "conf.int",
                  fmt = 2,
                  group = term ~ model + y.level,
                  gof_map = gof.check,
                  coef_map = coef_map,
                  add_rows = rows.com,
                  stars = FALSE,
                  longtable = TRUE,
                  output = "latex",
                  caption = "Bayesian multilevel multinomial logistic regressions predicting attitudes towards US actors. Disaggregated crime types. \\label{tab:crimetabdisagg}") %>% 
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 4, position = "float_left") %>%
  add_header_above(c(" ", "US Presence" = 3, "US People" = 3, "US Government" = 3)) %>% 
  group_rows(index = idx, bold = TRUE, background = "gray", color = "white", hline_after = TRUE) %>% 
  row_spec(last.line, hline_after = TRUE) %>% 
  landscape() %>% 
  kableExtra::save_kable(here("Tables/Chapter-Crime/model-crime-disaggregated.tex"),
             keep_tex = TRUE)

```



```{r table-crime-varying-effect}

m.cr.t3 <- readRDS(here::here("Output/Chapter-Crime/m.cr.t3.rds"))
m.cr.p3 <- readRDS(here::here("Output/Chapter-Crime/m.cr.p3.rds"))
m.cr.g3 <- readRDS(here::here("Output/Chapter-Crime/m.cr.g3.rds"))


mod.list <- list(" " = m.cr.t3,
                 " " = m.cr.p3,
                 " " = m.cr.g3)

for (i in seq_along(mod.list)){
  class(mod.list[[i]]) <- c("custom", class(mod.list[[i]]))
}

### Pay close attention to how brms and/or parameters is treating the % symbols in the income variable. 
### Depending on the output the code below will need to be updated so the income variable isn't dropped.

# tidy method extracts level names into new column
tidy.custom <- function(x, conf.level=.95, ...) {
  out = parameters::parameters(x, ci=conf.level, verbose=FALSE) %>%
        parameters::standardize_names(style="broom") %>%
        mutate(y.level = case_when(grepl("mudk", term) ~ "Don't Know",
                                 grepl("muneg", term) ~ "Negative",
                                 grepl("mupos", term) ~ "Positive"),
               term = gsub("dk|neg|pos", "", term)) # remove outcome prefix brms attaches to variable names
  return(out)
}

glance.custom <- function(x, ...) {
  ret <- tibble::tibble(N = summary(x)$nobs)
  ret
}


rows <- lapply(mod.list, function(x){

  temp.sd <- parameters::parameters(x, effect = "random")  %>% 
    filter(grepl(".*sd.*", Parameter)) %>% 
    filter(grepl(".*crime_persYes.*|.*crime_nonpersYes.*|.*Intercept.*", Parameter)) %>% 
    dplyr::select(Parameter, Median) %>% 
    dplyr::mutate(Median = as.character(round(Median, 2)),
      y.level = case_when(
      grepl(".*mudk.*", Parameter) ~ "dk",
      grepl(".*mupos.*", Parameter) ~ "pos",
      grepl(".*muneg.*", Parameter) ~ "neg",
    ),
    Parameter = gsub("_mudk_|_mupos_|_muneg_", "_", Parameter)) %>% 
    pivot_wider(id_cols = Parameter,
                values_from = Median,
                names_from = y.level) %>% 
    mutate(Parameter = case_when(
      grepl(".*Intercept.*", Parameter) ~ "sd(Intercept)",
      grepl(".*crime_persYes.*", Parameter) ~ "sd(Personal Crime)",
      grepl(".*crime_nonpersYes.*", Parameter) ~ "sd(Network Crime)"
    ))
  
  temp.obs <- tibble::tribble(~Parameter, ~dk, ~neg, ~pos,
                              "N", as.character(nobs(x)), "", "",
                              "Group", "Country", "", "",
                              "\\# Groups", as.character(length(unique(x$data$country))), "", "")
  

  temp.com <- bind_rows(temp.obs, temp.sd)

  return(temp.com)
  
  }
)

rows.com <- bind_cols(rows[[1]], rows[[2]], rows[[3]]) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 10, 11, 12) 

names(rows.com) <- c("term", "col1", "col2", "col3", "col4", "col5", "col6", "col7", "col8", "col9")

# Turn off GOF stuff
gof.check <- modelsummary::gof_map
gof.check$omit <- TRUE

coef.list <- tibble::tribble(~raw, ~clean,
                             "b_mu_troops_crime_persYes", "Personal Crime: Yes",
                             "b_mu_troops_crime_nonpersYes", "Network Crime: Yes",
                            "b_mu_contact_persYes", "Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer", "Personal Contact: DK/Decline",
                            "b_mu_contact_nonpersYes", "Network Contact: Yes",
                            "b_mu_contact_nonpersDontknowDdeclinetoanswer", "Network Contact: DK/Decline",
                            "b_mu_benefit_persYes", "Personal Benefit: Yes",
                            "b_mu_benefit_persDontknowDdeclinetoanswer", "Personal Benefit: DK/Decline",
                            "b_mu_benefit_nonpersYes", "Network Benefit: Yes",
                            "b_mu_benefit_nonpersDontknowDdeclinetoanswer", "Network Benefit: DK/Decline",
                            "b_mu_minorityYes", "Minority: Yes",
                            "b_mu_minorityDeclinetoanswer", "Minoriy: Decline to answer",
                            "b_mu_age25to34years", "25-34",
                            "b_mu_age35to44years", "35-44",
                            "b_mu_age45to54years", "45-54",
                            "b_mu_age55to64years", "55-65",
                            "b_mu_ageAge65orolder", ">65",
                            "b_mu_income.5.cat21M40%", "21-40",
                            "b_mu_income.5.cat41M60%", "41-60",
                            "b_mu_income.5.cat61M80%", "61-80",
                            "b_mu_income.5.cat81M100%", "81-100",
                            "b_mu_genderFemale", "Female",
                            "b_mu_genderNonMbinary", "Non-binary",
                            "b_mu_genderNoneoftheabove", "None of the above",
                            "b_mu_ed_z", "Education",
                            "b_mu_ideology_z", "Ideology",
                            "b_mu_american_inf_1DontknowDdeclinetoanswer", "Influence 1: DK/Decline",
                            "b_mu_american_inf_1Alittle", "Influence 1: A little",
                            "b_mu_american_inf_1Some", "Influence 1: Some",
                            "b_mu_american_inf_1Alot", "Influence 1: A lot",
                            "b_mu_american_inf_2DontknowDdeclinetoanswer", "Influence 2: DK/Decline",
                            "b_mu_american_inf_2Veryative", "Influence 2: Very negative",
                            "b_mu_american_inf_2Negative", "Influence 2: Negative",
                            "b_mu_american_inf_2Positive", "Influence 2: Positive",
                            "b_mu_american_inf_2Veryitive", "Influence 2: Very positive",
                            "b_mu_basecount_z", "Base count",
                            "b_mu_gdp_z", "GDP",
                            "b_mu_pop_z", "Population",
                            "b_mu_troops_z", "Troop deployment size",
                            "b_mu_Intercept", "Intercept")


coef.list <- coef.list %>% 
  mutate(group = case_when(
           grepl(".*ontact.*", raw) ~ "Contact Status",
           grepl(".*enefit.*", raw) ~ "Economic Benefits",
           grepl(".*age.*", raw) ~ "Age",
           grepl(".*ncome.*", raw) ~ "Income Quintile",
           grepl(".*gender.*", raw) ~ "Gender Identification",
           grepl(".*minority.*", raw) ~ "Minority Self-Identification",
           grepl(".*relig.*", raw) ~ "Religious Identification",
           grepl(".*ed_z.*", raw) ~ "Education",
           grepl(".*ideology_z.*", raw) ~ "Ideology",
           grepl(".*crime.*", raw) ~ "Crime Experience",
           grepl(".*inf_1.*", raw) ~ "American Influence (Amount)",
           grepl(".*inf_2.*", raw) ~ "American Influence (Quality)",
           TRUE ~ "Group-Level Variables"
         )) 


# Find how long the coefficient list is for the final table hline
last.line <- length(coef.list[[1]]) * 2

coef_map <- setNames(coef.list$clean, coef.list$raw)
idx <- rle(coef.list$group)
idx <- setNames(idx$lengths  * 2, idx$values)


panel.1 <- modelsummary::modelsummary(mod.list,
                  estimate = "{estimate}",
                  statistic = "conf.int",
                  fmt = 2,
                  group = term ~ model + y.level,
                  gof_map = gof.check,
                  coef_map = coef_map,
                  add_rows = rows.com,
                  stars = FALSE,
                  longtable = TRUE,
                  output = "latex",
                  caption = "Bayesian multilevel multinomial logistic regressions predicting attitudes towards US actors. Varying effects for crime. \\label{tab:crimevaryingeffect}") %>% 
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 4, position = "float_left") %>%
  add_header_above(c(" ", "US Presence" = 3, "US People" = 3, "US Government" = 3)) %>% 
  group_rows(index = idx, bold = TRUE, background = "gray", color = "white", hline_after = TRUE) %>% 
  row_spec(last.line, hline_after = TRUE) %>% 
  landscape() %>% 
  kableExtra::save_kable(here("Tables/Chapter-Crime/model-crime-varying.tex"),
             keep_tex = TRUE)

```


```{r table-crime-population-effect}

m.cr.t4 <- readRDS(here::here("Output/Chapter-Crime/m.cr.t4.rds"))
m.cr.p4 <- readRDS(here::here("Output/Chapter-Crime/m.cr.p4.rds"))
m.cr.g4 <- readRDS(here::here("Output/Chapter-Crime/m.cr.g4.rds"))


mod.list <- list(" " = m.cr.t4,
                 " " = m.cr.p4,
                 " " = m.cr.g4)

for (i in seq_along(mod.list)){
  class(mod.list[[i]]) <- c("custom", class(mod.list[[i]]))
}
#### 
#### Pay close attention to how brms and/or parameters is treating the % symbols in the income variable. 
#### Depending on the output the code below will need to be updated so the income variable isn't dropped.

# tidy method extracts level names into new column
tidy.custom <- function(x, conf.level=.95, ...) {
  out = parameters::parameters(x, ci=conf.level, verbose=FALSE) %>%
        parameters::standardize_names(style="broom") %>%
        mutate(y.level = case_when(grepl("mudk", term) ~ "Don't Know",
                                 grepl("muneg", term) ~ "Negative",
                                 grepl("mupos", term) ~ "Positive"),
               term = gsub("dk|neg|pos", "", term)) # remove outcome prefix brms attaches to variable names
  return(out)
}

glance.custom <- function(x, ...) {
  ret <- tibble::tibble(N = summary(x)$nobs)
  ret
}


rows <- lapply(mod.list, function(x){

  temp.sd <- parameters::parameters(x, effect = "random")  %>% 
    filter(grepl(".*sd.*", Parameter)) %>% 
    filter(grepl(".*persYes.*|.*nonpersYes.*|.*Intercept.*", Parameter)) %>% 
    dplyr::select(Parameter, Median) %>% 
    dplyr::mutate(Median = as.character(round(Median, 2)),
      y.level = case_when(
      grepl(".*mudk.*", Parameter) ~ "dk",
      grepl(".*mupos.*", Parameter) ~ "pos",
      grepl(".*muneg.*", Parameter) ~ "neg",
    ),
    Parameter = gsub("_mudk_|_mupos_|_muneg_", "_", Parameter)) %>% 
    pivot_wider(id_cols = Parameter,
                values_from = Median,
                names_from = y.level) %>% 
    mutate(Parameter = case_when(
      grepl(".*Intercept.*", Parameter) ~ "sd(Intercept)"
    ))
  
  temp.obs <- tibble::tribble(~Parameter, ~dk, ~neg, ~pos,
                              "N", as.character(nobs(x)), "", "",
                              "Group", "Country", "", "",
                              "\\# Groups", as.character(length(unique(x$data$country))), "", "")
  

  temp.com <- bind_rows(temp.obs, temp.sd)

  return(temp.com)
  
  }
)

rows.com <- bind_cols(rows[[1]], rows[[2]], rows[[3]]) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 10, 11, 12) 

names(rows.com) <- c("term", "col1", "col2", "col3", "col4", "col5", "col6", "col7", "col8", "col9")

# Turn off GOF stuff
gof.check <- modelsummary::gof_map
gof.check$omit <- TRUE

coef.list <- tibble::tribble(~raw, ~clean,
                            "b_mu_troops_crime_persYes", "Personal Crime: Yes",
                            "b_mu_troops_crime_nonpersYes", "Network Crime: Yes",
                            "b_mu_contact_persYes", "Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer", "Personal Contact: DK/Decline",
                            "b_mu_contact_nonpersYes", "Network Contact: Yes",
                            "b_mu_contact_nonpersDontknowDdeclinetoanswer", "Network Contact: DK/Decline",
                            "b_mu_troops_crime_persYes:contact_persDontknowDdeclinetoanswer", "Personal Crime: Yes $\\times$ Personal Contact: Don't Know",
                            "b_mu_troops_crime_persDontknowDdeclinetoanswer:contact_persDontknowDdeclinetoanswer", "Personal Crime: Don't Know $\\times$ Personal Contact: Don't Know",
                            "b_mu_troops_crime_persYes:contact_persYes", "Personal Crime: Yes $\\times$ Personal Contact: Yes",
                            "b_mu_troops_crime_persDontknowDdeclinetoanswer:contact_persYes", "Personal Crime: Don't Know $\\times$ Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer:troops_crime_nonpersYes", "Network Crime: Yes $\\times$ Personal Contact: Don't Know",
                            "b_mu_contact_persYes:troops_crime_nonpersYes", "Network Crime: Yes $\\times$ Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer:troops_crime_nonpersDontknowDdeclinetoanswer", "Network Crime: Don't Know $\\times$ Personal Contact: Don't Know",
                            "b_mu_contact_persYes:troops_crime_nonpersDontknowDdeclinetoanswer", "Network Crime: Don't Know $\\times$ Personal Contact: Yes",
                            "b_mu_benefit_persYes", "Personal Benefit: Yes",
                            "b_mu_benefit_persDontknowDdeclinetoanswer", "Personal Benefit: DK/Decline",
                            "b_mu_benefit_nonpersYes", "Network Benefit: Yes",
                            "b_mu_benefit_nonpersDontknowDdeclinetoanswer", "Network Benefit: DK/Decline",
                            "b_mu_minorityYes", "Minority: Yes",
                            "b_mu_minorityDeclinetoanswer", "Minoriy: Decline to answer",
                            "b_mu_age25to34years", "25-34",
                            "b_mu_age35to44years", "35-44",
                            "b_mu_age45to54years", "45-54",
                            "b_mu_age55to64years", "55-65",
                            "b_mu_ageAge65orolder", ">65",
                            "b_mu_income.5.cat21M40%", "21-40",
                            "b_mu_income.5.cat41M60%", "41-60",
                            "b_mu_income.5.cat61M80%", "61-80",
                            "b_mu_income.5.cat81M100%", "81-100",
                            "b_mu_genderFemale", "Female",
                            "b_mu_genderNonMbinary", "Non-binary",
                            "b_mu_genderNoneoftheabove", "None of the above",
                            "b_mu_ed_z", "Education",
                            "b_mu_ideology_z", "Ideology",
                            "b_mu_american_inf_1DontknowDdeclinetoanswer", "Influence 1: DK/Decline",
                            "b_mu_american_inf_1Alittle", "Influence 1: A little",
                            "b_mu_american_inf_1Some", "Influence 1: Some",
                            "b_mu_american_inf_1Alot", "Influence 1: A lot",
                            "b_mu_american_inf_2DontknowDdeclinetoanswer", "Influence 2: DK/Decline",
                            "b_mu_american_inf_2Veryative", "Influence 2: Very negative",
                            "b_mu_american_inf_2Negative", "Influence 2: Negative",
                            "b_mu_american_inf_2Positive", "Influence 2: Positive",
                            "b_mu_american_inf_2Veryitive", "Influence 2: Very positive",
                            "b_mu_basecount_z", "Base count",
                            "b_mu_gdp_z", "GDP",
                            "b_mu_pop_z", "Population",
                            "b_mu_troops_z", "Troop deployment size",
                            "b_mu_Intercept", "Intercept")


coef.list <- coef.list %>% 
  mutate(group = case_when(
           grepl(".*ontact.*", raw) ~ "Contact Status",
           grepl(".*enefit.*", raw) ~ "Economic Benefits",
           grepl(".*age.*", raw) ~ "Age",
           grepl(".*ncome.*", raw) ~ "Income Quintile",
           grepl(".*gender.*", raw) ~ "Gender Identification",
           grepl(".*minority.*", raw) ~ "Minority Self-Identification",
           grepl(".*relig.*", raw) ~ "Religious Identification",
           grepl(".*ed_z.*", raw) ~ "Education",
           grepl(".*ideology_z.*", raw) ~ "Ideology",
           grepl(".*crime.*", raw) ~ "Crime Experience",
           grepl(".*inf_1.*", raw) ~ "American Influence (Amount)",
           grepl(".*inf_2.*", raw) ~ "American Influence (Quality)",
           TRUE ~ "Group-Level Variables"
         ),
         group = case_when(
           grepl(".*:.*", raw) ~ "Interaction Terms",
           TRUE ~ group
         )) 


# Find how long the coefficient list is for the final table hline
last.line <- length(coef.list[[1]]) * 2

coef_map <- setNames(coef.list$clean, coef.list$raw)
idx <- rle(coef.list$group)
idx <- setNames(idx$lengths  * 2, idx$values)


panel.1 <- modelsummary::modelsummary(mod.list,
                  estimate = "{estimate}",
                  statistic = "conf.int",
                  fmt = 2,
                  group = term ~ model + y.level,
                  gof_map = gof.check,
                  coef_map = coef_map,
                  add_rows = rows.com,
                  stars = FALSE,
                  longtable = TRUE,
                  output = "latex",
                  escape = FALSE,
                  caption = "Bayesian multilevel multinomial logistic regressions predicting attitudes towards US actors. Interaction between crime and contact. \\label{tab:crimetab1}") %>% 
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 4, position = "float_left") %>%
  add_header_above(c(" ", "US Presence" = 3, "US People" = 3, "US Government" = 3)) %>% 
  group_rows(index = idx, bold = TRUE, background = "gray", color = "white", hline_after = TRUE) %>% 
  row_spec(last.line, hline_after = TRUE) %>% 
  landscape() %>% 
  kableExtra::save_kable(here("Tables/Chapter-Crime/model-crime-interaction.tex"),
             keep_tex = TRUE)

```

## Figures

### Population Level Effects

```{r crime population coefficient plots}


# Read in model files
m.cr.t1 <- readRDS(here::here("Output/Chapter-Crime/m.cr.t1.rds"))
m.cr.p1 <- readRDS(here::here("Output/Chapter-Crime/m.cr.p1.rds"))
m.cr.g1 <- readRDS(here::here("Output/Chapter-Crime/m.cr.g1.rds"))

mod.list <- list("US Presence" = m.cr.t1,
                 "US People" = m.cr.p1,
                 "US Government" = m.cr.g1)

coef.plot <- lapply(mod.list, function(x) {
  
  df <- tidybayes::gather_draws(x, 
                          b_mupos_troops_crime_persYes,
                          b_mupos_troops_crime_nonpersYes,
                          b_muneg_troops_crime_persYes,
                          b_muneg_troops_crime_nonpersYes) 
  
  df %>% 
    dplyr::mutate(dv.response = case_when(
      grepl("mupos", .variable) ~ "Positive",
      grepl("muneg", .variable) ~ "Negative",
      grepl("mudk", .variable) ~ "Don't know/Decline"
    ),
    iv.response = case_when(
      grepl("Yes", .variable) ~ "Yes",
      grepl("DontknowDdeclinetoanswer", .variable) ~ "Don't know/Decline"
    ),
    iv = case_when(
      grepl("crime_pers", .variable) ~ "Personal Experience with Crime",
      grepl("crime_nonpers", .variable) ~ "Network Experience with Crime"
    ),
    iv = factor(iv, levels = c("Personal Experience with Crime", "Network Experience with Crime")),
    dv.response = factor(dv.response, levels = c("Positive", "Negative", "Don't know/Decline")),
    comparison = "Posterior",
    id = glue::glue("{iv}, {iv.response}, {dv.response}")
  ) %>% 
    dplyr::group_by(id) %>% 
    mutate(direction = case_when(
      median(.value) > 0 ~ "Positive",
      median(.value) < 0 ~ "Negative"
    ),
    median = median(.value),
    posterior.positive = round(length(.value[.value>0])/length(.value), 3),
    posterior.negative = round(length(.value[.value<0])/length(.value), 3)
    )
  
  }
  )

coef.plot <- data.table::rbindlist(coef.plot, idcol = TRUE) %>% 
  mutate(.id = factor(.id, levels = c("US Presence", "US Government", "US People")))

ggplot(coef.plot, aes(x = .value, y = iv.response, color = dv.response)) +
  stat_pointinterval(.width = c(0.5, 0.8, 0.95), position = position_dodge(width = 0.60), interval_size_range = c(1, 3, 5), fatten_point = 1.8) +
  geom_vline(xintercept = 0, color = "black", size = 0.75) +
  facet_grid(iv ~ .id) +
  theme_flynn() +
  theme(legend.position = "bottom",
        panel.spacing = unit(0.25, "line"),
        strip.background = element_rect(size = 0.2),
        panel.border = element_rect(size = 0.2),
        legend.text = element_text(size = basesize * 1.1, margin = margin(l = -0.4, unit = "cm"))) +
  scale_color_viridis(discrete = TRUE, begin = 0.1, end = 0.6, option = "magma") +
  labs(x = "Coefficient Estimate",
       y = "Independent Variable Response",
       color = "Assessment of Reference Group")



ggsave(here::here("Figures/Chapter-Crime/figure-coefficient-plot-population.tiff"), height = 6, width = 6.5, units = "in")
ggsave(here::here("Figures/Chapter-Crime/figure-coefficient-plot-population.jpg"), height = 6, width = 6.5, units = "in")

```


```{r posterior percent table}



# Read in model files
m.cr.t1 <- readRDS(here::here("Output/Chapter-Crime/m.cr.t1.rds"))
m.cr.p1 <- readRDS(here::here("Output/Chapter-Crime/m.cr.p1.rds"))
m.cr.g1 <- readRDS(here::here("Output/Chapter-Crime/m.cr.g1.rds"))

mod.list <- list("US Presence" = m.cr.t1,
                 "US People" = m.cr.p1,
                 "US Government" = m.cr.g1)


posterior.table <- lapply(mod.list, function(x) {
  temp <- parameters::parameters(x) %>% 
    filter(grepl(".*crime.*", Parameter)) %>% 
    filter(grepl(".*Yes.*", Parameter)) %>% 
    filter(!grepl(".*dk.*", Parameter)) %>%  # Remove don't know outcomes
    dplyr::select(Parameter, Median, CI_low, CI_high, pd)
  
}
)

posterior.table.df <- rbindlist(posterior.table, idcol = TRUE) %>% 
  dplyr::mutate(id = factor(row_number()),
                `People Who Report` = case_when(
                  grepl(".*crime_pers.*", Parameter) ~ "Personal Experience with Crime",
                  grepl(".*crime_nonpers*", Parameter) ~ "Network experience with Crime",
                ),
                `Have a` = case_when(
                  Median > 0 ~ "Higher Probability of",
                  Median < 0 ~ "Lower Probability of"
                ),
                `Expressing` = case_when(
                  grepl(".*mupos.*", Parameter) ~ "Favorable Attitudes",
                  grepl(".*muneg.*", Parameter) ~ "Unfavorable Attitudes",
                ),
                Median = sprintf('%.2f', round(Median, 2)),
                CI_low = sprintf('%.2f', round(CI_low, 2)),
                CI_high = sprintf('%.2f', round(CI_high, 2)),
                pd = round(pd, 2),
                `Interval` = glue::glue("[{CI_low}, {CI_high}]")) %>% 
  dplyr::rename("Probability" = "pd") %>% 
  dplyr::select(`Probability`, `People Who Report`, `Have a`, `Expressing`, .id, `Median`, `Interval`) %>% 
  mutate(id = factor(row_number()))
  
# Create figures for sparkplot thing
for(i in 1:12) {
  
  id <- i

  p <- ggplot(posterior.table.df %>% filter(id == i), aes(x = Probability, y = id)) +
      geom_bar(stat = "identity", fill = "gray30") +
      geom_text(aes(label = glue::glue("{Probability*100}%")), color = "white", hjust = 1.3, size = 18) +
    geom_vline(xintercept = 0, size = 1.5) +
    geom_vline(xintercept = 1, size = 1.5) +
      scale_x_continuous(limits = c(0, 1), expand = c(0, 0)) +
      theme_void() +
    theme(plot.background = element_rect(fill = "white", size = 0))
    ggsave(p, filename = glue::glue("sparkplot-{id}.jpg"), path = here::here("Figures/Chapter-Crime/"), height = 0.45, width = 4)
}


posterior.table.df <- posterior.table.df %>% 
  mutate(Probability = paste0("\\raisebox{-.25\\height}{\\includegraphics[width=2.5cm]{../Figures/Chapter-Crime/sparkplot-", id, ".jpg}}")) %>% 
  arrange(id, `People Who Report`) %>% 
  dplyr::select(-c(.id, id))

posterior.table.out <- posterior.table.df %>% 
  kable(format = "latex", booktabs = TRUE, align = c("l","l","l","l", "c", "c"), caption = "Summary of posterior estimates for crime models \\label{tab:crimeposteriordistribution}", escape = FALSE) %>% 
  kable_styling(latex_options = c("striped"), protect_latex = TRUE, font_size = 7, position = "center") %>% 
  row_spec(0, bold = TRUE) %>%
  pack_rows("Attitudes Towards US Presence", 1,4, color = "white", background = "gray") %>% 
  pack_rows("Attitudes Towards US Government", 5,8, color = "white", background = "gray") %>% 
  pack_rows("Attitudes Towards US People", 9,12, color = "white", background = "gray") %>% 
  footnote(number = c("\\\\scriptsize Results are from the population-level effects of the three multilevel categorical logit models predicting attitudes towards US military personnel deployed to the host state, the US government, and the American people. All comparisons are relative to people who report not having direct personal experience, or social network contacts who have experienced, a crime committed by US service personnel. Reference category for the outcome variable is the 'Neutral' attitude response.",
                      "The probability column denotes the percentage of the posterior distribution that falls above or below 0.",
                      "Median and interval values are the median coefficient estimate for the individual logit equations reported on the log-odds scale and 95 percent credible intervals.",
                      "Main predictor variables indicate whether the respondents reported that they, or someone they know, had direct personal contact with US military personnel, or received economic benefits from the US military presence."),
           fixed_small_size = TRUE,
           footnote_as_chunk = FALSE,
           threeparttable = TRUE,
           escape = FALSE) %>% 
  landscape() %>% 
  save_kable(., file = here("Tables/Chapter-Crime/model-posterior-table.tex"),
             keep_tex = TRUE)




```


### Disaggregated Crime Effects

```{r crime population coefficient plots}


# Read in model files
m.cr.t2 <- readRDS(here::here("Output/Chapter-Crime/m.cr.t2.rds"))
m.cr.p2 <- readRDS(here::here("Output/Chapter-Crime/m.cr.p2.rds"))
m.cr.g2 <- readRDS(here::here("Output/Chapter-Crime/m.cr.g2.rds"))

mod.list <- list("US Presence" = m.cr.t2,
                 "US People" = m.cr.p2,
                 "US Government" = m.cr.g2)

coef.plot <- lapply(mod.list, function(x) {
  
  df <- tidybayes::gather_draws(x,
                          b_mupos_theftYes,
                          b_mupos_robberyYes,
                          b_mupos_burglaryYes,
                          b_mupos_drugrelatedYes,
                          b_mupos_assaultYes,
                          b_mupos_sexualassaultYes,
                          b_muneg_theftYes,
                          b_muneg_robberyYes,
                          b_muneg_burglaryYes,
                          b_muneg_drugrelatedYes,
                          b_muneg_assaultYes,
                          b_muneg_sexualassaultYes,) 
  
  df %>% 
    dplyr::mutate(dv.response = case_when(
      grepl("mupos", .variable) ~ "Positive",
      grepl("muneg", .variable) ~ "Negative",
      grepl("mudk", .variable) ~ "Don't know/Decline"
    ),
    iv.response = case_when(
      grepl("Yes", .variable) ~ "Yes",
      grepl("DontknowDdeclinetoanswer", .variable) ~ "Don't know/Decline"
    ),
    iv = case_when(
      grepl("theft", .variable) ~ "Theft",
      grepl("obb", .variable) ~ "Robbery",
      grepl("urgl", .variable) ~ "Burglary",
      grepl("drugrelated", .variable) ~ "Drug Related",
      grepl("_assaultY", .variable) ~ "Assault",
      grepl("sexualassault", .variable) ~ "Sexual Assault"
    ),
    iv = factor(iv, levels = c("Theft", "Robbery", "Burglary", "Drug Related", "Assault", "Sexual Assault")),
    dv.response = factor(dv.response, levels = c("Positive", "Negative", "Don't know/Decline")),
    comparison = "Posterior",
    id = glue::glue("{iv}, {iv.response}, {dv.response}")
  ) %>% 
    dplyr::group_by(id) %>% 
    mutate(direction = case_when(
      median(.value) > 0 ~ "Positive",
      median(.value) < 0 ~ "Negative"
    ),
    median = median(.value),
    posterior.positive = round(length(.value[.value>0])/length(.value), 3),
    posterior.negative = round(length(.value[.value<0])/length(.value), 3)
    )
  
  }
  )

coef.plot <- data.table::rbindlist(coef.plot, idcol = TRUE) %>% 
  mutate(.id = factor(.id, levels = c("US Presence", "US Government", "US People")))

ggplot(coef.plot, aes(x = .value, y = iv.response, color = dv.response)) +
  stat_pointinterval(.width = c(0.5, 0.8, 0.95), position = position_dodge(width = 0.60), interval_size_range = c(1, 3, 5), fatten_point = 1.5) +
  geom_vline(xintercept = 0, color = "black", size = 0.75) +
  facet_grid(iv ~ .id) +
  theme_flynn() +
  theme(legend.position = "bottom",
        panel.spacing = unit(0.25, "line"),
        strip.background = element_rect(size = 0.2),
        panel.border = element_rect(size = 0.2),
        legend.text = element_text(size = basesize * 1.1, margin = margin(l = -0.4, unit = "cm")),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  viridis::scale_color_viridis(discrete = TRUE, begin = 0.1, end = 0.6, option = "magma") +
  labs(x = "Coefficient Estimate",
       y = "",
       color = "Assessment of Reference Group")



ggsave(here::here("Figures/Chapter-Crime/figure-coefficient-plot-disaggregated-crime.tiff"), height = 7, width = 5, units = "in")
ggsave(here::here("Figures/Chapter-Crime/figure-coefficient-plot-disaggregated-crime.jpg"), height = 7, width = 5, units = "in")

```

### Varying Effects

```{r }



# Read in model files
m.cr.t3 <- readRDS(here::here("Output/Chapter-Crime/m.cr.t3.rds"))
m.cr.p3 <- readRDS(here::here("Output/Chapter-Crime/m.cr.p3.rds"))
m.cr.g3 <- readRDS(here::here("Output/Chapter-Crime/m.cr.g3.rds"))

mod.list <- list("US Presence" = m.cr.t3,
                 "US People" = m.cr.p3,
                 "US Government" = m.cr.g3)


coef.plot <- lapply(mod.list, function(x) {
  
  df.pos <- tidybayes::spread_draws(x, cbind(
                              b_mupos_troops_crime_persYes,
                              b_mupos_troops_crime_nonpersYes),
                              r_country__mupos[country,mupos_troops_crime_persYes]) %>%
    dplyr::filter(grepl("Yes", mupos_troops_crime_persYes)) %>% 
    pivot_wider(id_cols = c(.chain, .iteration, .draw, b_mupos_troops_crime_persYes, b_mupos_troops_crime_nonpersYes, country),
                names_from = mupos_troops_crime_persYes,
                values_from = r_country__mupos) %>% 
    mutate(crime_pers_pos = b_mupos_troops_crime_persYes + troops_crime_persYes,
           crime_nonpers_pos = b_mupos_troops_crime_nonpersYes + troops_crime_nonpersYes) %>% 
    dplyr::select(country, crime_pers_pos, crime_nonpers_pos) %>% 
    pivot_longer(cols = c(2:3),
                 names_to = "variable",
                 values_to = ".value") %>% 
    mutate(dv.response = "Positive Assessments")
  
  df.neg <- tidybayes::spread_draws(x, cbind(
                              b_muneg_troops_crime_persYes,
                              b_muneg_troops_crime_nonpersYes),
                              r_country__muneg[country,muneg_troops_crime_persYes]) %>%
    dplyr::filter(grepl("Yes", muneg_troops_crime_persYes)) %>% 
    pivot_wider(id_cols = c(.chain, .iteration, .draw, b_muneg_troops_crime_persYes, b_muneg_troops_crime_nonpersYes, country),
                names_from = muneg_troops_crime_persYes,
                values_from = r_country__muneg) %>% 
    mutate(crime_pers_neg = b_muneg_troops_crime_persYes + troops_crime_persYes,
           crime_nonpers_neg = b_muneg_troops_crime_nonpersYes + troops_crime_nonpersYes) %>% 
    dplyr::select(country, crime_pers_neg, crime_nonpers_neg) %>% 
    pivot_longer(cols = c(2:3),
                 names_to = "variable",
                 values_to = ".value") %>% 
    mutate(dv.response = "Negative Assessments")
    
    
    df.com <- bind_rows(df.pos, df.neg) 
  
}
)

coef.plot.df <- rbindlist(coef.plot, idcol = TRUE) %>% 
  mutate(.id = factor(.id, levels = c("US Presence", "US Government", "US People")),
         variable = gsub("_pos|_neg", "", variable),
         variable = factor(variable, levels = c("crime_pers", "crime_nonpers"),
                           labels = c("Personal Experience with Crime", "Network Experience with Crime")),
         dv.response = factor(dv.response, levels = c("Positive Assessments", "Negative Assessments")),
         country = sub("\\.", " ", country))


# Generate summary list of the medians to compare to the coef output and the figure to make sure stuff is right.
coef.plot.summary <- coef.plot.df %>% 
  dplyr::group_by(.id, country, variable, dv.response) %>% 
  median_hdci()

ggplot(coef.plot.df, aes(x = .value, y = country, color = variable)) +
  stat_pointinterval(.width = c(0.5, 0.8, 0.95), position = position_dodge(width = 0.75), interval_size_range = c(1, 2, 3), fatten_point = 1.2) +
  geom_vline(xintercept = 0, color = "black", size = 0.75) +
  facet_grid(dv.response ~ .id) +
  theme_flynn() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = basesize*1.2),
        axis.text.y = element_text(size = basesize*1.2),
        axis.title.x = element_text(size = basesize*1.5),
        panel.spacing = unit(0.25, "line"),
        panel.border = element_rect(size = 0.2),
        strip.background = element_rect(size = 0.2),
        strip.text = element_text(size = basesize*1.3),
        legend.title = element_text(size = basesize*1.2),
        legend.text = element_text(size = basesize*1.2, margin = margin(l = -0.2, unit = "cm"))) +
  guides(color = guide_legend(reverse = TRUE, nrow = 2)) +
  scale_color_viridis(discrete = TRUE, begin = 0.1, end = 0.9, option = "magma") +
  labs(x = "Country Coefficient Estimate",
       y = "",
       color = "Crime Experience Type")

ggsave(here::here("Figures/Chapter-Crime/figure-coefficient-plot-varying.jpg"), height = 8.5, width = 7, units = "in")


```


```{r varying posterior probabilities}


#Generate a table of the median coefficient values and the percent of the posterior distribution that falls in the expected direction.
#
posterior.summary <- coef.plot.df %>% 
  group_by(.id, country, variable, dv.response) %>% 
  dplyr::summarise(median = round(median(.value), 3),
                   pd = round(as.numeric(paste(bayestestR::p_direction(.value))), 3))

# Break the table down into more readable components for writing up the results.
posterior.summary %>% filter(grepl("People", .id) & 
                               grepl("Net", variable) & 
                               grepl("Neg", dv.response))


```



```{r tidybayes-interaction-contrast}

# Read in model files
m.cr.t4 <- readRDS(here::here("Output/Chapter-Crime/m.cr.t4.rds"))
m.cr.p4 <- readRDS(here::here("Output/Chapter-Crime/m.cr.p4.rds"))
m.cr.g4 <- readRDS(here::here("Output/Chapter-Crime/m.cr.g4.rds"))

mod.list <- list("US Presence" = m.cr.t4,
                 "US People" = m.cr.p4,
                 "US Government" = m.cr.g4)

newdata <- expand_grid(country = "Germany",
                         troops_crime_pers = c("Yes", "No"),
                         troops_crime_nonpers = "No",
                         contact_pers= c("Yes", "No"),
                         contact_nonpers = "No",
                         benefit_pers = "No",
                         benefit_nonpers = "No",
                         minority = "No",
                         age = "35 to 44 years",
                         ed_z = mean(o.data$ed_z, na.rm = TRUE),
                         ideology_z = mean(o.data$ideology_z, na.rm = TRUE),
                         income.5.cat = "41-60%",
                         gender = "Female",
                         american_inf_1 = "Some",
                         american_inf_2 = "Neither positive nor negative",
                         basecount_z = mean(o.data$basecount_z, na.rm = TRUE),
                         gdp_z = mean(o.data$gdp_z, na.rm = TRUE),
                         pop_z = mean(o.data$pop_z, na.rm = TRUE),
                         troops_z = mean(o.data$troops_z, na.rm = TRUE))


tidy.pred <- lapply(mod.list, function(x) {
  
  temp.1 <- x %>% 
    epred_draws(newdata = newdata,
              re_forumla = ~(1 | r | country),
              ndraws = 1e3) %>% 
    filter(grepl("pos|neg", .category))

}
)

tidy.pred.df <- data.table::rbindlist(tidy.pred, idcol = TRUE) %>% 
  mutate(grouping = glue::glue("Personal Crime: {troops_crime_pers}, Personal Contact: {contact_pers}")) %>% 
  dplyr::filter(grouping == "Personal Crime: No, Personal Contact: No" |
                  grouping == "Personal Crime: Yes, Personal Contact: No" |
                  grouping == "Personal Crime: Yes, Personal Contact: Yes") %>% 
  mutate(grouping = factor(grouping, levels = c("Personal Crime: Yes, Personal Contact: Yes",
                                                "Personal Crime: Yes, Personal Contact: No",
                                                "Personal Crime: No, Personal Contact: No")),
         .id = factor(.id, levels = c("US Presence", "US Government", "US People")),
         .category = factor(.category, levels = c("pos", "neg"), 
                            labels = c("Positive", "Negative")))



# Collapse posteriors into vectors to explore overlaps
overlap.compare <- tidy.pred.df %>% 
  dplyr::select(c(.id, country, .epred, grouping, .category)) %>% 
  pivot_wider(id_cols = c(.id, country, grouping, .epred, .category),
              names_from = c(.id, .category, grouping),
              values_from = .epred) %>% 
  unnest()

# Nice and neatPeople
test <- bayestestR::overlap(x = overlap.compare$`US People_Negative_Personal Crime: No, Personal Contact: No`,
                            y = overlap.compare$`US People_Negative_Personal Crime: Yes, Personal Contact: Yes`)

test
# This is how you pull the actual data frame of the distribution and overlapping values.
#test <- as.data.frame(attributes(test)$data)
  


ggplot(tidy.pred.df, aes(y = grouping, x = .epred, fill = grouping)) +
  stat_halfeye(.width = c(0.50, 0.80, 0.95), position = position_dodge(width = 0.2), slab_alpha = 0.7)  +
  geom_vline(xintercept = 0, size = 1.1, show.legend = FALSE) +
  viridis::scale_fill_viridis(option = "magma", discrete = TRUE, begin = 0.1, end = 0.9) +
  viridis::scale_color_viridis(option = "magma", discrete = TRUE, begin = 0.1, end = 0.9) +
  theme_flynn() +
  theme(panel.border = element_rect(size = 0.2),
        plot.title = element_text(size = basesize*1.6),
        strip.background = element_rect(size = 0.2),
        strip.text = element_text(size = basesize*1.4),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = basesize * 1.3),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = basesize * 1.3),
        legend.title = element_text(size = basesize*1.5, margin = margin(b = -0, unit = "cm")),
        legend.position = "bottom",
        legend.box = "vertical",
        legend.text = element_text(size = basesize*1.3, margin = margin(l = -0.5, unit = "cm")),
        panel.spacing = unit(0.3, "cm")) +
  guides(fill = guide_legend(nrow = 3, reverse = TRUE),
         interval_lour = "none",
         interval_size = "none",
         interval_shape = "none",
         interval_alpha = "none",
         interval_linetype = "none") +
  facet_grid(.category ~ .id ) +
  labs(x = "Predicted Probability",
       y = "",
       fill = "Experience",
       title = "Predicted Probabilities of Expressing Positive and Negative Attitudes in Germany")

ggsave(here::here("Figures/Chapter-Crime/figure-expected-conditional.jpg"), height = 7, width = 8, units = "in")


```


```{r emmeans test}

# NOTE: emmeans doesn't work well for the choice models because it doesn't generate a category variable corresponding to the dependent variable categories. I submitted an issue request to GitHub and waiting to hear back.
# Come back to this later. Not working great
# Posterior predictions across autonomy and region
ame.fig <- m.cr.t3 %>% 
  emmeans(~ troops_crime_pers + country,
          at = list(country = unique(m.cr.t3$data$country),
                       troops_crime_nonpers = "No",
                       contact_pers="No",
                       contact_nonpers = "No",
                       benefit_pers = "No",
                       benefit_nonpers = "No",
                       minority = "No",
                       age = "35 to 44 years",
                       ed_z = mean(o.data$ed_z, na.rm = TRUE),
                       ideology_z = mean(o.data$ideology_z, na.rm = TRUE),
                       income.5.cat = "41-60%",
                       gender = "Female",
                       american_inf_1 = "Some",
                       american_inf_2 = "Neither positive nor negative",
                       basecount_z = mean(o.data$basecount_z, na.rm = TRUE),
                       gdp_z = mean(o.data$gdp_z, na.rm = TRUE),
                       pop_z = mean(o.data$pop_z, na.rm = TRUE),
                       troops_z = mean(o.data$troops_z, na.rm = TRUE)),
          epred = TRUE, 
          dpar = "mupos",
          re_formula = ~(1 + troops_crime_pers + troops_crime_nonpers |p| country)) %>% 
  contrast(method = "revpairwise", by = "country") %>% 
  gather_emmeans_draws() %>% 
  filter(contrast == "Yes - No")

ggplot(ame.fig, aes(x = .value, y = country)) +
  stat_halfeye()

```


