---
title: "Minority Chapter Analysis and Notes"
author: "Michael Flynn"
date: "Last Updated: `r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

# Front Matter

This section loads the data files and libraries. Assembles the main data

```{r, echo = FALSE, include = FALSE}
library(tidyverse)
library(psych)
library(tidyquant)
library(modelr)
library(cshapes)
library(countrycode)
library(dagitty)
library(ggdag)
library(arm)
library(brms)
library(job)
library(rstan)
library(cmdstanr)
library(parallel)
library(tidybayes)
library(ggdist)
library(kableExtra)
library(BayesPostEst)
library(texreg)
library(broom)
library(broom.mixed)
library(ggExtra)
library(ggmcmc)
library(rgdal)
library(rgeos)
library(rmapshaper)
library(broom)
library(ggpubr)
library(ggrepel)
library(ggpubr)
library(patchwork)
library(here)
library(arm)
library(modelsummary)
library(tictoc)
library(glue)
library(data.table)
library(showtext)

knitr::opts_chunk$set(comment = '', dpi = 400)

sysfonts::font_add_google("Oswald", family = "oswald")
showtext_auto()

basesize <- 30
# Regular plot theme
theme_flynn <- function(){ 
  
      theme_linedraw(base_size = basesize, base_family = "oswald") %+replace% 
        
        theme(plot.title = element_text(face = "bold", size = basesize * 1.3, hjust = 0, margin = margin(t = 0, b = 0.3, l = 0, r = 0, unit = "cm")),
              plot.subtitle = element_text(size = basesize),
              plot.caption = element_text(face = "italic", size = basesize * 0.6),
              panel.border = element_rect(fill = NA, size = 0.2),
              strip.background = element_rect(fill = "gray80", color = "black", size = 0.2),
              strip.text = element_text(size = basesize, color = "black", face = "bold", margin = margin(t = 0.2, b = 0.2, l = 0.2, r = 0.2, unit = "cm")),
              panel.background = element_rect(size = 0.2),
              panel.grid.major = element_line(color = "gray70", size = 0.15),
              panel.grid.minor = element_line(color = "gray90", size = 0.1),
              axis.title = element_text(face = "bold", size = basesize),
              axis.title.y = element_text(angle = 90, margin = margin(t = 0, r = 0.5, b = 0, l = 0, unit = "cm")),
              axis.title.x = element_text(margin = margin(t = 0.5, r = 0, b = 0, l = 0, unit = "cm")),
              axis.ticks = element_line(size = 0.1),
              axis.ticks.length = unit(0.1, "cm"),
              legend.title = element_text(size = basesize, face = "bold", hjust = 0, margin = margin(t = 0, b = 0, l = 0, r = 0, unit = "cm")),
              plot.margin = margin(0.5, 0.5, 0.5, 0.5, unit = "cm"),
              legend.margin = margin(t=-10, b=0, r=0, l=0),
              legend.box.margin = margin(-10,-10,-10,-10))
  }

# Map version of theme
theme_flynn_map <- function(){
  
  theme_void(base_family = "oswald") %+replace% 
    
    theme(plot.title = element_text(face = "bold", size = 18, hjust = 0, margin = margin(t = 0, b = 0.3, l = 0, r = 0, unit = "cm")),
          plot.subtitle = element_text(size = 12, hjust = 0, margin = margin(t = 0, b = 0.3, l = 0, r = 0, unit = "cm")),
          plot.caption = element_text(face = "italic", size = 8, hjust = 1, margin = margin(t = 0.2, unit = "cm")),
          strip.background = element_rect(fill = "gray80", color = "black"),
          strip.text = element_text(color = "black", face = "bold"),
          panel.grid.major = element_line(color = "white", size = 0),
          panel.grid.minor = element_line(color = "white", size = 0),
          #axis.title = element_text(face = "bold", size = 0),
          #axis.title.y = element_text(margin = margin(t = 0, r = 0.5, b = 0, l = 0, unit = "cm")),
          #axis.title.x = element_text(margin = margin(t = 0.5, r = 0, b = 0, l = 0, unit = "cm")),
          legend.title = element_text(face = "bold"),
          legend.position = "bottom",
          legend.key.height = unit(0.6, "cm"),
          legend.key.width = unit(2.5, "cm"))
}


ccode.list <- c("200", "210", "211", "230", "235", "255", "290", "325", "640", "690", "732", "740", "840", "900")

# Load opinion data for individual-level protest models.
load(here::here("Data/General", "opinion.data.RData")) 

# Conflicted pckage really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)


```



# DAGs
```{r DAG for minority variable}

library(dagitty)

minority.dag <- dagitty("dag{
                        Minority [exposure]
                        Attitudes [outcome]
                        
                        Minority -> Income -> Attitudes
                        Minority -> Education -> Attitudes
                        Education -> Income -> Ideology -> Influence
                        Education -> Ideology
                        Minority -> Ideology -> Attitudes
                        Minority -> Influence -> Attitudes
                        Minority -> Contact -> Attitudes
                        Minority -> Attitudes -> Contact
                        Minority -> Democracy -> Attitudes
                        Minority -> Benefits -> Attitudes 
                        Sex -> Income -> Attitudes
                        Sex -> Education -> Attitudes
                        Sex -> Ideology -> Attitudes
                        
                        }")

coordinates(minority.dag) <- list(x=c(Minority=-1, Attitudes=3, Income=1, Education=1, Ideology=0, Influence=1, Contact=1, Democracy=2, Benefits=1, Sex=-1),
                                  y=c(Minority=0, Attitudes=0, Income=2, Education=-0.5, Ideology=0.5, Influence=-2, Contact=3, Democracy=-2, Benefits=4, Sex=1))


minority.dag %>% 
  tidy_dagitty() %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_edges() +
  geom_dag_text(parse = TRUE, color = "black") +
  theme_dag_blank()

ggsave(here("Figures/Chapter-Minority", "figure-dag-minority-minority.png"))

adjustmentSets(minority.dag)

```




# Descriptive Figures

```{r Descriptive Figures}


# Minorities as a percent of the sample by year
minperc <- o.data %>% 
  group_by(country, year) %>% 
  mutate(minority.yes = ifelse(minority == "Yes", 1, 0),
         groupobs = n_distinct(X1)) %>% 
  dplyr::summarise(minority = sum(minority.yes, na.rm = TRUE),
            obs = mean(groupobs, na.rm = TRUE)) %>% 
  mutate(min.per = minority/obs) %>% 
  filter(!is.na(country))

ggplot(minperc, aes(y = factor(year), x = min.per, color = country)) +
  geom_text(aes(label = country), position = position_jitter(height = 0.4), size = 2.5) +
  theme_flynn() +
  scale_x_continuous(labels = scales::percent_format()) +
  guides(color = FALSE) +
  theme(plot.title.position = "plot") +
  labs(x = "Percent",
       y = "Year",
       color = "Country",
       title = "Self-identified minority group members as percent of country sample")

ggsave(here("/Figures/Chapter-Minority/fig-minority-percent-time.png"))



#### Minority Percent Table ####
minperc.wide <- minperc %>% 
  mutate(min.per = round(min.per*100, 1)) %>% 
  pivot_wider(names_from = "year",
              values_from = "min.per") %>% 
  group_by(country) %>% 
  dplyr::summarise("2018" = mean(`2018`, na.rm = TRUE),
                   "2019" = mean(`2019`, na.rm = TRUE),
                   "2020" = mean(`2020`, na.rm = TRUE)) %>% 
  dplyr::rename(`Country` = `country`) %>% 
  kable(format = "latex", align = "lrrr", booktabs = TRUE, caption = "Minority self-identification of respondents by country-year \\label{tab:minoritypercent}") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("striped"), protect_latex = TRUE) %>% 
  add_header_above(c(" ", "Survey Year" = 3), bold = TRUE) %>% 
  row_spec(0, bold = "true", color = "black") %>% 
  column_spec(1, width = "3in") %>% 
    footnote(general = "Reported numbers indicate percent of surveey respondents for the referent country-year self-identifying as a member of a racial, ethnic, or religious minority group.",
             footnote_as_chunk = TRUE,
             escape = TRUE,
             threeparttable = TRUE) %>% 
  save_kable(here("/Tables/Chapter-Minority/table-minority-percent.tex"))





# Minority population count by country and year
ggplot(o.data %>% filter(!is.na(minority)), aes(x = minority, y = ..count..)) +
  geom_bar(stat = "count") +
  facet_grid(country ~ year) +
  theme(axis.text.x = element_text(angle = 45))



#### Japan Map for Minority population ####

base.locations.japan <- read_csv(here("../Geographic files/Bases.csv")) %>% 
  filter(`Country Name` == "Japan" & base == 1) %>% 
  mutate(Longitude = as.numeric(Longitude),
         Latitude = as.numeric(Latitude))

map.japan <- rgdal::readOGR(here("../Geographic files/Chubu_Region_AL320/"))

japan.df <- tidy(map.japan, region = "name") %>% 
  mutate(provcode = 740*100+as.numeric(as.factor(id)),
         id = ifelse(grepl(".*Hokk.*", id), "Hokkaido Region", id))

japan.min <- o.data %>% 
  filter(country == "Japan" & minority == "Yes") %>% 
  dplyr::select(province, minority) %>% 
  mutate(totalminority = nrow(.),
         province = ifelse(province == "Okinawa", "Kyushu", province)) %>% 
  group_by(province) %>%
  mutate(provseq = 1) %>% 
  dplyr::summarise(prov.min = sum(provseq),
            totalminority = mean(totalminority, na.rm = TRUE)) %>% 
  mutate(minoritypercent = prov.min/totalminority,
         id = paste(province, "Region", sep = " "),
         id = ifelse(id == "Kanto Region", "Kanto", id),
         id = ifelse(id == "Tohoku Region", "Tohoku", id)) %>% 
  ungroup()

japan.df.fill <- japan.df %>% 
  left_join(japan.min, by = c("id")) %>% 
  as_tibble() %>% 
  arrange(order)

# Generate polygon centroids
japan.centroids <- map.japan %>% 
  gCentroid(byid = TRUE, id = unique(map.japan$name)) %>% 
  as.data.frame(.$coords) %>% 
  mutate(province = row.names(.),
         province = ifelse(grepl("okk", province), "Hokkaido", province),
         province = case_when(
           !grepl(".*Region.*", province) ~ glue::glue("{province} Region"),
           TRUE ~ province
         ))



# Map of Japan with U.S. military bases overlaid

ggplot() +
  geom_polygon(data = japan.df.fill, aes(x = long, y = lat, group = group, fill = minoritypercent), color = "black", size = 0.2) +
  geom_point(data = base.locations.japan, aes(x = Longitude, y = Latitude), color = "black", fill = "gray90", alpha = 1.0, pch = 24, size = 4, stroke = 0.6) +
  geom_label_repel(data = japan.centroids, aes(x = x, y = y), label = japan.centroids$province, min.segment.length = unit(0, "in"), max.overlaps = 50, size = 8.25, box.padding = 1.5) +
  coord_fixed(ratio = 1.3) +
  theme_flynn_map() +
  theme(plot.background = element_rect(fill = "white", size = 0),
        plot.margin = margin(t=0, b=0.2, l=0, r=0, unit = "pt"),
        legend.title = element_text(size = basesize * 1.1),
        legend.text = element_text(size = basesize * 1, margin = margin(t = -0.4, unit = "cm")),
        legend.key.width = unit(1.75, "cm"),
        legend.key.height = unit(0.5, "cm"),
        legend.margin = margin(0, 0, 0, 0, unit = "cm"),
        legend.box.margin = margin(t = -2.0, l = -2.0, b = 0.5, unit = "cm")) +
  viridis::scale_fill_viridis(option = "magma", direction = -1, begin = 0.1, end = 0.9, limits = c(0, 0.4), labels = scales::percent_format()) +
  labs(fill = "Percent")

ggsave(here("Figures/Chapter-Minority/fig-map-japan-min-location.png"), height = 5, width = 7, units = "in")
ggsave(here("Figures/Chapter-Minority/fig-map-japan-min-location.jpg"), height = 5, width = 7, units = "in")





#### Minority status and education ####

ggplot(o.data %>% filter(grepl("Yes|No", minority)), aes(x = ed, y = income.5.cat, color = minority)) +
  geom_point(position = position_jitter(width = 0.45, height = 0.3), alpha = 0.4) +
  scale_x_continuous(breaks = seq(0,25, 5)) +
  facet_wrap(. ~ country)

```



# Models

## Priors

```{r priors}

Sys.setlocale('LC_ALL','C') # Have to add this for Mac for some reason?


# Get priors
PRIOR.LIST.T <- get_prior(troops_1_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z +  
            (1 + minority |r| country),
                    data = o.data,
            family = categorical(link = "logit", refcat = "neutral")) 

# Default and regularizing priors
# Use the same basic data.frame for everything
PRIOR.LIST.REG <- PRIOR.LIST.T %>% 
  filter(coef == "") %>% 
  mutate(prior = case_when(
    class == "b" ~ "normal(0,2)",
    class == "sd" ~ "gamma(1, 1)",
    class == "Intercept" ~ "normal(0,3)",
    TRUE ~ prior
  )) 


# Informative beta Priors
PRIOR.LIST.T <- PRIOR.LIST.T %>% 
  filter(class == "b" & !is.na(coef) & coef != "") 

apsr.t <- readRDS(here::here("../Papers/Published/Primary Paper - Contact/Bayes Diagnostics/m1.cat.bayes.rds"))
apsr.g <- readRDS(here::here("../Papers/Published/Primary Paper - Contact/Bayes Diagnostics/m2.cat.bayes.rds"))
apsr.p <- readRDS(here::here("../Papers/Published/Primary Paper - Contact/Bayes Diagnostics/m3.cat.bayes.rds"))


# Troops Priors
PRIOR.T <- empty_prior()

coeflist <- as_tibble(apsr.t) %>% 
  dplyr::summarise_all(list(mean = mean, sd = sd)) %>% 
  pivot_longer(cols = 1:ncol(.), 
               names_to = c("coef", ".value"),
               names_pattern = "(.+)_(.+$)") %>% 
  mutate(prior = glue::glue("normal({round(mean, 2)},{round(sd, 2)})"),
         dpar = case_when(
           grepl("mupos", coef) ~ "mupos",
           grepl("muneg", coef) ~ "muneg",
           grepl("mudk", coef) ~ "mudk",
         ),
         coef = gsub("mupos_|muneg_|mudk_", "", coef),
         coef = gsub("knowDDe", "knowDde", coef)) %>% 
  filter(grepl("b_", coef)) %>% 
  mutate(coef = gsub("b_", "", coef),
         class = "b") %>% 
  dplyr::select(-c(mean, sd)) %>% 
  filter(grepl(".*contact_per.*|.*benefit_per.*|.*gender.*|.*inf.*|.*age.*|.*minority.*", coef)) %>% 
  filter(!grepl(".*minorityNo.*", coef))

PRIOR.T <- bind_rows(PRIOR.T, coeflist, PRIOR.LIST.REG) 
PRIOR.T[is.na(PRIOR.T)] <- ""


# Government Priors
PRIOR.G <- empty_prior() 

PRIOR.LIST.G <- get_prior(american_g_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 |r| country),
                    data = o.data,
            family = categorical(link = "logit", refcat = "neutral")) %>% 
  filter(class == "b" & !is.na(coef) & coef != "") 

coeflist <- as_tibble(apsr.g) %>% 
  dplyr::summarise_all(list(mean = mean, sd = sd)) %>% 
  pivot_longer(cols = 1:ncol(.), 
               names_to = c("coef", ".value"),
               names_pattern = "(.+)_(.+$)") %>% 
  mutate(prior = glue::glue("normal({round(mean, 2)},{round(sd, 2)})"),
         dpar = case_when(
           grepl("mupos", coef) ~ "mupos",
           grepl("muneg", coef) ~ "muneg",
           grepl("mudk", coef) ~ "mudk",
         ),
         coef = gsub("mupos_|muneg_|mudk_", "", coef),
         coef = gsub("knowDDe", "knowDde", coef)) %>% 
  filter(grepl("b_", coef)) %>% 
  mutate(coef = gsub("b_", "", coef),
         class = "b") %>% 
  dplyr::select(-c(mean, sd)) %>% 
  filter(grepl(".*contact_per.*|.*benefit_per.*|.*gender.*|.*inf.*|.*age.*|.*minority.*", coef)) %>% 
  filter(!grepl(".*minorityNo.*", coef))

PRIOR.G <- bind_rows(PRIOR.G, PRIOR.LIST.REG, coeflist) 
PRIOR.G[is.na(PRIOR.G)] <- ""




# People Priors
PRIOR.P <- empty_prior()

PRIOR.LIST.P <- get_prior(american_p_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 |r| country),
                    data = o.data,
            family = categorical(link = "logit", refcat = "neutral")) %>% 
  filter(class == "b" & !is.na(coef) & coef != "") 

coeflist <- as_tibble(apsr.p) %>% 
  dplyr::summarise_all(list(mean = mean, sd = sd)) %>% 
  pivot_longer(cols = 1:ncol(.), 
               names_to = c("coef", ".value"),
               names_pattern = "(.+)_(.+$)") %>% 
  mutate(prior = glue::glue("normal({round(mean, 2)},{round(sd, 2)})"),
         dpar = case_when(
           grepl("mupos", coef) ~ "mupos",
           grepl("muneg", coef) ~ "muneg",
           grepl("mudk", coef) ~ "mudk",
         ),
         coef = gsub("mupos_|muneg_|mudk_", "", coef),
         coef = gsub("knowDDe", "knowDde", coef)) %>% 
  filter(grepl("b_", coef)) %>% 
  mutate(coef = gsub("b_", "", coef),
         class = "b") %>% 
  dplyr::select(-c(mean, sd)) %>% 
  filter(grepl(".*contact_per.*|.*benefit_per.*|.*gender.*|.*inf.*|.*age.*|.*minority.*", coef)) %>% 
  filter(!grepl(".*minorityNo.*", coef))

PRIOR.P <- bind_rows(PRIOR.P, PRIOR.LIST.REG, coeflist) 
PRIOR.P[is.na(PRIOR.P)] <- ""


```




## Minority only models

```{r Basic Modles with minority only}


job::job(import = "auto", "m.t1" = {

  Sys.setlocale('LC_ALL','C') # Have to add this for Mac for some reason?

ITER <- 2000
WARMUP <-  1000
CORES <- 8
CHAINS <- 4
SEED <- 123

PRIOR.T.BASE <- PRIOR.T %>% 
  filter(grepl(".*minority.*", coef))

#### Troops  ####
m.t1 <- brm(troops_1_cat ~ minority +
            (1 |r| country),
                    family = categorical(link = "logit", refcat = "neutral"),
                    data = o.data,
                    prior = PRIOR.T.BASE,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    threads = threading(threads = 2),
                    refresh = 100,
                    seed = SEED,
                    control = list(adapt_delta = 0.80,
                             max_treedepth = 10),
                    file_refit = "on_change",
                    file = here::here("Output/Chapter-Minority/m.t1"),
                    backend = "cmdstanr")

}
)

```


```{r minority-people-base}
#### People ####

job::job(import = "auto", "m.p1" = {

  Sys.setlocale('LC_ALL','C') # Have to add this for Mac for some reason?

ITER <- 2000
WARMUP <-  1000
CORES <- 8
CHAINS <- 4
SEED <- 123

PRIOR.P.BASE <- PRIOR.P %>% 
  filter(grepl(".*minority.*", coef))

m.p1 <- brm(american_p_cat ~ minority +
              (1 |r| country),
                    family = categorical(link = "logit", refcat = "neutral"),
                    data = o.data,
                    prior = PRIOR.P.BASE,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    threads = threading(threads = 2),
                    refresh = 100,
                    seed = SEED,
                    control = list(adapt_delta = 0.80,
                             max_treedepth = 10),
                    file_refit = "on_change",
                    file = here::here("Output/Chapter-Minority/m.p1"),
                    save_model = here::here("Output/Chapter-Minority/m.p1.stan"),
                    backend = "cmdstanr")
}
)

```


```{r minority-government-base}

#### Government ####

job::job(import = "auto", "m.g1" = {

  Sys.setlocale('LC_ALL','C') # Have to add this for Mac for some reason?

ITER <- 2500
WARMUP <-  1000
CORES <- 8
CHAINS <- 4
SEED <- 123

PRIOR.G.BASE <- PRIOR.G %>% 
  filter(grepl(".*minority.*", coef))

m.g1 <- brm(american_g_cat ~ minority +
              (1 |r| country),
                    family = categorical(link = "logit", refcat = "neutral"),
                    data = o.data,
                    prior = PRIOR.G.BASE,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    threads = threading(threads = 2),
                    refresh = 100,
                    seed = SEED,
                    control = list(adapt_delta = 0.80,
                             max_treedepth = 10),
                    file_refit = "on_change",
                    file = here::here("Output/Chapter-Minority/m.g1"),
                    save_model = here::here("Output/Chapter-Minority/m.g1.stan"),
                    backend = "cmdstanr")
}
)


```


## Demographic and attitudinal models

```{r Full Models with demographic and attitudinal variables, echo = FALSE}

# Conflicted pckage really fucks things up
# 
job::job(import = "auto", m.t2 = {

ITER <- 3000
WARMUP <-  800
CORES <- 4
CHAINS <- 4
SEED <- 123

#### Troops  ####
m.t2 <- brm(troops_1_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 |r| country),
                    family = categorical(link = "logit", refcat = "neutral"),
                    data = o.data,
                    prior = PRIOR.T,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
                    file_refit = "on_change",
                    save_model = here::here("Output/Chapter-Minority/m.t2.stan"),
                    file = here::here("Output/Chapter-Minority/m.t2"),
                    control = list(adapt_delta = 0.82,
                                   max_treedepth = 12),
                    backend = "cmdstanr")

}
)

```


```{r people}

job::job(import = "auto", m.p2 = {

ITER <- 3000
WARMUP <-  1000
CORES <- 4
CHAINS <- 4
SEED <- 123

#### People ####
m.p2 <- brm(american_p_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 |r| country),
                    family = categorical(link = "logit", refcat = "neutral"),
                    data = o.data,
                    prior = PRIOR.P,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
                    file_refit = "on_change",
                    save_model = here::here("Output/Chapter-Minority/m.p2.stan"),
                    file = here::here("Output/Chapter-Minority/m.p2"),
                    control = list(adapt_delta = 0.80,
                                   max_treedepth = 10),
                    backend = "cmdstanr")

}
)

```


```{r government}

#### Government ####

job::job(import = "auto", m.g2 = {

ITER <- 4000
WARMUP <-  2000
CORES <- 4
CHAINS <- 4
SEED <- 123


m.g2 <- brm(american_g_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z +
            (1 |r| country),
                    family = categorical(link = "logit", refcat = "neutral"),
                    data = o.data,
                    prior = PRIOR.G,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    threads = threading(threads = 2),
                    thin = 1,
                    seed = SEED,
                    file_refit = "on_change",
                    save_model = here::here("Output/Chapter-Minority/m.g2.stan"),
                    file = here::here("Output/Chapter-Minority/m.g2"),
            control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
            backend = "cmdstanr")

}
)

```


## Demographic and Attitudinal Models w/ Varying Slopes

```{r troops, echo = FALSE}

job::job(import = "auto", m.t3 = {

ITER <- 5000
WARMUP <-  2000
CORES <- 4
CHAINS <- 4
SEED <- 123

tic()
#### Troops  ####
m.t3 <- brm(troops_1_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 + minority |r| country),
                    family = categorical(link = "logit", refcat = "neutral"),
                    data = o.data,
                    prior = PRIOR.T,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    file_refit = "on_change",
                    thin = 1,
                    seed = SEED,
                    save_model = here::here("Output/Chapter-Minority/m.t3.stan"),
                    file = here::here("Output/Chapter-Minority/m.t3"),
            control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
            backend = "cmdstanr")

}
)

```


```{r government, echo = FALSE}

job::job(import = "auto", m.g3 = {
  
  ITER <- 5000
  WARMUP <-  2000
  CORES <- 8 
  CHAINS <- 4
  SEED <- 123
  
  tic()
  #### Troops  ####
  m.g3 <- brm(american_g_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                (1 + minority |r| country),
              family = categorical(link = "logit", refcat = "neutral"),
              data = o.data,
              prior = PRIOR.G,
              iter = ITER,
              warmup = WARMUP,
              cores = CORES,
              chains = CHAINS,
              seed = SEED,
              threads = threading(threads = 2),
              file_refit = "on_change",
              thin = 1,
              save_model = here::here("Output/Chapter-Minority/m.g3.stan"),
              file = here::here("Output/Chapter-Minority/m.g3"),
              control = list(adapt_delta = 0.80,
                             max_treedepth = 10),
              backend = "cmdstanr")
  
}
)

```


```{r people, echo = FALSE}

job::job(import = "auto", m.p3 = {
  
  ITER <- 5000
  WARMUP <-  2000
  CORES <- 4
  CHAINS <- 4
  SEED <- 123
  
  #### Troops  ####
  m.p3 <- brm(american_p_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                (1 + minority |r| country),
              family = categorical(link = "logit", refcat = "neutral"),
              data = o.data,
              prior = PRIOR.P,
              iter = ITER,
              warmup = WARMUP,
              cores = CORES,
              chains = CHAINS,
              file_refit = "on_change",
              thin = 1,
              seed = SEED,
              save_model = here::here("Output/Chapter-Minority/m.p3.stan"),
              file = here::here("Output/Chapter-Minority/m.p3"),
              control = list(adapt_delta = 0.80,
                             max_treedepth = 10),
              backend = "cmdstanr")
  
}
)
```




## Interaction with contact

```{r troops, echo = FALSE}


job::job(import = "auto", m.t4 = {
#### Troops  ####

ITER <- 2000
WARMUP <-  1000
CORES <- 4
CHAINS <- 4
SEED <- 123

m.t4 <- brm(troops_1_cat ~ minority + minority:contact_pers + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 |r| country),
                    family = categorical(link = "logit", refcat = "neutral"),
                    data = o.data,
                    prior = PRIOR.T,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
                    file_refit = "on_change",
                    save_model = here::here("Output/Chapter-Minority/m.t4.stan"),
                    file = here::here("Output/Chapter-Minority/m.t4"),
                    control = list(adapt_delta = 0.83,
                                          max_treedepth = 13),
            backend = "cmdstanr")
}
)

```


```{r people}

job::job(import = "auto", m.p4 = {
  #### Troops  ####
  
  ITER <- 2000
  WARMUP <-  1000
  CORES <- 4
  CHAINS <- 4
  SEED <- 123
  
  m.p4 <- brm(american_p_cat ~ minority + minority:contact_pers + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                (1 |r| country),
              family = categorical(link = "logit", refcat = "neutral"),
              data = o.data,
              prior = PRIOR.P,
              iter = ITER,
              warmup = WARMUP,
              cores = CORES,
              chains = CHAINS,
              thin = 1,
              seed = SEED,
              file_refit = "on_change",
              save_model = here::here("Output/Chapter-Minority/m.p4.stan"),
              file = here::here("Output/Chapter-Minority/m.p4"),
              control = list(adapt_delta = 0.83,
                             max_treedepth = 13),
              backend = "cmdstanr")
}
)

```


```{r government}
#### Government ####

job::job(import = "auto", m.g4 = {
  #### Troops  ####
  
ITER <- 2500
WARMUP <-  1000
CORES <- 4
CHAINS <- 4
SEED <- 123
  
  m.g4 <- brm(american_g_cat ~ minority + minority:contact_pers + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                (1 |r| country),
              family = categorical(link = "logit", refcat = "neutral"),
              data = o.data,
              prior = PRIOR.G,
              iter = ITER,
              warmup = WARMUP,
              cores = CORES,
              chains = CHAINS,
              thin = 1,
              seed = SEED,
              file_refit = "on_change",
              save_model = here::here("Output/Chapter-Minority/m.g4.stan"),
              file = here::here("Output/Chapter-Minority/m.g4"),
              control = list(adapt_delta = 0.83,
                             max_treedepth = 12),
              backend = "cmdstanr")
}
)
```



## Interaction with contact varying effect

```{r troops, echo = FALSE}

job::job(import = "auto", m.t5 = {

ITER <- 3000
WARMUP <-  1000
CORES <- 4
CHAINS <- 4
SEED <- 123

#### Troops  ####

m.t5 <- brm(troops_1_cat ~ minority + minority:contact_pers + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 + minority + minority:contact_pers + contact_pers |r| country),
                    data = o.data,
                    family = categorical(link = "logit", refcat = "neutral"),
                    prior = PRIOR.T,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    refresh = 100,
                    thin = 1,
                    seed = SEED,
                    file_refit = "on_change",
                    save_model = here::here("Output/Chapter-Minority/m.t5.stan"),
                    file = here::here("Output/Chapter-Minority/m.t5"),
            control = list(adapt_delta = 0.82,
                                          max_treedepth = 12),
            backend = "cmdstanr")

}
)

```


```{r people}

job::job(import = "auto", m.p5 = {
  
  ITER <- 3000
  WARMUP <-  1000
  CORES <- 4
  CHAINS <- 4
  SEED <- 123
  
  #### Troops  ####
  
  m.p5 <- brm(american_p_cat ~ minority + minority:contact_pers + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                (1 + minority + minority:contact_pers + contact_pers |r| country),
              data = o.data,
              family = categorical(link = "logit", refcat = "neutral"),
              prior = PRIOR.P,
              iter = ITER,
              warmup = WARMUP,
              cores = CORES,
              chains = CHAINS,
              refresh = 100,
              thin = 1,
              seed = SEED,
              file_refit = "on_change",
              save_model = here::here("Output/Chapter-Minority/m.p5.stan"),
              file = here::here("Output/Chapter-Minority/m.p5"),
              control = list(adapt_delta = 0.82,
                             max_treedepth = 12),
              backend = "cmdstanr")
  
}
)

```


```{r government}

job::job(import = "auto", m.g5 = {
  
  ITER <- 4000
  WARMUP <-  2000
  CORES <- 4
  CHAINS <- 4
  SEED <- 123
  
  #### Troops  ####
  
  m.g5 <- brm(american_g_cat ~ minority + minority:contact_pers + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                (1 + minority + minority:contact_pers + contact_pers |r| country),
              data = o.data,
              family = categorical(link = "logit", refcat = "neutral"),
              prior = PRIOR.G,
              iter = ITER,
              warmup = WARMUP,
              cores = CORES,
              chains = CHAINS,
              refresh = 100,
              thin = 1,
              seed = SEED,
              file_refit = "on_change",
              save_model = here::here("Output/Chapter-Minority/m.g5.stan"),
              file = here::here("Output/Chapter-Minority/m.g5"),
              control = list(adapt_delta = 0.82,
                             max_treedepth = 11),
              backend = "cmdstanr")
  
}
)


```



## Japan only models

### Varying minority model
```{r troops}


job::job(import = "auto", m.t4.japan = {
  
# Change priors to reflect province grouping rather than country
PRIOR.T.PROV <- PRIOR.T %>% 
  mutate(group = ifelse(group == "country", "province", group))

ITER <- 5000
WARMUP <-  2500
CORES <- 4
CHAINS <- 4
SEED <- 123

#### Troops  ####

m.t4.japan <- brm(troops_1_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 + minority |r| province),
                    data = o.data %>% filter(country == "Japan"),
                    family = categorical(link = "logit", refcat = "neutral"),
                    prior = PRIOR.T.PROV,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    refresh = 100,
                    thin = 1,
                    seed = SEED,
                    file_refit = "on_change",
                    save_pars = save_pars(all = TRUE),
                    save_model = here::here("Output/Chapter-Minority/m.t4.japan.stan"),
                    file = here::here("Output/Chapter-Minority/m.t4.japan"),
            control = list(adapt_delta = 0.92,
                                          max_treedepth = 11),
            backend = "cmdstanr")

}
)

```


```{r people}

#### People ####

job::job(import = "auto", m.p4.japan = {
  
  # Change priors to reflect province grouping rather than country
  PRIOR.P.PROV <- PRIOR.P %>% 
    mutate(group = ifelse(group == "country", "province", group))
  
  ITER <- 5000
  WARMUP <-  2500
  CORES <- 4
  CHAINS <- 4
  SEED <- 123
  
  #### Troops  ####
  
  m.p4.japan <- brm(american_p_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                      (1 + minority |r| province),
                    data = o.data %>% filter(country == "Japan"),
                    family = categorical(link = "logit", refcat = "neutral"),
                    prior = PRIOR.P.PROV,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    refresh = 100,
                    thin = 1,
                    seed = SEED,
                    file_refit = "on_change",
                    save_pars = save_pars(all = TRUE),
                    save_model = here::here("Output/Chapter-Minority/m.p4.japan.stan"),
                    file = here::here("Output/Chapter-Minority/m.p4.japan"),
                    control = list(adapt_delta = 0.92,
                                   max_treedepth = 11),
                    backend = "cmdstanr")
  
}
)

```


```{r government}

#### Government ####

job::job(import = "auto", m.g4.japan = {
  
  # Change priors to reflect province grouping rather than country
  PRIOR.G.PROV <- PRIOR.G %>% 
    mutate(group = ifelse(group == "country", "province", group))
  
  ITER <- 5000
  WARMUP <-  2500
  CORES <- 4
  CHAINS <- 4
  SEED <- 123
  
  #### Troops  ####
  
  m.g4.japan <- brm(american_g_cat ~ minority + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                      (1 + minority |r| province),
                    data = o.data %>% filter(country == "Japan"),
                    family = categorical(link = "logit", refcat = "neutral"),
                    prior = PRIOR.G.PROV,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    refresh = 100,
                    thin = 1,
                    seed = SEED,
                    file_refit = "on_change",
                    save_pars = save_pars(all = TRUE),
                    save_model = here::here("Output/Chapter-Minority/m.g4.japan.stan"),
                    file = here::here("Output/Chapter-Minority/m.g4.japan"),
                    control = list(adapt_delta = 0.92,
                                   max_treedepth = 11),
                    backend = "cmdstanr")
  
}
)

```


### Varying interaction models


```{r Japan Only interaction}
# Conflicted pckage really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)


VAGUEPRIOR <- c(set_prior("normal(0, 1)", class = "b"),
                set_prior("normal(0, 5)", class = "Intercept"))

ITER <- 1000
WARMUP <-  500
CORES <- 4
CHAINS <- 4
SEED <- 123

tic()
#### Troops  ####


m.t5.japan <- brm(troops_1_cat ~ minority + minority:contact_pers + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 + minority + minority:contact_pers + contact_pers |r| province),
                    data = o.data %>% filter(country == "Japan"),
                    prior = VAGUEPRIOR,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
                    file = here::here("Output/Chapter-Minority/m.t5.japan"),
                    family = categorical(link = "logit", refcat = "neutral"),
            control = list(adapt_delta = 0.83,
                                          max_treedepth = 13),
            backend = "cmdstanr")


toc()

tic()

#### People ####
m.p5.japan <- brm(american_p_cat ~ minority + minority:contact_pers + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
            (1 + minority + minority:contact_pers + contact_pers |r| province),
                    data = o.data %>% filter(country == "Japan"),
                    prior = VAGUEPRIOR,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
                    file = here::here("Output/Chapter-Minority/m.p5.japan"),
                    family = categorical(link = "logit", refcat = "neutral"),
            control = list(adapt_delta = 0.83,
                                          max_treedepth = 13),
            backend = "cmdstanr")

toc()

tic()

#### Government ####


m.g5.japan <- brm(american_g_cat ~ minority + minority:contact_pers + age + ed_z + ideology_z + income.5.cat + gender + contact_pers + benefit_pers + troops_crime_pers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z +
            (1 + minority + minority:contact_pers + contact_pers |r| province),
                    data = o.data %>% filter(country == "Japan"),
                    prior = VAGUEPRIOR,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
                    file = here::here("Output/Chapter-Minority/m.g5.japan"),
                    family = categorical(link = "logit", refcat = "neutral"),
            control = list(adapt_delta = 0.83,
                                          max_treedepth = 13),
            backend = "cmdstanr")

toc()

```


# Figures

## Minority Only Models

```{r Figure: Minority Only}

# Read in model files
m.t1 <- readRDS(here::here("Output/Chapter-Minority/m.t1.rds"))
m.p1 <- readRDS(here::here("Output/Chapter-Minority/m.p1.rds"))
m.g1 <- readRDS(here::here("Output/Chapter-Minority/m.g1.rds"))

mod.list <- list("US Presence" = m.t1,
                 "US People" = m.p1,
                 "US Government" = m.g1)

figs.list <- lapply(mod.list, function(x) {
  temp <- x %>% 
    gather_draws(b_mupos_minorityYes,
                 b_muneg_minorityYes,
                 b_mudk_minorityYes) 

}
)

fig.com <- data.table::rbindlist(figs.list, idcol = TRUE) %>% 
  mutate(.variable = ifelse(grepl(".*pos.*", .variable), "Positive",
                            ifelse(grepl(".*neg", .variable), "Negative", "Don't know/Decline"))) %>% 
  mutate(.id = factor(.id, levels = c("US Presence", "US Government", "US People"))) %>% 
  filter(!grepl(".*on't.*", .variable))

# Note this uses the HDI instead of the QI
ggplot(fig.com, aes(x = .value, y = .variable, fill = .id)) +
  ggdist::stat_halfeye(point_interval = median_hdi, .width = c(0.50, 0.80, 0.95), interval_size_range = c(0.75, 2.25, 3.5, 4.75),  alpha = 0.8) +
  geom_vline(xintercept = 0, color = "black", size = 1.1) +
  facet_wrap(. ~ .id) +
  theme_flynn() +
  theme(plot.title.position = "plot",
        panel.spacing = unit(0.3, "cm"),
        axis.text = element_text(size = basesize * 1.1),
        axis.title = element_text(size = basesize * 1.2),
        strip.text = element_text(size = basesize * 1.2),
        plot.title = element_text(size = basesize * 1.4)) +
  viridis::scale_fill_viridis(option = "magma", begin = 0.4, end = 0.4, discrete = TRUE) +
  guides(fill = "none") +
  labs(x = "Coefficient Estimate",
       y = "Response",
       title = "Minority self-identification and attitudes towards US actors")

ggsave(here("Figures/Chapter-Minority/fig-coefplot-base.png"), height = 5, width = 7, units = "in")
ggsave(here("Figures/Chapter-Minority/fig-coefplot-base.jpg"), height = 5, width = 7, units = "in")

```


## Minority with full controls

```{r Figures: Minority and Controls}


m.t2.fig <- m.t2 %>% 
  gather_draws(b_muneg_minorityYes,
               b_mupos_minorityYes,
               b_mudk_minorityYes) %>% 
  mutate(model = "U.S. Troops")

m.p2.fig <- m.p2 %>% 
  gather_draws(b_muneg_minorityYes,
               b_mupos_minorityYes,
               b_mudk_minorityYes) %>% 
  mutate(model = "U.S. People")

m.g2.fig <- m.g2 %>% 
  gather_draws(b_muneg_minorityYes,
               b_mupos_minorityYes,
               b_mudk_minorityYes) %>% 
  mutate(model = "U.S. Government")

fig.com <- bind_rows(m.t2.fig, m.g2.fig, m.p2.fig) %>% 
  mutate(model = factor(model, levels = c("U.S. Troops", "U.S. Government", "U.S. People")),
         equation = case_when(
           .variable = grepl(".*muneg_minorityYes.*", .variable) ~ "Negative\nViews", 
           .variable = grepl(".*mupos.*", .variable) ~ "Positive\nViews",
           .variable = grepl(".*mudk.*", .variable) ~ "Don't know\nDecline"))


# Note this  uses the HDI
ggplot(fig.com, aes(x = .value, y = equation)) +
  stat_halfeye(point_interval = median_hdi, .width = c(0.5, 0.89, 0.95), interval_size_range = c(0.75, 2.25, 3.5, 4.75), position = ggstance::position_dodgev(height = 0.35), alpha = 0.8, fill = "dodgerblue1") +
  geom_vline(xintercept = 0, color = "red") +
  facet_wrap(. ~ model) +
  scale_color_brewer(palette = "Set1") +
  theme_flynn() +
  theme(plot.title.position = "plot" ) +
  labs(x = "Coefficient estimate",
       y = "",
       color = "Response/\nEquation",
       title = "Minority self-identification and views of U.S. actors")

ggsave(here("/Figures/Chapter-Minority/fig-coefplot-full.png"), height = 5, width = 8, units = "in")
ggsave(here("/Figures/Chapter-Minority/fig-coefplot-full.jpg"), height = 5, width = 8, units = "in")

```


## Minority full with other coefficients

```{r Figures: Minority and Controls}

# Read in model files
m.t2 <- readRDS(here::here("Output/Chapter-Minority/m.t2.rds"))
m.p2 <- readRDS(here::here("Output/Chapter-Minority/m.p2.rds"))
m.g2 <- readRDS(here::here("Output/Chapter-Minority/m.g2.rds"))

mod.list <- list("US Presence" = m.t2,
                 "US People" = m.p2,
                 "US Government" = m.g2)

m.fig.controls <- lapply(mod.list, function(x) {

temp <- x %>% 
  gather_draws(b_mupos_ed_z,
               b_muneg_minorityYes,
               b_mupos_minorityYes,
               `b_mupos_income.5.cat21M40%`,
               `b_mupos_income.5.cat41M60%`,
               `b_mupos_income.5.cat61M80%`,
               `b_mupos_income.5.cat81M100%`,
               b_mupos_age25to34years,
               b_mupos_age35to44years,
               b_mupos_age45to54years,
               b_mupos_age55to64years,
               b_mupos_ageAge65orolder,
               b_mupos_genderFemale,
               b_mupos_genderNonMbinary,
               b_mupos_genderNoneoftheabove,
               b_mupos_genderFemale,
               b_mupos_genderNonMbinary,
               b_mupos_genderNoneoftheabove,
               b_muneg_ed_z,
               `b_muneg_income.5.cat21M40%`,
               `b_muneg_income.5.cat41M60%`,
               `b_muneg_income.5.cat61M80%`,
               `b_muneg_income.5.cat81M100%`,
               b_muneg_age25to34years,
               b_muneg_age35to44years,
               b_muneg_age45to54years,
               b_muneg_age55to64years,
               b_muneg_ageAge65orolder,
               b_muneg_genderFemale,
               b_muneg_genderNonMbinary,
               b_muneg_genderNoneoftheabove,
               b_muneg_genderFemale,
               b_muneg_genderNonMbinary,
               b_muneg_genderNoneoftheabove) 

}
)

fig.com.controls <- data.table::rbindlist(m.fig.controls, idcol = TRUE) %>% 
  mutate(.id = factor(.id, levels = c("US Presence", "US Government", "US People")),
         equation = case_when(
           .variable = grepl(".*muneg.*", .variable) ~ "Negative", 
           .variable = grepl(".*mupos.*", .variable) ~ "Positive",
           .variable = grepl(".*mudk.*", .variable) ~ "Don't know\nDecline"),
         .variable = case_when(
           .variable = grepl("ed_z", .variable) ~ "Education",
           .variable = grepl("income.5.cat21M40%", .variable) ~ "Income: 21%-40%",
           .variable = grepl("income.5.cat41M60%", .variable) ~ "Income: 41%-60%",
           .variable = grepl("income.5.cat61M80%", .variable) ~ "Income: 61%-80%",
           .variable = grepl("income.5.cat81M100%", .variable) ~ "Income: 81%-100%",
           .variable = grepl("minorityYes", .variable) ~ "Minority: Yes",
           .variable = grepl("age25to34years", .variable) ~ "Age: 25-34",
           .variable = grepl("age35to44years", .variable) ~ "Age: 35-44",
           .variable = grepl("age45to54years", .variable) ~ "Age: 45-54",
           .variable = grepl("age55to64years", .variable) ~ "Age: 55-64",
           .variable = grepl("ageAge65orolder", .variable) ~ "Age: 65 or older",
           .variable = grepl("genderFemale", .variable) ~ "Gender: Female",
           .variable = grepl("genderNonMbinary", .variable) ~ "Gender: Non-binary",
           .variable = grepl("genderNoneoftheabove", .variable) ~ "Gender: None of the above"
         ),
         vargroup = case_when(
           vargroup = grepl("Minority", .variable) ~ "Minority",
           vargroup = grepl("Income", .variable) ~ "Income",
           vargroup = grepl("Age", .variable) ~ "Age",
           vargroup = grepl("Gender", .variable) ~ "Gender",
           vargroup = grepl("Education", .variable) ~ "Education"
         ),
           .variable = gsub("Minority: ", "", .variable),
           .variable = gsub("Income: ", "", .variable),
           .variable = gsub("Age: ", "", .variable),
           .variable = gsub("Gender: ", "", .variable)
         ) %>% 
  filter(!grepl(".*None.*", .variable))
         


# Note this  uses the HDI
ggplot(fig.com.controls, aes(x = .value, y = .variable, color = equation)) +
  ggdist::stat_pointinterval(.width = c(0.5, 0.8, 0.95), position = position_dodge(width = 0.60), interval_size_range = c(1.0, 1.5, 2.0), fatten_point = 1.2) +
  geom_vline(xintercept = 0, color = "black", size = 1.1) +
  facet_grid(vargroup ~ .id, scales = "free_y", switch = "y") +
  viridis::scale_color_viridis(discrete = TRUE, direction = -1, begin = 0.1, end = 0.6, option = "magma") +
  theme_flynn() +
  theme(plot.title.position = "plot",
        strip.placement = "outside",
        strip.background.y = element_rect(fill = "white", linetype = 0),
        strip.text = element_text(size = basesize * 1.2),
        axis.title.x = element_text(size = basesize * 1.2),
        panel.spacing = unit(0, "cm"),
        axis.text.y = element_text(size = basesize*1.1),
        axis.text.x = element_text(size = basesize*1.1),
        legend.title = element_text(size = basesize * 1.1, margin = margin(b = -0.0, unit = "cm")),
        legend.text = element_text(size = basesize * 1.1, margin = margin(l = -0.2, unit = "cm")),
        legend.position = "bottom",
        plot.title = element_text(size = basesize * 1.5)) +
  guides(color = guide_legend(reverse = TRUE)) +
  labs(x = "Coefficient estimate",
       y = "",
       color = "Response",
       title = "Minority self-identification and views of US actors")

ggsave(here("Figures/Chapter-Minority/fig-coefplot-full.controls.png"), height = 6, width = 8, units = "in")
ggsave(here("Figures/Chapter-Minority/fig-coefplot-full.controls.jpg"), height = 6, width = 8, units = "in")

```



## Minority with varying intercepts

```{r Figure Minority Varying Coefficient}

# Read in model files
m.t3 <- readRDS(here::here("Output/Chapter-Minority/m.t3.rds"))
m.p3 <- readRDS(here::here("Output/Chapter-Minority/m.p3.rds"))
m.g3 <- readRDS(here::here("Output/Chapter-Minority/m.g3.rds"))

mod.list <- list("US Presence" = m.t3,
                 "US People" = m.p3,
                 "US Government" = m.g3)

fig.list <- lapply(mod.list, function(x) {

 # Troops
    temp <- x %>% 
      spread_draws(r_country__mupos[country, minorityYes],
                   r_country__muneg[country, minorityYes],
                   b_mupos_minorityYes,
                   b_muneg_minorityYes) %>% 
      filter(minorityYes == "minorityYes") %>% 
      mutate(pos_yes = b_mupos_minorityYes + r_country__mupos,
             neg_yes = b_muneg_minorityYes + r_country__muneg) %>% 
      pivot_longer(cols = c(pos_yes, neg_yes),
                   names_to = "equation",
                   values_to = "effect") %>% 
      dplyr::select(country, equation, effect) %>% 
      mutate(equation = factor(equation, levels = c("pos_yes", "neg_yes"), labels = c("Positive View", "Negative View")))
    
}
)


fig.varyingcoefficient <- data.table::rbindlist(fig.list, idcol = TRUE) %>% 
  mutate(.id = factor(.id, levels = c("US Presence", "US Government", "US People")),
         country = gsub("\\.", " ", country))


ggplot(fig.varyingcoefficient, aes(x = effect, y = country, group = equation, color = equation)) + 
  stat_pointinterval(.width = c(0.50, 0.80, 0.95), 
                     stat = median_hdi,
                     position = position_dodge(width = 0.5)) +
  geom_vline(xintercept = 0, color = "red", width = 1.0) +
  facet_wrap(. ~ .id) +
  theme_flynn() +
  theme(plot.title.position = "plot",
        plot.title = element_text(size = basesize * 1.6),
        legend.position = "bottom",
        legend.text = element_text(size = basesize * 1.2, margin = margin(l = -0.4, unit = "cm")),
        legend.key.height = unit(0.7, "cm"),
        legend.key.size = unit(1, "cm"),
        legend.title = element_text(size = basesize * 1.2, margin = margin(b = -0.0, unit = "cm")),
        axis.text.x = element_text(size = basesize * 1.1),
        axis.text.y = element_text(size = basesize * 1.1),
        axis.title.x = element_text(size = basesize * 1.1)) +
  viridis::scale_color_viridis(discrete = TRUE, option = "magma", begin = 0.1, end = 0.6) +
  labs(x = "Coefficient Estimate",
       y = "",
       title = "Minority Self-Identification Across Countries",
       color = "Response")
  
ggsave(here("Figures/Chapter-Minority/fig-coefplot-varying.png"), height = 5.5, width = 8, units = "in")
ggsave(here("Figures/Chapter-Minority/fig-coefplot-varying.jpg"), height = 5.5, width = 8, units = "in")


# Posterior calculations
 
bayestestR::p_direction(fig.varyingcoefficient$effect[fig.varyingcoefficient$country=="Belgium" & 
                                                        fig.varyingcoefficient$.id=="US Government" & 
                                                        fig.varyingcoefficient$equation=="Negative View"])


```


## Interaction Prediction population level

```{r Figure Minority Varying Coefficient}

# Read in model files
m.t5 <- readRDS(here::here("Output/Chapter-Minority/m.t5.rds"))
m.p5 <- readRDS(here::here("Output/Chapter-Minority/m.p5.rds"))
m.g5 <- readRDS(here::here("Output/Chapter-Minority/m.g5.rds"))

mod.list <- list("US Presence" = m.t5,
                 "US People" = m.p5,
                 "US Government" = m.g5)

# Values set to typical values found in Japan
newdata <- expand_grid(country = "Germany",
                         contact_pers= c("Yes", "No"),
                         minority = c("Yes", "No"),
                         benefit_pers = "No",
                         contact_nonpers = "No",
                         benefit_nonpers = "No",
                         troops_crime_pers = "No",
                         age = "45 to 54 years",
                         ed_z = mean(o.data$ed_z[o.data$country=="Germany"], na.rm = TRUE),
                         ideology_z = mean(o.data$ideology_z[o.data$country=="Germany"], na.rm = TRUE),
                         income.5.cat = "41-60%",
                         relig = "Catholicism",
                         gender = "Female",
                         american_inf_1 = "Some",
                         american_inf_2 = "Neither positive nor negative",
                         basecount_z = mean(o.data$basecount_z[o.data$country=="Germany"], na.rm = TRUE),
                         gdp_z = mean(o.data$gdp_z[o.data$country=="Germany"], na.rm = TRUE),
                         pop_z = mean(o.data$pop_z[o.data$country=="Germany"], na.rm = TRUE),
                         troops_z = mean(o.data$troops_z[o.data$country=="Germany"], na.rm = TRUE))


tidy.pred <- lapply(mod.list, function(x) {
  
  temp.1 <- x %>% 
    epred_draws(newdata = newdata,
              re_forumla = ~(1 + minority + minority:contact_pers + contact_pers | r | country) ,
              seed = 123) %>% 
    filter(grepl("pos|neg", .category))

}
)

tidy.pred.df <- data.table::rbindlist(tidy.pred, idcol = TRUE) %>% 
  mutate(grouping = glue::glue("Minority: {minority}, Personal Contact: {contact_pers}")) %>% 
  dplyr::filter(grouping == "Minority: No, Personal Contact: No" |
                  grouping == "Minority: Yes, Personal Contact: No" |
                  grouping == "Minority: No, Personal Contact: Yes" |
                  grouping == "Minority: Yes, Personal Contact: Yes") %>% 
  mutate(grouping = factor(grouping, levels = c("Minority: Yes, Personal Contact: Yes",
                                                "Minority: Yes, Personal Contact: No",
                                                "Minority: No, Personal Contact: Yes",
                                                "Minority: No, Personal Contact: No")),
         .id = factor(.id, levels = c("US Presence", "US Government", "US People")),
         .category = factor(.category, levels = c("pos", "neg"), 
                            labels = c("Positive", "Negative")))



# Collapse posteriors into vectors to explore overlaps
overlap.compare <- tidy.pred.df %>% 
  dplyr::select(c(.id, country, .epred, grouping, .category)) %>% 
  pivot_wider(id_cols = c(.id, country, grouping, .epred, .category),
              names_from = c(.id, .category, grouping),
              values_from = .epred) %>% 
  unnest()

# Nice and neat People
test <- bayestestR::overlap(x = overlap.compare$`US Government_Negative_Minority: No, Personal Contact: No`,
                            y = overlap.compare$`US Government_Negative_Minority: Yes, Personal Contact: Yes`)

test
# This is how you pull the actual data frame of the distribution and overlapping values.
#test <- as.data.frame(attributes(test)$data)
  


ggplot(tidy.pred.df, aes(y = grouping, x = .epred, color = grouping, fill = grouping)) +
  stat_slab(.width = c(0.50, 0.80, 0.95), stroke = 0.1, position = position_dodge(width = 0.0), slab_alpha = 0.7, scale = 1.3)  +
  stat_pointinterval(.width = c(0.50, 0.80, 0.95), position = position_dodge(width = 0.0), show.legend = FALSE)  +
  geom_vline(xintercept = 0, size = 1.1, show.legend = FALSE) +
  viridis::scale_fill_viridis(option = "magma", discrete = TRUE, begin = 0.1, end = 0.9) +
  viridis::scale_color_viridis(option = "magma", discrete = TRUE, begin = 0.1, end = 0.9) +
  scale_y_discrete(expand = c(0, 0)) +
  theme_flynn() +
  theme(panel.border = element_rect(size = 0.2),
        plot.title = element_text(size = basesize*1.6),
        strip.background = element_rect(size = 0.2),
        strip.text = element_text(size = basesize*1.4),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = basesize * 1.3),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = basesize * 1.3),
        legend.title = element_text(size = basesize*1.5, margin = margin(b = -0, unit = "cm")),
        legend.position = "bottom",
        legend.box = "vertical",
        legend.text = element_text(size = basesize*1.3, margin = margin(l = -0.5, unit = "cm")),
        panel.spacing = unit(0.3, "cm")) +
  guides(fill = guide_legend(nrow = 4, reverse = TRUE),
         interval_size = "none",
         interval_shape = "none",
         interval_alpha = "none",
         interval_linetype = "none",
         interval_color = "none",
         color = "none") +
  facet_grid(.category ~ .id ) +
  labs(x = "Predicted Probability",
       y = "",
       fill = "Experience",
       title = "Predicted Probabilities of Expressing Positive and Negative Attitudes in Germany")

ggsave(here::here("Figures/Chapter-Minority/figure-expected-conditional.jpg"), height = 7, width = 8, units = "in")
       
country.pd <- tidy.pred.df %>% 
    dplyr::group_by(grouping, .id, .category) %>% 
    dplyr::summarise(median = median(.epred),
                     pd = paste0(bayestestR::pd(.epred))) %>% 
  dplyr::select(.id, grouping, .category, median, pd) %>% 
  arrange(.id, grouping, .category)
       
```



```{r Cross-national change in predicted probabilities}

# Read in model files
# Read in model files
m.t5 <- readRDS(here::here("Output/Chapter-Minority/m.t5.rds"))
m.p5 <- readRDS(here::here("Output/Chapter-Minority/m.p5.rds"))
m.g5 <- readRDS(here::here("Output/Chapter-Minority/m.g5.rds"))

mod.list <- list("US Presence" = m.t5,
                 "US People" = m.p5,
                 "US Government" = m.g5)

# Values set to typical values found worldwide
newdata <- expand_grid(country = unique(m.t5$data$country),
                         minority = c("Yes", "No"),
                         contact_pers = "No",
                         benefit_pers = "No",
                         contact_nonpers = "No",
                         benefit_nonpers = "No",
                         troops_crime_pers = "No",
                         age = "45 to 54 years",
                         ed_z = mean(o.data$ed_z, na.rm = TRUE),
                         ideology_z = mean(o.data$ideology_z, na.rm = TRUE),
                         income.5.cat = "41-60%",
                         relig = "Buddhism",
                         gender = "Female",
                         american_inf_1 = "Some",
                         american_inf_2 = "Neither positive nor negative",
                         basecount_z = mean(o.data$basecount_z, na.rm = TRUE),
                         gdp_z = mean(o.data$gdp_z, na.rm = TRUE),
                         pop_z = mean(o.data$pop_z, na.rm = TRUE),
                         troops_z = mean(o.data$troops_z, na.rm = TRUE))


tidy.pred <- lapply(mod.list, function(x) {
  
  temp.1 <- x %>% 
    epred_draws(newdata = newdata,
              re_forumla = ~(1 + minority + minority:contact_pers + contact_pers | r | country),
              seed = 123) %>% 
    filter(grepl("pos|neg", .category)) #%>% 
    #compare_levels(.epred, by = minority)

}
)

# Show group predictions
tidy.pred.df <- data.table::rbindlist(tidy.pred, idcol = TRUE) %>% 
  mutate(grouping = glue::glue("Minority: {minority}")) %>% 
  mutate(.id = factor(.id, levels = c("US Presence", "US Government", "US People")),
         .category = factor(.category, levels = c("pos", "neg"), 
                            labels = c("Positive View", "Negative View")))

# Show difference between group predictions
tidy.pred.df.wide <- tidy.pred.df %>% 
  pivot_wider(id_cols = c(country, .id, .draw, .category),
              names_from = minority,
              values_from = .epred) %>% 
  mutate(difference = Yes-No)


# Collapse posteriors into vectors to explore overlaps
overlap.compare <- tidy.pred.df %>% 
  dplyr::select(c(.id, country, .epred, grouping, .category)) %>% 
  pivot_wider(id_cols = c(.id, country, grouping, .epred, .category),
              names_from = c(.id, .category, grouping),
              values_from = .epred) %>% 
  unnest()

# Nice and neat People
test <- bayestestR::overlap(x = overlap.compare$`US Presence_Negative View_Minority: Yes`,
                            y = overlap.compare$`US Presence_Negative View_Minority: No`)

test
# This is how you pull the actual data frame of the distribution and overlapping values.
#test <- as.data.frame(attributes(test)$data)
  


#### Country Group Differences ####
#### 
ggplot(tidy.pred.df.wide, aes(y = country, x = difference, color = .category)) +
  stat_pointinterval(.width = c(0.50, 0.80, 0.95), position = position_dodge(width = 0.5))  +
  geom_vline(xintercept = 0, size = 1.1, show.legend = FALSE) +
  viridis::scale_color_viridis(option = "magma", discrete = TRUE, begin = 0.1, end = 0.6) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_x_continuous(limits = c(-0.26, 0.2), labels = scales::comma_format()) +
  facet_grid(. ~ .id) +
  theme_flynn() +
  theme(panel.border = element_rect(size = 0.2),
        plot.title = element_text(size = basesize*1.4, lineheight = 0.4),
        plot.title.position = "plot",
        strip.background = element_rect(size = 0.2),
        strip.text = element_text(size = basesize * 1.2),
        axis.text.y = element_text(size = basesize * 1.2),
        axis.text.x = element_text(size = basesize * 1.1),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = basesize * 1.2),
        legend.title = element_text(size = basesize*1.4, margin = margin(t = -0, unit = "cm")),
        legend.position = "bottom",
        legend.box = "vertical",
        legend.text = element_text(size = basesize*1.3, margin = margin(t = 0.0, l = -0.3, unit = "cm")),
        legend.box.margin = margin(t = 0.05, unit = "cm"),
        panel.spacing = unit(0.3, "cm")) +
  guides(color = guide_legend(nrow = 1, reverse = FALSE),
         interval_lour = "none",
         interval_size = "none",
         interval_shape = "none",
         interval_alpha = "none",
         interval_linetype = "none") +
  labs(x = "Change in Predicted Probability",
       y = "",
       color = "Response",
       title = "Change in Predicted Probability of Expressing Positive and Negative Attitudes Across\nCountries According to Minority Status")

ggsave(here::here("Figures/Chapter-Minority/figure-expected-conditional-countries-difference.jpg"), height = 6.5, width = 7, units = "in")
       
#### Japan Posterior Direction Results ####
country.pd <- tidy.pred.df.wide %>% 
    dplyr::group_by(country, .id, .category) %>% 
    dplyr::summarise(median = median(difference),
                     pd = paste0(bayestestR::pd(difference))) %>% 
  dplyr::select(.id, country, .category, median, pd) %>% 
  arrange(.id, country, .category)
```


### Posterior Predictive Checks

```{r posterior predictive checks}

#color_scheme_set(scheme = "blue")
ppcheck.troops <- pp_check(m.t3, nsamples = 1000, type = "bars_grouped", group = "country")
ppcheck.people <- pp_check(m.p3, nsamples = 1000, type = "bars_grouped", group = "country")
ppcheck.gov <- pp_check(m.g3, nsamples = 1000, type = "bars_grouped", group = "country")



ppcheck.troops.plot <- ppcheck.troops +
  theme_flynn() + 
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(1, 2, 3, 4), labels = c("Don't\nknow", "Neg", "Neu", "Pos")) +
  labs(title = "US Presence")


ppcheck.people.plot <- ppcheck.people +
  theme_flynn() + 
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(1, 2, 3, 4), labels = c("Don't\nknow", "Neg", "Neu", "Pos")) +
  labs(title = "US People")


ppcheck.gov.plot <- ppcheck.gov +
  theme_flynn() + 
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(1, 2, 3, 4), labels = c("Don't\nknow", "Neg", "Neu", "Pos")) +
  labs(title = 'US Government')


ppcheck.troops.plot + ppcheck.people.plot + ppcheck.gov.plot +
  plot_layout(guides = "collect") &
  theme_flynn()

ggsave(here("Figures/Chapter-Minority/figure-posterior-predictive-varying.png"), height = 8, width = 18, units = "in")
ggsave(here("Figures/Chapter-Minority/figure-posterior-predictive-varying.jpg"), height = 8, width = 18, units = "in")

```



## Japan Posterior Figures

```{r Coefficient figures for Japan}


# Read in model files
m.t4.japan <- readRDS(here::here("Output/Chapter-Minority/m.t4.japan.rds"))
m.p4.japan <- readRDS(here::here("Output/Chapter-Minority/m.p4.japan.rds"))
m.g4.japan <- readRDS(here::here("Output/Chapter-Minority/m.g4.japan.rds"))

mod.list <- list("US Presence" = m.t4.japan,
                 "US People" = m.p4.japan,
                 "US Government" = m.g4.japan)


fig.list <- lapply(mod.list, function(x) {
    # Troops
    temp <- x %>% 
      spread_draws(r_province__mupos[province, minorityYes],
                   r_province__muneg[province, minorityYes],
                   b_muneg_minorityYes,
                   b_mupos_minorityYes) %>% 
      filter(minorityYes == "minorityYes") %>% 
      mutate(minority.pos = r_province__mupos + b_mupos_minorityYes,
             minority.neg = r_province__muneg + b_muneg_minorityYes) 
    
}
)


fig.com.japan <- rbindlist(fig.list, idcol = TRUE) %>% 
  dplyr::select(province, .id, minority.pos, minority.neg) %>% 
  pivot_longer(cols = c(3,4),
               names_to = "equation") %>% 
  mutate(.id = factor(.id, levels = c("US Presence", "US Government", "US People")),
         equation = case_when(
           grepl("pos", equation) ~ "Positive",
           grepl("neg", equation) ~ "Negative"
         )) %>% 
  filter(!grepl(".*on't.*", equation))



# Note this  uses the HDI
ggplot(fig.com.japan, aes(x = value, y = province, color = equation)) +
  stat_pointinterval(point_interval = median_hdi, .width = c(0.50, 0.80, 0.95), position = ggstance::position_dodgev(height = 0.45)) +
  geom_vline(xintercept = 0, color = "black", size = 1) +
  facet_wrap(. ~ .id) +
  viridis::scale_color_viridis(discrete = TRUE, option = "magma", direction = -1, begin = 0.1, end = 0.6) +
  theme_flynn() +
  guides(color = guide_legend(reverse = TRUE)) +
  theme(plot.title.position = "plot",
        plot.title = element_text(size = basesize * 1.6),
        legend.position = "bottom",
        legend.text = element_text(size = basesize * 1.2, margin = margin(l = -0.4, unit = "cm")),
        legend.key.height = unit(0.7, "cm"),
        legend.key.size = unit(1, "cm"),
        legend.title = element_text(size = basesize * 1.2, margin = margin(b = -0.0, unit = "cm")),
        axis.text.x = element_text(size = basesize * 1.1),
        axis.text.y = element_text(size = basesize * 1.1),
        axis.title.x = element_text(size = basesize * 1.1)) +
  labs(x = "Coefficient Estimate",
       y = "",
       color = "Response",
       title = "Minority Self-Identification and Views of US Actors in Japan")

ggsave(here("Figures/Chapter-Minority/fig-coefplot-2-japan.png"), height = 5, width = 8, units = "in")
ggsave(here("Figures/Chapter-Minority/fig-coefplot-2-japan.jpg"), height = 5, width = 8, units = "in")



#### Japan Posterior Direction Results ####
japan.pd <- fig.com.japan %>% 
    dplyr::group_by(province, .id, equation) %>% 
    dplyr::summarise(median = median(value),
                     pd = paste0(bayestestR::pd(value))) %>% 
  dplyr::select(.id, province, equation, median, pd) %>% 
  arrange(.id, province, equation)
  


```


```{r Japan Expected Values}

# Read in model files
# Read in model files
m.t4.japan <- readRDS(here::here("Output/Chapter-Minority/m.t4.japan.rds"))
m.p4.japan <- readRDS(here::here("Output/Chapter-Minority/m.p4.japan.rds"))
m.g4.japan <- readRDS(here::here("Output/Chapter-Minority/m.g4.japan.rds"))

mod.list <- list("US Presence" = m.t4.japan,
                 "US People" = m.p4.japan,
                 "US Government" = m.g4.japan)

# Values set to typical values found in Japan
newdata <- expand_grid(province = unique(m.t4.japan$data$province),
                         minority = c("Yes", "No"),
                         contact_pers = "No",
                         benefit_pers = "No",
                         contact_nonpers = "No",
                         benefit_nonpers = "No",
                         troops_crime_pers = "No",
                         age = "45 to 54 years",
                         ed_z = mean(o.data$ed_z[o.data$country=="Japan"], na.rm = TRUE),
                         ideology_z = mean(o.data$ideology_z[o.data$country=="Japan"], na.rm = TRUE),
                         income.5.cat = "41-60%",
                         relig = "Buddhism",
                         gender = "Female",
                         american_inf_1 = "Some",
                         american_inf_2 = "Neither positive nor negative",
                         basecount_z = mean(o.data$basecount_z[o.data$country=="Japan"], na.rm = TRUE),
                         gdp_z = mean(o.data$gdp_z[o.data$country=="Japan"], na.rm = TRUE),
                         pop_z = mean(o.data$pop_z[o.data$country=="Japan"], na.rm = TRUE),
                         troops_z = mean(o.data$troops_z[o.data$country=="Japan"], na.rm = TRUE))


tidy.pred <- lapply(mod.list, function(x) {
  
  temp.1 <- x %>% 
    epred_draws(newdata = newdata,
              re_forumla = ~(1 + minority | r | province) ,
              seed = 123) %>% 
    filter(grepl("pos|neg", .category)) #%>% 
    #compare_levels(.epred, by = minority)

}
)

# Show group predictions
tidy.pred.df <- data.table::rbindlist(tidy.pred, idcol = TRUE) %>% 
  mutate(grouping = glue::glue("Minority: {minority}")) %>% 
  mutate(.id = factor(.id, levels = c("US Presence", "US Government", "US People")),
         .category = factor(.category, levels = c("pos", "neg"), 
                            labels = c("Positive Views", "Negative Views")))

# Show difference between group predictions
tidy.pred.df.wide <- tidy.pred.df %>% 
  pivot_wider(id_cols = c(province, .id, .draw, .category),
              names_from = minority,
              values_from = .epred) %>% 
  mutate(difference = Yes-No)


# Collapse posteriors into vectors to explore overlaps
overlap.compare <- tidy.pred.df %>% 
  dplyr::select(c(.id, province, .epred, grouping, .category)) %>% 
  pivot_wider(id_cols = c(.id, province, grouping, .epred, .category),
              names_from = c(.id, .category, grouping),
              values_from = .epred) %>% 
  unnest()

# Nice and neat People
#test <- bayestestR::overlap(x = overlap.compare$`US Government_Positive_Minority: Yes`,
                            #y = overlap.compare$`US Government_Negative_Minority: No`)

#test
# This is how you pull the actual data frame of the distribution and overlapping values.
#test <- as.data.frame(attributes(test)$data)
  

#### Japan Province Group Predictions ####

ggplot(tidy.pred.df, aes(y = .category, x = .epred, color = glue::glue("Response: {.category}, {grouping}"))) +
  stat_pointinterval(.width = c(0.50, 0.80, 0.95), position = position_dodge(width = 0.3))  +
  geom_vline(xintercept = 0, size = 1.1, show.legend = FALSE) +
  viridis::scale_fill_viridis(option = "magma", discrete = TRUE, begin = 0.1, end = 0.9) +
  viridis::scale_color_viridis(option = "magma", discrete = TRUE, begin = 0.1, end = 0.9) +
  scale_y_discrete(expand = c(0, 0)) +
  facet_grid(province ~ .id , switch = "y") +
  theme_flynn() +
  theme(panel.border = element_rect(size = 0.2),
        plot.title = element_text(size = basesize*1.6),
        plot.title.position = "plot",
        strip.background = element_rect(size = 0.2),
        strip.text.y.left = element_text(size = basesize * 1.2, angle = 0, hjust = 0, margin = margin(l = 0.2, r = 0.24, unit = "cm")),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = basesize * 1.1),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = basesize * 1.2),
        legend.title = element_text(size = basesize*1.4, margin = margin(b = -0, unit = "cm")),
        legend.position = "bottom",
        legend.box = "vertical",
        legend.text = element_text(size = basesize*1.3, margin = margin(l = -0.5, unit = "cm")),
        panel.spacing = unit(0.3, "cm")) +
  guides(color = guide_legend(nrow = 4, reverse = FALSE),
         interval_lour = "none",
         interval_size = "none",
         interval_shape = "none",
         interval_alpha = "none",
         interval_linetype = "none") +
  labs(x = "Predicted Probability",
       y = "",
       color = "Experience",
       title = "Predicted Probabilities of Expressing Positive and Negative Attitudes in Japan Regions")

ggsave(here::here("Figures/Chapter-Minority/figure-expected-conditional-japan-province.jpg"), height = 8, width = 7, units = "in")
       

#### Japan Province Group Differences ####
#### 
ggplot(tidy.pred.df.wide, aes(y = province, x = difference, color = .category)) +
  stat_pointinterval(.width = c(0.50, 0.80, 0.95), position = position_dodge(width = 0.5))  +
  geom_vline(xintercept = 0, size = 1.1, show.legend = FALSE) +
  viridis::scale_color_viridis(option = "magma", discrete = TRUE, begin = 0.1, end = 0.6) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_x_continuous(limits = c(-0.3, 0.3), labels = scales::comma_format()) +
  facet_grid(. ~ .id) +
  theme_flynn() +
  theme(panel.border = element_rect(size = 0.2),
        plot.title = element_text(size = basesize*1.4, lineheight = 0.4),
        plot.title.position = "plot",
        strip.background = element_rect(size = 0.2),
        strip.text = element_text(size = basesize * 1.2),
        axis.text.y = element_text(size = basesize * 1.2),
        axis.text.x = element_text(size = basesize * 1.1),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = basesize * 1.2),
        legend.title = element_text(size = basesize*1.4, margin = margin(r = -0.3, unit = "cm")),
        legend.position = "bottom",
        legend.box = "vertical",
        legend.text = element_text(size = basesize*1.3, margin = margin(l = -0.5, unit = "cm")),
        legend.box.margin = margin(t = 0.05, unit = "cm"),
        panel.spacing = unit(0.3, "cm")) +
  guides(color = guide_legend(nrow = 1, reverse = FALSE),
         interval_lour = "none",
         interval_size = "none",
         interval_shape = "none",
         interval_alpha = "none",
         interval_linetype = "none")  +
  labs(x = "Change in Predicted Probability",
       y = "",
       color = "Response",
       title = "Change in Predicted Probability of Expressing Positive and Negative Attitudes in\nJapan Regions According to Minority Status")

ggsave(here::here("Figures/Chapter-Minority/figure-expected-conditional-japan-province-difference.jpg"), height = 6, width = 7, units = "in")
       

#### Japan Posterior Direction Results ####
japan.pd <- tidy.pred.df.wide %>% 
    dplyr::group_by(province, .id, .category) %>% 
    dplyr::summarise(median = median(difference),
                     pd = paste0(bayestestR::pd(difference))) %>% 
  dplyr::select(.id, province, .category, median, pd) %>% 
  arrange(.id, province, .category)
```



```{r Contact interaction models}

# Conflicted pckage really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)


VAGUEPRIOR <- c(set_prior("normal(0, 1)", class = "b"),
                set_prior("normal(0, 5)", class = "Intercept"))

ITER <- 1000
WARMUP <-  500
CORES <- 4
CHAINS <- 4
SEED <- 123

# Minority interaction with contact

#### Troops ####

time.1 <- Sys.time()

m.t3 <- brm(troops_1_cat ~ contact_pers +  
            minority +
            minority:contact_pers +
            gdp_log + v2x_polyarchy_z +
            exports_log + troops_log +
            pop_log +
            (1 + minority + contact_pers + minority:contact_pers | country),
                    data = o.data,
                    prior = VAGUEPRIOR,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
                    file = here("Output//Chapter-Minority/m.t3"),
                    family = categorical(link = "logit", refcat = "neutral"))
time.2 <- Sys.time()

m.t3.time <- print(time.2-time.1)



#### Government ####
time.1 <- Sys.time()

m.g3 <- brm(american_g_cat ~ contact_pers +  
            minority +
            minority:contact_pers +
            gdp_log + v2x_polyarchy_z +
            exports_log + troops_log +
            pop_log +
            (1 + minority + contact_pers + minority:contact_pers | country),
                    data = o.data,
                    prior = VAGUEPRIOR,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
                    file = here("Output//Chapter-Minority/m.g3"),
                    family = categorical(link = "logit", refcat = "neutral"))

time.2 <- Sys.time()
m.g3.time <- print(time.2-time.1)


#### People ####
time.1 <- Sys.time()

m.p3 <- brm(american_g_cat ~ contact_pers +  
            minority +
            minority:contact_pers +
            gdp_log + v2x_polyarchy_z +
            exports_log + troops_log +
            pop_log +
            (1 + minority + contact_pers + minority:contact_pers | country),
                    data = o.data,
                    prior = VAGUEPRIOR,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = 1,
                    seed = SEED,
                    file = here("Output//Chapter-Minority/m.p3"),
                    family = categorical(link = "logit", refcat = "neutral"))

time.2 <- Sys.time()

m.p3.time <- print(time.2-time.1)
```






# Tables

## Minority Only Models

```{r Table Minority Only}

m.t1 <- readRDS(here("Output/Chapter-Minority/m.t1.rds"))
m.p1 <- readRDS(here("Output/Chapter-Minority/m.p1.rds"))
m.g1 <- readRDS(here("Output/Chapter-Minority/m.g1.rds"))

mod.list <- list(" " = m.t1,
                 " " = m.p1,
                 " " = m.g1)

for (i in seq_along(mod.list)){
  class(mod.list[[i]]) <- c("custom", class(mod.list[[i]]))
}


# tidy method extracts level names into new column
tidy.custom <- function(x, conf.level=.95, ...) {
  out = parameters::parameters(x, ci=conf.level, verbose=FALSE) %>%
        parameters::standardize_names(style="broom") %>%
        mutate(y.level = case_when(grepl("mudk", term) ~ "Don't Know",
                                 grepl("muneg", term) ~ "Negative",
                                 grepl("mupos", term) ~ "Positive"),
               term = gsub("dk|neg|pos", "", term)) # remove outcome prefix brms attaches to variable names
  return(out)
}

glance.custom <- function(x, ...) {
  ret <- tibble::tibble(N = summary(x)$nobs)
  ret
}


rows <- lapply(mod.list, function(x){

  temp.sd <- parameters::parameters(x, effect = "random")  %>% 
    filter(grepl(".*sd.*", Parameter)) %>% 
    filter(grepl(".*persYes.*|.*nonpersYes.*|.*Intercept.*", Parameter)) %>% 
    dplyr::select(Parameter, Median) %>% 
    dplyr::mutate(Median = as.character(round(Median, 2)),
      y.level = case_when(
      grepl(".*mudk.*", Parameter) ~ "dk",
      grepl(".*mupos.*", Parameter) ~ "pos",
      grepl(".*muneg.*", Parameter) ~ "neg",
    ),
    Parameter = gsub("_mudk_|_mupos_|_muneg_", "_", Parameter)) %>% 
    pivot_wider(id_cols = Parameter,
                values_from = Median,
                names_from = y.level) %>% 
    mutate(Parameter = case_when(
      grepl(".*Intercept.*", Parameter) ~ "sd(Intercept)"
    ))
  
  temp.obs <- tibble::tribble(~Parameter, ~dk, ~neg, ~pos,
                              "N", as.character(nobs(x)), "", "",
                              "Group", "Country", "", "",
                              "\\# Groups", as.character(length(unique(x$data$country))), "", "")
  

  temp.com <- bind_rows(temp.obs, temp.sd)

  return(temp.com)
  
  }
)

rows.com <- bind_cols(rows[[1]], rows[[2]], rows[[3]]) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 10, 11, 12) 

names(rows.com) <- c("term", "col1", "col2", "col3", "col4", "col5", "col6", "col7", "col8", "col9")

# Turn off GOF stuff
gof.check <- modelsummary::gof_map
gof.check$omit <- TRUE


# Set up coefficient names
coef.list <- tibble::tribble(~raw, ~clean,
                            "b_mu_minorityYes", "Minority: Yes",
                            "b_mu_minorityDeclinetoanswer", "Minoriy: Decline to answer")


coef.list <- coef.list %>% 
  mutate(group = case_when(
           grepl(".*ontact.*", raw) ~ "Contact Status",
           grepl(".*enefit.*", raw) ~ "Economic Benefits",
           grepl(".*age.*", raw) ~ "Age",
           grepl(".*ncome.*", raw) ~ "Income Quintile",
           grepl(".*gender.*", raw) ~ "Gender Identification",
           grepl(".*minority.*", raw) ~ "Minority Self-Identification",
           grepl(".*relig.*", raw) ~ "Religious Identification",
           grepl(".*ed_z.*", raw) ~ "Education",
           grepl(".*ideology_z.*", raw) ~ "Ideology",
           grepl(".*crime.*", raw) ~ "Crime Experience",
           grepl(".*inf_1.*", raw) ~ "American Influence (Amount)",
           grepl(".*inf_2.*", raw) ~ "American Influence (Quality)",
           TRUE ~ "Group-Level Variables"
         )) 


# Find how long the coefficient list is for the final table hline
last.line <- length(coef.list[[1]]) * 2

coef_map <- setNames(coef.list$clean, coef.list$raw)
idx <- rle(coef.list$group)
idx <- setNames(idx$lengths  * 2, idx$values)



panel.1 <- modelsummary::modelsummary(mod.list,
                  estimate = "{estimate}",
                  statistic = "conf.int",
                  fmt = 2,
                  group = term ~ model + y.level,
                  gof_map = gof.check,
                  coef_map = coef_map,
                  add_rows = rows.com,
                  stars = FALSE,
                  longtable = TRUE,
                  output = "latex",
                  caption = "Bayesian multilevel multinomial logistic regressions. Minority Self-Identification Base Models. \\label{tab:minoritybase}",) %>% 
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 4, position = "left",
                stripe_index = c(1:2)) %>%
  add_header_above(c(" ", "U.S. Troops" = 3, "U.S. People" = 3, "U.S. Government" = 3)) %>% 
  pack_rows("Minority Status", 1, 4, bold = TRUE, background = "gray", color = "white") %>% 
  row_spec(last.line, hline_after = TRUE) %>% 
  landscape() %>% 
  save_kable(here("Tables/Chapter-Minority/model-minority-base.tex"),
             keep_tex = TRUE)


```



## Full Model


```{r Table Full Population Effects}

m.t2 <- readRDS(here("Output/Chapter-Minority/m.t2.rds"))
m.p2 <- readRDS(here("Output/Chapter-Minority/m.p2.rds"))
m.g2 <- readRDS(here("Output/Chapter-Minority/m.g2.rds"))

mod.list <- list(" " = m.t2,
                 " " = m.p2,
                 " " = m.g2)

for (i in seq_along(mod.list)){
  class(mod.list[[i]]) <- c("custom", class(mod.list[[i]]))
}


# tidy method extracts level names into new column
tidy.custom <- function(x, conf.level=.95, ...) {
  out = parameters::parameters(x, ci=conf.level, verbose=FALSE) %>%
        parameters::standardize_names(style="broom") %>%
        mutate(y.level = case_when(grepl("mudk", term) ~ "Don't Know",
                                 grepl("muneg", term) ~ "Negative",
                                 grepl("mupos", term) ~ "Positive"),
               term = gsub("dk|neg|pos", "", term)) # remove outcome prefix brms attaches to variable names
  return(out)
}

glance.custom <- function(x, ...) {
  ret <- tibble::tibble(N = summary(x)$nobs)
  ret
}


# Edit the final line if other values needed in addition to intercept
rows <- lapply(mod.list, function(x){

  temp.sd <- parameters::parameters(x, effect = "random")  %>% 
    filter(grepl(".*sd.*", Parameter)) %>% 
    filter(grepl(".*persYes.*|.*nonpersYes.*|.*Intercept.*", Parameter)) %>% 
    dplyr::select(Parameter, Median) %>% 
    dplyr::mutate(Median = as.character(round(Median, 2)),
      y.level = case_when(
      grepl(".*mudk.*", Parameter) ~ "dk",
      grepl(".*mupos.*", Parameter) ~ "pos",
      grepl(".*muneg.*", Parameter) ~ "neg",
    ),
    Parameter = gsub("_mudk_|_mupos_|_muneg_", "_", Parameter)) %>% 
    pivot_wider(id_cols = Parameter,
                values_from = Median,
                names_from = y.level) %>% 
    mutate(Parameter = case_when(
      grepl(".*Intercept.*", Parameter) ~ "sd(Intercept)"
    ))
  
  temp.obs <- tibble::tribble(~Parameter, ~dk, ~neg, ~pos,
                              "N", as.character(nobs(x)), "", "",
                              "Group", "Country", "", "",
                              "\\# Groups", as.character(length(unique(x$data$country))), "", "")
  

  temp.com <- bind_rows(temp.obs, temp.sd)

  return(temp.com)
  
  }
)

rows.com <- bind_cols(rows[[1]], rows[[2]], rows[[3]]) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 10, 11, 12) 

names(rows.com) <- c("term", "col1", "col2", "col3", "col4", "col5", "col6", "col7", "col8", "col9")

# Turn off GOF stuff
gof.check <- modelsummary::gof_map
gof.check$omit <- TRUE


# Set up coefficient names
coef.list <- tibble::tribble(~raw, ~clean,
                            "b_mu_minorityYes", "Minority: Yes",
                            "b_mu_minorityDeclinetoanswer", "Minoriy: Decline to answer",
                            "b_mu_troops_crime_persYes", "Personal Crime: Yes",
                            "b_mu_contact_persYes", "Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer", "Personal Contact: DK/Decline",
                            "b_mu_benefit_persYes", "Personal Benefit: Yes",
                            "b_mu_benefit_persDontknowDdeclinetoanswer", "Personal Benefit: DK/Decline",
                            "b_mu_age25to34years", "25-34",
                            "b_mu_age35to44years", "35-44",
                            "b_mu_age45to54years", "45-54",
                            "b_mu_age55to64years", "55-65",
                            "b_mu_ageAge65orolder", ">65",
                            "b_mu_income.5.cat21M40%", "21-40",
                            "b_mu_income.5.cat41M60%", "41-60",
                            "b_mu_income.5.cat61M80%", "61-80",
                            "b_mu_income.5.cat81M100%", "81-100",
                            "b_mu_genderFemale", "Female",
                            "b_mu_genderNonMbinary", "Non-binary",
                            "b_mu_genderNoneoftheabove", "None of the above",
                            "b_mu_ed_z", "Education",
                            "b_mu_ideology_z", "Ideology",
                            "b_mu_american_inf_1DontknowDdeclinetoanswer", "Influence 1: DK/Decline",
                            "b_mu_american_inf_1Alittle", "Influence 1: A little",
                            "b_mu_american_inf_1Some", "Influence 1: Some",
                            "b_mu_american_inf_1Alot", "Influence 1: A lot",
                            "b_mu_american_inf_2DontknowDdeclinetoanswer", "Influence 2: DK/Decline",
                            "b_mu_american_inf_2Veryative", "Influence 2: Very negative",
                            "b_mu_american_inf_2Negative", "Influence 2: Negative",
                            "b_mu_american_inf_2Positive", "Influence 2: Positive",
                            "b_mu_american_inf_2Veryitive", "Influence 2: Very positive",
                            "b_mu_basecount_z", "Base count",
                            "b_mu_gdp_z", "GDP",
                            "b_mu_pop_z", "Population",
                            "b_mu_troops_z", "Troop deployment size",
                            "b_mu_Intercept", "Intercept")


coef.list <- coef.list %>% 
  mutate(group = case_when(
           grepl(".*ontact.*", raw) ~ "Contact Status",
           grepl(".*enefit.*", raw) ~ "Economic Benefits",
           grepl(".*age.*", raw) ~ "Age",
           grepl(".*ncome.*", raw) ~ "Income Quintile",
           grepl(".*gender.*", raw) ~ "Gender Identification",
           grepl(".*minority.*", raw) ~ "Minority Self-Identification",
           grepl(".*relig.*", raw) ~ "Religious Identification",
           grepl(".*ed_z.*", raw) ~ "Education",
           grepl(".*ideology_z.*", raw) ~ "Ideology",
           grepl(".*crime.*", raw) ~ "Crime Experience",
           grepl(".*inf_1.*", raw) ~ "American Influence (Amount)",
           grepl(".*inf_2.*", raw) ~ "American Influence (Quality)",
           TRUE ~ "Group-Level Variables"
         )) 


# Find how long the coefficient list is for the final table hline
last.line <- length(coef.list[[1]]) * 2

coef_map <- setNames(coef.list$clean, coef.list$raw)
idx <- rle(coef.list$group)
idx <- setNames(idx$lengths  * 2, idx$values)



panel.1 <- modelsummary::modelsummary(mod.list,
                  estimate = "{estimate}",
                  statistic = "conf.int",
                  fmt = 2,
                  group = term ~ model + y.level,
                  gof_map = gof.check,
                  coef_map = coef_map,
                  add_rows = rows.com,
                  stars = FALSE,
                  longtable = TRUE,
                  output = "latex",
                  caption = "Bayesian multilevel multinomial logistic regressions. Minority Self-Identification Full Models. \\label{tab:minorityfull}",) %>% 
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 4, position = "float_left") %>%
  add_header_above(c(" ", "US Presence" = 3, "US People" = 3, "US Government" = 3)) %>% 
  group_rows(index = idx, bold = TRUE, background = "gray", color = "white", hline_after = TRUE) %>% 
  row_spec(last.line, hline_after = TRUE) %>% 
  landscape() %>% 
  save_kable(here("Tables/Chapter-Minority/model-minority-full.tex"),
             keep_tex = TRUE)


```

## Full Varying Effects

```{r Table Full Varying Effects}

m.t3 <- readRDS(here("Output/Chapter-Minority/m.t3.rds"))
m.p3 <- readRDS(here("Output/Chapter-Minority/m.p3.rds"))
m.g3 <- readRDS(here("Output/Chapter-Minority/m.g3.rds"))

mod.list <- list(" " = m.t3,
                 " " = m.p3,
                 " " = m.g3)

for (i in seq_along(mod.list)){
  class(mod.list[[i]]) <- c("custom", class(mod.list[[i]]))
}


# tidy method extracts level names into new column
tidy.custom <- function(x, conf.level=.95, ...) {
  out = parameters::parameters(x, ci=conf.level, verbose=FALSE) %>%
        parameters::standardize_names(style="broom") %>%
        mutate(y.level = case_when(grepl("mudk", term) ~ "Don't Know",
                                 grepl("muneg", term) ~ "Negative",
                                 grepl("mupos", term) ~ "Positive"),
               term = gsub("dk|neg|pos", "", term)) # remove outcome prefix brms attaches to variable names
  return(out)
}

glance.custom <- function(x, ...) {
  ret <- tibble::tibble(N = summary(x)$nobs)
  ret
}


# Edit the final line if other values needed in addition to intercept
rows <- lapply(mod.list, function(x){

  temp.sd <- parameters::parameters(x, effect = "random")  %>% 
    filter(grepl(".*sd.*", Parameter)) %>% 
    filter(grepl(".*minorityYes.*|.*nonpersYes.*|.*Intercept.*", Parameter)) %>% 
    dplyr::select(Parameter, Median) %>% 
    dplyr::mutate(Median = as.character(round(Median, 2)),
      y.level = case_when(
      grepl(".*mudk.*", Parameter) ~ "dk",
      grepl(".*mupos.*", Parameter) ~ "pos",
      grepl(".*muneg.*", Parameter) ~ "neg",
    ),
    Parameter = gsub("_mudk_|_mupos_|_muneg_", "_", Parameter)) %>% 
    pivot_wider(id_cols = Parameter,
                values_from = Median,
                names_from = y.level) %>% 
    mutate(Parameter = case_when(
      grepl(".*Intercept.*", Parameter) ~ "sd(Intercept)",
      grepl(".*minorityYes.*", Parameter) ~ "sd(Minority)"
    ))
  
  temp.obs <- tibble::tribble(~Parameter, ~dk, ~neg, ~pos,
                              "N", as.character(nobs(x)), "", "",
                              "Group", "Country", "", "",
                              "\\# Groups", as.character(length(unique(x$data$country))), "", "")
  

  temp.com <- bind_rows(temp.obs, temp.sd)

  return(temp.com)
  
  }
)

rows.com <- bind_cols(rows[[1]], rows[[2]], rows[[3]]) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 10, 11, 12) 

names(rows.com) <- c("term", "col1", "col2", "col3", "col4", "col5", "col6", "col7", "col8", "col9")

# Turn off GOF stuff
gof.check <- modelsummary::gof_map
gof.check$omit <- TRUE


# Set up coefficient names
coef.list <- tibble::tribble(~raw, ~clean,
                            "b_mu_minorityYes", "Minority: Yes",
                            "b_mu_minorityDeclinetoanswer", "Minoriy: Decline to answer",
                            "b_mu_troops_crime_persYes", "Personal Crime: Yes",
                            "b_mu_contact_persYes", "Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer", "Personal Contact: DK/Decline",
                            "b_mu_benefit_persYes", "Personal Benefit: Yes",
                            "b_mu_benefit_persDontknowDdeclinetoanswer", "Personal Benefit: DK/Decline",
                            "b_mu_age25to34years", "25-34",
                            "b_mu_age35to44years", "35-44",
                            "b_mu_age45to54years", "45-54",
                            "b_mu_age55to64years", "55-65",
                            "b_mu_ageAge65orolder", ">65",
                            "b_mu_income.5.cat21M40%", "21-40",
                            "b_mu_income.5.cat41M60%", "41-60",
                            "b_mu_income.5.cat61M80%", "61-80",
                            "b_mu_income.5.cat81M100%", "81-100",
                            "b_mu_genderFemale", "Female",
                            "b_mu_genderNonMbinary", "Non-binary",
                            "b_mu_genderNoneoftheabove", "None of the above",
                            "b_mu_ed_z", "Education",
                            "b_mu_ideology_z", "Ideology",
                            "b_mu_american_inf_1DontknowDdeclinetoanswer", "Influence 1: DK/Decline",
                            "b_mu_american_inf_1Alittle", "Influence 1: A little",
                            "b_mu_american_inf_1Some", "Influence 1: Some",
                            "b_mu_american_inf_1Alot", "Influence 1: A lot",
                            "b_mu_american_inf_2DontknowDdeclinetoanswer", "Influence 2: DK/Decline",
                            "b_mu_american_inf_2Veryative", "Influence 2: Very negative",
                            "b_mu_american_inf_2Negative", "Influence 2: Negative",
                            "b_mu_american_inf_2Positive", "Influence 2: Positive",
                            "b_mu_american_inf_2Veryitive", "Influence 2: Very positive",
                            "b_mu_basecount_z", "Base count",
                            "b_mu_gdp_z", "GDP",
                            "b_mu_pop_z", "Population",
                            "b_mu_troops_z", "Troop deployment size",
                            "b_mu_Intercept", "Intercept")


coef.list <- coef.list %>% 
  mutate(group = case_when(
           grepl(".*ontact.*", raw) ~ "Contact Status",
           grepl(".*enefit.*", raw) ~ "Economic Benefits",
           grepl(".*age.*", raw) ~ "Age",
           grepl(".*ncome.*", raw) ~ "Income Quintile",
           grepl(".*gender.*", raw) ~ "Gender Identification",
           grepl(".*minority.*", raw) ~ "Minority Self-Identification",
           grepl(".*relig.*", raw) ~ "Religious Identification",
           grepl(".*ed_z.*", raw) ~ "Education",
           grepl(".*ideology_z.*", raw) ~ "Ideology",
           grepl(".*crime.*", raw) ~ "Crime Experience",
           grepl(".*inf_1.*", raw) ~ "American Influence (Amount)",
           grepl(".*inf_2.*", raw) ~ "American Influence (Quality)",
           TRUE ~ "Group-Level Variables"
         )) 


# Find how long the coefficient list is for the final table hline
last.line <- length(coef.list[[1]]) * 2

coef_map <- setNames(coef.list$clean, coef.list$raw)
idx <- rle(coef.list$group)
idx <- setNames(idx$lengths  * 2, idx$values)



panel.1 <- modelsummary::modelsummary(mod.list,
                  estimate = "{estimate}",
                  statistic = "conf.int",
                  fmt = 2,
                  group = term ~ model + y.level,
                  gof_map = gof.check,
                  coef_map = coef_map,
                  add_rows = rows.com,
                  stars = FALSE,
                  longtable = TRUE,
                  output = "latex",
                  caption = "Bayesian multilevel multinomial logistic regressions. Minority Self-Identification Varying Effects Models. \\label{tab:minorityfullvarying}",) %>% 
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 4, position = "float_left") %>%
  add_header_above(c(" ", "US Presence" = 3, "US People" = 3, "US Government" = 3)) %>% 
  group_rows(index = idx, bold = TRUE, background = "gray", color = "white", hline_after = TRUE) %>% 
  row_spec(last.line, hline_after = TRUE) %>% 
  landscape() %>% 
  save_kable(here("Tables/Chapter-Minority/model-minority-full-varying.tex"),
             keep_tex = TRUE)


```

```{r Table Full Varying Effects And Contact Interaction}

m.t5 <- readRDS(here("Output/Chapter-Minority/m.t5.rds"))
m.p5 <- readRDS(here("Output/Chapter-Minority/m.p5.rds"))
m.g5 <- readRDS(here("Output/Chapter-Minority/m.g5.rds"))

mod.list <- list(" " = m.t5,
                 " " = m.p5,
                 " " = m.g5)

for (i in seq_along(mod.list)){
  class(mod.list[[i]]) <- c("custom", class(mod.list[[i]]))
}


# tidy method extracts level names into new column
tidy.custom <- function(x, conf.level=.95, ...) {
  out = parameters::parameters(x, ci=conf.level, verbose=FALSE) %>%
        parameters::standardize_names(style="broom") %>%
        mutate(y.level = case_when(grepl("mudk", term) ~ "Don't Know",
                                 grepl("muneg", term) ~ "Negative",
                                 grepl("mupos", term) ~ "Positive"),
               term = gsub("dk|neg|pos", "", term)) # remove outcome prefix brms attaches to variable names
  return(out)
}

glance.custom <- function(x, ...) {
  ret <- tibble::tibble(N = summary(x)$nobs)
  ret
}


# Edit the final line if other values needed in addition to intercept
rows <- lapply(mod.list, function(x){

  temp.sd <- parameters::parameters(m.t5, effect = "random")  %>% 
    filter(grepl(".*sd.*", Parameter)) %>% 
    filter(grepl(".*minorityYes.*|.*contact_persYes.*|.*Intercept.*", Parameter)) %>% 
    dplyr::select(Parameter, Median) %>% 
    dplyr::mutate(Median = as.character(round(Median, 2)),
      y.level = case_when(
      grepl(".*mudk.*", Parameter) ~ "dk",
      grepl(".*mupos.*", Parameter) ~ "pos",
      grepl(".*muneg.*", Parameter) ~ "neg",
    ),
    Parameter = gsub("_mudk_|_mupos_|_muneg_", "_", Parameter)) %>% 
    pivot_wider(id_cols = Parameter,
                values_from = Median,
                names_from = y.level) %>% 
    filter(Parameter == "sd_country__Intercept" | 
             Parameter == "sd_country__minorityYes" |
             Parameter == "sd_country__contact_persYes" |
             Parameter == "sd_country__minorityYes:contact_persYes") %>% 
    mutate(Parameter = case_when(
      Parameter == "sd_country__Intercept" ~ "sd(Intercept)",
      Parameter == "sd_country__minorityYes" ~ "sd(Minority)",
      Parameter == "sd_country__contact_persYes" ~ "sd(Personal Contact)",
      Parameter == "sd_country__minorityYes:contact_persYes" ~ "sd(Minority: Yes $\\times$ Personal Contact: Yes)"
    ))
  
  temp.obs <- tibble::tribble(~Parameter, ~dk, ~neg, ~pos,
                              "N", as.character(nobs(x)), "", "",
                              "Group", "Country", "", "",
                              "\\# Groups", as.character(length(unique(x$data$country))), "", "")
  

  temp.com <- bind_rows(temp.obs, temp.sd)

  return(temp.com)
  
  }
)

rows.com <- bind_cols(rows[[1]], rows[[2]], rows[[3]]) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 10, 11, 12) 

names(rows.com) <- c("term", "col1", "col2", "col3", "col4", "col5", "col6", "col7", "col8", "col9")

# Turn off GOF stuff
gof.check <- modelsummary::gof_map
gof.check$omit <- TRUE


# Set up coefficient names
coef.list <- tibble::tribble(~raw, ~clean,
                            "b_mu_minorityYes", "Minority: Yes",
                            "b_mu_minorityDeclinetoanswer", "Minoriy: Decline to answer",
                            "b_mu_troops_crime_persYes", "Personal Crime: Yes",
                            "b_mu_contact_persYes", "Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer", "Personal Contact: DK/Decline",
                            "b_mu_minorityYes:contact_persYes", "Minority: Yes $\\times$ Personal Contact: Yes",    
                            "b_mu_minorityYes:contact_persDontknowDdeclinetoanswer", "Minority: Yes $\\times$ Personal Contact: Don't Know",          
                            "b_mu_minorityDeclinetoanswer:contact_persDontknowDdeclinetoanswer", "Minority: Decline $\\times$ Personal Contact: Don't Know",
                            "b_mu_minorityDeclinetoanswer:contact_persYes", "Minority: Decline $\\times$ Personal Contact: Yes",
                            "b_mu_benefit_persYes", "Personal Benefit: Yes",
                            "b_mu_benefit_persDontknowDdeclinetoanswer", "Personal Benefit: DK/Decline",
                            "b_mu_age25to34years", "25-34",
                            "b_mu_age35to44years", "35-44",
                            "b_mu_age45to54years", "45-54",
                            "b_mu_age55to64years", "55-65",
                            "b_mu_ageAge65orolder", ">65",
                            "b_mu_income.5.cat21M40%", "21-40",
                            "b_mu_income.5.cat41M60%", "41-60",
                            "b_mu_income.5.cat61M80%", "61-80",
                            "b_mu_income.5.cat81M100%", "81-100",
                            "b_mu_genderFemale", "Female",
                            "b_mu_genderNonMbinary", "Non-binary",
                            "b_mu_genderNoneoftheabove", "None of the above",
                            "b_mu_ed_z", "Education",
                            "b_mu_ideology_z", "Ideology",
                            "b_mu_american_inf_1DontknowDdeclinetoanswer", "Influence 1: DK/Decline",
                            "b_mu_american_inf_1Alittle", "Influence 1: A little",
                            "b_mu_american_inf_1Some", "Influence 1: Some",
                            "b_mu_american_inf_1Alot", "Influence 1: A lot",
                            "b_mu_american_inf_2DontknowDdeclinetoanswer", "Influence 2: DK/Decline",
                            "b_mu_american_inf_2Veryative", "Influence 2: Very negative",
                            "b_mu_american_inf_2Negative", "Influence 2: Negative",
                            "b_mu_american_inf_2Positive", "Influence 2: Positive",
                            "b_mu_american_inf_2Veryitive", "Influence 2: Very positive",
                            "b_mu_basecount_z", "Base count",
                            "b_mu_gdp_z", "GDP",
                            "b_mu_pop_z", "Population",
                            "b_mu_troops_z", "Troop deployment size",
                            "b_mu_Intercept", "Intercept")


coef.list <- coef.list %>% 
  mutate(group = case_when(
           grepl(".*ontact.*", raw) ~ "Contact Status",
           grepl(".*enefit.*", raw) ~ "Economic Benefits",
           grepl(".*age.*", raw) ~ "Age",
           grepl(".*ncome.*", raw) ~ "Income Quintile",
           grepl(".*gender.*", raw) ~ "Gender Identification",
           grepl(".*minority.*", raw) ~ "Minority Self-Identification",
           grepl(".*relig.*", raw) ~ "Religious Identification",
           grepl(".*ed_z.*", raw) ~ "Education",
           grepl(".*ideology_z.*", raw) ~ "Ideology",
           grepl(".*crime.*", raw) ~ "Crime Experience",
           grepl(".*inf_1.*", raw) ~ "American Influence (Amount)",
           grepl(".*inf_2.*", raw) ~ "American Influence (Quality)",
           TRUE ~ "Group-Level Variables"
         ),
         group = case_when(
           grepl(".*:.*", raw) ~ "Interaction Terms",
           TRUE ~ group
         )) 


# Find how long the coefficient list is for the final table hline
last.line <- length(coef.list[[1]]) * 2

coef_map <- setNames(coef.list$clean, coef.list$raw)
idx <- rle(coef.list$group)
idx <- setNames(idx$lengths  * 2, idx$values)



panel.1 <- modelsummary::modelsummary(mod.list,
                  estimate = "{estimate}",
                  statistic = "conf.int",
                  fmt = 2,
                  group = term ~ model + y.level,
                  gof_map = gof.check,
                  coef_map = coef_map,
                  add_rows = rows.com,
                  stars = FALSE,
                  longtable = TRUE,
                  output = "latex",
                  escape = FALSE,
                  caption = "Bayesian multilevel multinomial logistic regressions. Minority Self-Identification Varying Effects Models with Contact Interaction. \\label{tab:minorityfullvaryinginteraction}",) %>% 
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 4, position = "float_left") %>%
  add_header_above(c(" ", "US Presence" = 3, "US People" = 3, "US Government" = 3)) %>% 
  group_rows(index = idx, bold = TRUE, background = "gray", color = "white", hline_after = TRUE) %>% 
  row_spec(last.line, hline_after = TRUE) %>% 
  landscape() %>% 
  save_kable(here("Tables/Chapter-Minority/model-minority-full-varying-interaction.tex"),
             keep_tex = TRUE)


```


## Full Varying Effects

```{r Table Full Varying Effects}

m.t4.japan <- readRDS(here("Output/Chapter-Minority/m.t4.japan.rds"))
m.p4.japan <- readRDS(here("Output/Chapter-Minority/m.p4.japan.rds"))
m.g4.japan <- readRDS(here("Output/Chapter-Minority/m.g4.japan.rds"))

mod.list <- list(" " = m.t4.japan,
                 " " = m.p4.japan,
                 " " = m.g4.japan)

for (i in seq_along(mod.list)){
  class(mod.list[[i]]) <- c("custom", class(mod.list[[i]]))
}


# tidy method extracts level names into new column
tidy.custom <- function(x, conf.level=.95, ...) {
  out = parameters::parameters(x, ci=conf.level, verbose=FALSE) %>%
        parameters::standardize_names(style="broom") %>%
        mutate(y.level = case_when(grepl("mudk", term) ~ "Don't Know",
                                 grepl("muneg", term) ~ "Negative",
                                 grepl("mupos", term) ~ "Positive"),
               term = gsub("dk|neg|pos", "", term)) # remove outcome prefix brms attaches to variable names
  return(out)
}

glance.custom <- function(x, ...) {
  ret <- tibble::tibble(N = summary(x)$nobs)
  ret
}


# Edit the final line if other values needed in addition to intercept
rows <- lapply(mod.list, function(x){

  temp.sd <- parameters::parameters(x, effect = "random")  %>% 
    filter(grepl(".*sd.*", Parameter)) %>% 
    filter(grepl(".*minorityYes.*|.*nonpersYes.*|.*Intercept.*", Parameter)) %>% 
    dplyr::select(Parameter, Median) %>% 
    dplyr::mutate(Median = as.character(round(Median, 2)),
      y.level = case_when(
      grepl(".*mudk.*", Parameter) ~ "dk",
      grepl(".*mupos.*", Parameter) ~ "pos",
      grepl(".*muneg.*", Parameter) ~ "neg",
    ),
    Parameter = gsub("_mudk_|_mupos_|_muneg_", "_", Parameter)) %>% 
    pivot_wider(id_cols = Parameter,
                values_from = Median,
                names_from = y.level) %>% 
    mutate(Parameter = case_when(
      grepl(".*Intercept.*", Parameter) ~ "sd(Intercept)",
      grepl(".*minorityYes.*", Parameter) ~ "sd(Minority)"
    ))
  
  temp.obs <- tibble::tribble(~Parameter, ~dk, ~neg, ~pos,
                              "N", as.character(nobs(x)), "", "",
                              "Group", "Country", "", "",
                              "\\# Groups", as.character(length(unique(x$data$country))), "", "")
  

  temp.com <- bind_rows(temp.obs, temp.sd)

  return(temp.com)
  
  }
)

rows.com <- bind_cols(rows[[1]], rows[[2]], rows[[3]]) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 10, 11, 12) 

names(rows.com) <- c("term", "col1", "col2", "col3", "col4", "col5", "col6", "col7", "col8", "col9")

# Turn off GOF stuff
gof.check <- modelsummary::gof_map
gof.check$omit <- TRUE


# Set up coefficient names
coef.list <- tibble::tribble(~raw, ~clean,
                            "b_mu_minorityYes", "Minority: Yes",
                            "b_mu_minorityDeclinetoanswer", "Minoriy: Decline to answer",
                            "b_mu_troops_crime_persYes", "Personal Crime: Yes",
                            "b_mu_contact_persYes", "Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer", "Personal Contact: DK/Decline",
                            "b_mu_benefit_persYes", "Personal Benefit: Yes",
                            "b_mu_benefit_persDontknowDdeclinetoanswer", "Personal Benefit: DK/Decline",
                            "b_mu_age25to34years", "25-34",
                            "b_mu_age35to44years", "35-44",
                            "b_mu_age45to54years", "45-54",
                            "b_mu_age55to64years", "55-65",
                            "b_mu_ageAge65orolder", ">65",
                            "b_mu_income.5.cat21M40%", "21-40",
                            "b_mu_income.5.cat41M60%", "41-60",
                            "b_mu_income.5.cat61M80%", "61-80",
                            "b_mu_income.5.cat81M100%", "81-100",
                            "b_mu_genderFemale", "Female",
                            "b_mu_genderNonMbinary", "Non-binary",
                            "b_mu_genderNoneoftheabove", "None of the above",
                            "b_mu_ed_z", "Education",
                            "b_mu_ideology_z", "Ideology",
                            "b_mu_american_inf_1DontknowDdeclinetoanswer", "Influence 1: DK/Decline",
                            "b_mu_american_inf_1Alittle", "Influence 1: A little",
                            "b_mu_american_inf_1Some", "Influence 1: Some",
                            "b_mu_american_inf_1Alot", "Influence 1: A lot",
                            "b_mu_american_inf_2DontknowDdeclinetoanswer", "Influence 2: DK/Decline",
                            "b_mu_american_inf_2Veryative", "Influence 2: Very negative",
                            "b_mu_american_inf_2Negative", "Influence 2: Negative",
                            "b_mu_american_inf_2Positive", "Influence 2: Positive",
                            "b_mu_american_inf_2Veryitive", "Influence 2: Very positive",
                            "b_mu_basecount_z", "Base count",
                            "b_mu_gdp_z", "GDP",
                            "b_mu_pop_z", "Population",
                            "b_mu_troops_z", "Troop deployment size",
                            "b_mu_Intercept", "Intercept")


coef.list <- coef.list %>% 
  mutate(group = case_when(
           grepl(".*ontact.*", raw) ~ "Contact Status",
           grepl(".*enefit.*", raw) ~ "Economic Benefits",
           grepl(".*age.*", raw) ~ "Age",
           grepl(".*ncome.*", raw) ~ "Income Quintile",
           grepl(".*gender.*", raw) ~ "Gender Identification",
           grepl(".*minority.*", raw) ~ "Minority Self-Identification",
           grepl(".*relig.*", raw) ~ "Religious Identification",
           grepl(".*ed_z.*", raw) ~ "Education",
           grepl(".*ideology_z.*", raw) ~ "Ideology",
           grepl(".*crime.*", raw) ~ "Crime Experience",
           grepl(".*inf_1.*", raw) ~ "American Influence (Amount)",
           grepl(".*inf_2.*", raw) ~ "American Influence (Quality)",
           TRUE ~ "Group-Level Variables"
         )) 


# Find how long the coefficient list is for the final table hline
last.line <- length(coef.list[[1]]) * 2

coef_map <- setNames(coef.list$clean, coef.list$raw)
idx <- rle(coef.list$group)
idx <- setNames(idx$lengths  * 2, idx$values)



panel.1 <- modelsummary::modelsummary(mod.list,
                  estimate = "{estimate}",
                  statistic = "conf.int",
                  fmt = 2,
                  group = term ~ model + y.level,
                  gof_map = gof.check,
                  coef_map = coef_map,
                  add_rows = rows.com,
                  stars = FALSE,
                  longtable = TRUE,
                  output = "latex",
                  caption = "Bayesian multilevel multinomial logistic regressions. Minority Self-Identification Varying Effects Models, Japan Only. \\label{tab:minorityfullvaryingjapan}",) %>% 
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 4, position = "float_left") %>%
  add_header_above(c(" ", "US Presence" = 3, "US People" = 3, "US Government" = 3)) %>% 
  group_rows(index = idx, bold = TRUE, background = "gray", color = "white", hline_after = TRUE) %>% 
  row_spec(last.line, hline_after = TRUE) %>% 
  landscape() %>% 
  save_kable(here("Tables/Chapter-Minority/model-minority-full-varying-japan.tex"),
             keep_tex = TRUE)


```

### Varying Posterior Distribution Table
```{r Posterior Distribution Tables}


#### Stats on distributions for select cases ####
posterior.table.troops <- tibble(country = unique(m.t3.fig$country),
                          percent.positive = NA,
                          percent.negative = NA) %>% 
  rowwise() %>% 
  mutate(percent.positive = length(m.t3.fig$effect[m.t3.fig$effect>0 & m.t3.fig$country==country & m.t3.fig$model == "U.S. Troops" & m.t3.fig$equation== "Positive View"]) / length(m.t3.fig$effect[m.t3.fig$country==country & m.t3.fig$model == "U.S. Troops" & m.t3.fig$equation== "Positive View"]),
         percent.negative = length(m.t3.fig$effect[m.t3.fig$effect>0 & m.t3.fig$country==country & m.t3.fig$model == "U.S. Troops" & m.t3.fig$equation== "Negative View"]) / length(m.t3.fig$effect[m.t3.fig$country==country & m.t3.fig$model == "U.S. Troops" & m.t3.fig$equation== "Negative View"]))

# People
posterior.table.peoples <- tibble(country = unique(m.p3.fig$country),
                                  percent.positive = NA,
                                  percent.negative = NA) %>% 
  rowwise() %>% 
  mutate(percent.positive = length(m.p3.fig$effect[m.p3.fig$effect>0 & m.p3.fig$country==country & m.p3.fig$model == "U.S. People" & m.p3.fig$equation== "Positive View"]) / length(m.p3.fig$effect[m.p3.fig$country==country & m.p3.fig$model == "U.S. People" & m.p3.fig$equation== "Positive View"]),
         percent.negative = length(m.p3.fig$effect[m.p3.fig$effect>0 & m.p3.fig$country==country & m.p3.fig$model == "U.S. People" & m.p3.fig$equation== "Negative View"]) / length(m.p3.fig$effect[m.p3.fig$country==country & m.p3.fig$model == "U.S. People" & m.p3.fig$equation== "Negative View"]))


# Government
posterior.table.government <- tibble(country = unique(m.g3.fig$country),
                                     percent.positive = NA,
                                     percent.negative = NA) %>% 
  rowwise() %>% 
  mutate(percent.positive = length(m.g3.fig$effect[m.g3.fig$effect>0 & m.g3.fig$country==country & m.g3.fig$model == "U.S. Government" & m.g3.fig$equation== "Positive View"]) / length(m.g3.fig$effect[m.g3.fig$country==country & m.g3.fig$model == "U.S. Government" & m.g3.fig$equation== "Positive View"]),
         percent.negative = length(m.g3.fig$effect[m.g3.fig$effect>0 & m.g3.fig$country==country & m.g3.fig$model == "U.S. Government" & m.g3.fig$equation== "Negative View"]) / length(m.g3.fig$effect[m.g3.fig$country==country & m.g3.fig$model == "U.S. Government" & m.g3.fig$equation== "Negative View"]))


# Don't forget to escale the punctuation mark!
posterior.table.list <- list("U.S. Troops" = posterior.table.troops, 
                             "U.S. People" = posterior.table.peoples, 
                             "U.S. Government" = posterior.table.government) %>% 
  map(., ~ mutate(., percent.positive = round(percent.positive*100, 1),
                percent.negative = round(percent.negative*100, 1),
                country = gsub("\\.", " ", country)))


posterior.table <- posterior.table.list[[1]] %>% 
  bind_cols(posterior.table.list[[3]]) %>% 
  bind_cols(posterior.table.list[[2]]) %>% 
  dplyr::select(-c(4,7)) %>% 
  kable("latex", col.names = c("", "Positive Response", "Negative Response", "Positive Response", "Negative Response", "Positive Response", "Negative Response"),
        booktabs = TRUE, caption = "Percent of the posterior distribution that falls above 0 \\label{tab:posteriordistributionzero}") %>% 
  kable_styling(latex_options = c("striped", "scale_down"), position = "center", protect_latex = TRUE, font_size = 9) %>% 
  add_header_above(c("", "U.S. Troops" = 2, "U.S. Government" = 2, "U.S. People" = 2), bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
save_kable(here("Tables/Chapter-Minority/table-varying-coefficient-posterior-percent.tex"),
             keep_tex = TRUE)  



```













