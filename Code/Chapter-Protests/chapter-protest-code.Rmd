---
title: "Protest Chapter Analysis and Notes"
author: "Michael Flynn"
date: "3/7/2020"
output:
  html_document:
    df_print: paged
bibliography: "/Chapters/one.bib"
editor_options: 
  markdown: 
    wrap: 72
---

# Front Matter

This section loads the data files and libraries. Assembles the main data

```{r setup , echo = FALSE, include = FALSE}

#devtools::install_github("lindeloev/job")

library(tidyverse)
library(tidyr)
library(job)
library(broom)
library(broom.mixed)
library(psych)
library(ipw)
library(modelr)
library(cshapes)
library(countrycode)
library(dagitty)
library(ggdag)
library(arm)
library(brms)
library(rstan)
library(cmdstanr)
library(parallel)
library(tidybayes)
library(scales)
library(ggdist)
library(kableExtra)
library(BayesPostEst)
library(texreg)
library(modelsummary)
library(gt)
library(webshot)
library(kableExtra)
library(ggExtra)
library(ggmcmc)
library(ggpubr)
library(patchwork)
library(here)
library(arm)
library(performance)
#library(ROCR)
library(tictoc)
library(remotes)

#devtools::install_github('tidyss/rroughviz')
#devtools::install_github("xvrdm/ggrough")
#library(ggrough)
#library(rroughviz)

#remotes::install_github('vincentarelbundock/modelsummary') 

# Test
library(modelsummary)

knitr::opts_chunk$set(comment = '', dpi = 400)

sysfonts::font_add_google("Oswald", family = "oswald")
showtext::showtext_auto()

basesize <- 30
# Regular plot theme
theme_flynn <- function(){ 
  
      theme_linedraw(base_size = basesize, base_family = "oswald") %+replace% 
        
        theme(plot.title = element_text(face = "bold", size = basesize*1.3, hjust = 0, margin = margin(t = 0, b = 0.3, l = 0, r = 0, unit = "cm")),
              plot.subtitle = element_text(size = basesize),
              plot.caption = element_text(face = "italic", size = basesize * 0.6),
              panel.border = element_rect(fill = NA, size = 0.2),
              strip.background = element_rect(fill = "gray80", color = "black", size = 0.2),
              strip.text = element_text(size = basesize, color = "black", face = "bold", margin = margin(t = 0.2, b = 0.2, l = 0.2, r = 0.2, unit = "cm")),
              panel.background = element_rect(size = 0.2),
              panel.grid.major = element_line(color = "gray70", size = 0.15),
              panel.grid.minor = element_line(color = "gray90", size = 0.1),
              axis.title = element_text(face = "bold", size = basesize),
              axis.title.y = element_text(angle = 90, margin = margin(t = 0, r = 0.5, b = 0, l = 0, unit = "cm")),
              axis.title.x = element_text(margin = margin(t = 0.5, r = 0, b = 0, l = 0, unit = "cm")),
              axis.ticks = element_line(size = 0.1),
              axis.ticks.length = unit(0.1, "cm"),
              legend.title = element_text(size = basesize * 1.1, face = "bold", hjust = 0, margin = margin(t = 0, b = 0, l = 0, r = 0, unit = "cm")),
              plot.margin = margin(0.5, 0.5, 0.5, 0.5, unit = "cm"),
              legend.margin = margin(t=-10, b=0, r=0, l=0))
  }


p.data <- read_csv(here::here("Data/Chapter-Protests/protest-data-final.csv")) %>% 
  group_by(ccode) %>% 
  arrange(ccode, year) %>% 
  mutate(log_troops_lag = lag(log_troops, order_by = year),
         troops_lag = lag(troops, order_by = year),
         anti_us_protest_lag = lag(anti_us_protest),
         troops_cumsumtest_unlagged= cumsum(coalesce(troops, 0)),
         troops_cumsumtest_lagged = lag(cumsum(coalesce(troops, 0)), length = 2),
         troops_cumsumtest = log1p(lag(cumsum(troops), length = 2)),
         troops_cumsum = log1p(lag(cumsum(coalesce(troops, 0)), length = 2))) %>% # Make sure to not drop Germany. This finds the first non-missing value in the vector and replacing the missing values with that. Should help bridge the gap with the missing values since the data start in the late 1980s.
  ungroup() %>% 
  mutate(log_troops_lag_z = arm::rescale(log_troops_lag),
         log_troops_z = arm::rescale(log_troops),
         log_troops_cumsum_z = arm::rescale(troops_cumsum)) %>% 
  group_by(year) %>% 
  mutate(troop.prop = troops/sum(troops, na.rm = TRUE))


# Make sure all countries are represented if they should be. Germany I'm looking at you!
ccodecheck <- p.data %>% 
  dplyr::select(ccode, countryname, year, troops, starts_with("troops_cumsum"), log_troops_lag_z, log_troops_z, log_troops_cumsum_z) %>% 
  filter(ccode == 255)

checkNA <- p.data %>% 
  filter(is.na(troops) & !is.na(lag(troops))) %>% 
  dplyr::select(ccode, year)
  
  
# Load opinion data for individual-level protest models.
load(here::here("Data/General/opinion.data.RData")) 

o.data <- o.data %>% 
  mutate(protest_dummy = ifelse(protest == "Never", 0,
                                ifelse(protest == "Don't know/Decline to answer", NA, 1)),
         protest_dummy = factor(protest_dummy, levels = c(0, 1), labels = c("No", "Yes")),
         log_basecount = log1p(basecount))


# Generate random binomial variable based on representative group variables and country.
# Use this to create a random training sample and then a test sample for the predictions.
prediction.data <- o.data %>% 
  group_by(country, age, gender, income.5.cat) %>% 
  mutate(sample.group = rbinom(n(), size = 1, prob = 0.7),
         sample.group = factor(sample.group, levels = c(0, 1), labels = c("Test", "Training")))

training.data <- prediction.data %>% 
  filter(sample.group == "Training")


# Note that we have to refactor the levels for troops_crime_pers and protest_dummy.
# Because there are levels in the data that aren't in the model it thinks we're trying to force a new
# factor level into the test data. Stan models can only do this for population-level effects when those factors levels are estimated in the model itself.
test.data <- prediction.data %>% 
  ungroup() %>% 
  filter(sample.group == "Test") %>% 
  mutate(protest_dummy = factor(protest_dummy, levels = c("Yes", "No")),
         troops_crime_pers = factor(troops_crime_pers, levels = "Yes", "No"))


# Set Seed
SEED <- 66502
set.seed(seed = SEED)

```

# Hypotheses

1.  Hypothesis 1b. All else being equal, anti-US base protests are less
    likely to occur when there are more US servicemembers in a country

2.  Hypothesis 1c. All else being equal, anti-US base protests are less
    likely to occur when there is an internal rebellion in the host
    country.

3.  Hypothesis 1d. All else being equal, anti-US base protests are less
    likely to occur when there are high levels of external threat
    against the host country.

4.  Hypothesis 1e. All else being equal, anti-US base protests are more
    likely to occur when there is economic downturn in the host country.

5.  Hypothesis 1f. Anti-US base protests are more likely to occur in
    states that have medium levels of political openness.

6.  Hypothesis 1g. All else being equal, anti-US base protests are less
    likely to occur when there are there are high levels of other,
    unrelated protests occurring in the host country.

7.  Hypothesis (NEW): All else being equal, anti-US base protests are
    more likely to occur in countries that are democratizing.

Note that Protest Count is the total protests minus anti-US and
anti-troop protest events

# Descriptive Figures

```{r echo = FALSE, dpi=400}


# Density plot for anti-US protests
us.hist <- ggplot(data = p.data %>% filter(!is.na(anti_us_protest)), aes(x = anti_us_protest)) +
  geom_histogram(alpha = 0.8, color = "black", size = 0.2, binwidth = 1) +
  theme_flynn() +
  viridis::scale_fill_viridis(option = "magma", begin = 0.2, end = 0.2) +
  scale_x_continuous(breaks = seq(0,20,1)) +
  scale_y_continuous(limits = c(0, 5000)) +
  labs(x = "Count",
       y = "Density",
       title = "Anti-US protest events")

# Density plot for anti-US protests
mil.hist <- ggplot(data = p.data %>% filter(!is.na(anti_us_mil)), aes(x = anti_us_protest)) +
  geom_histogram(alpha = 0.8, color = "black", size = 0.2, binwidth = 1) +
  theme_flynn() +
  viridis::scale_fill_viridis(option = "magma", begin = 0.2, end = 0.2) +
  scale_x_continuous(breaks = seq(0,20,1)) +
  scale_y_continuous(limits = c(0, 5000)) +
  labs(x = "Count",
       y = "Density",
       title = "Anti-US military protest events")

# Density plot for non-US protest events
other.hist <- ggplot(data = p.data %>% filter(!is.na(protest_other)), aes(x = protest_other)) +
  geom_histogram(alpha = 0.8, color = "black", size = 0.2, binwidth = 1) +
  theme_flynn() +
  viridis::scale_fill_viridis(option = "magma", begin = 0.2, end = 0.2) +
  scale_x_continuous(breaks = seq(0,20,1), limits = c(-0.5, 20)) +
  scale_y_continuous(limits = c(0, 5000)) +
  labs(x = "Count",
       y = "Density",
       title = "Non-US protest events")


protest.hist <- wrap_plots(us.hist, mil.hist, other.hist, ncol = 1) +
  plot_layout(guides = "collect") &
  plot_annotation(title = "Protest Event Counts, 1990-2018") &
  theme_flynn() &
  theme(plot.title = element_text(),
        plot.margin = margin(0.1, 0.1, 0.1, 0.1, unit = "cm"))
  
ggsave(here("Figures/chapter-Protests/fig-histogram-protests.png"), width = 5, height = 7, units = "in")
ggsave(here("Figures/chapter-Protests/fig-histogram-protests.jpg"), width = 5, height = 7, units = "in")

protest.hist




# Scatterplot of troop deployments and protests
ggplot(data = p.data, aes(x = troops, y = anti_us_protest)) +
  geom_jitter(width = 1, height = 1, alpha = .3) +
  theme_linedraw() +
  labs(x = "US troop deployment size",
       y = "Count",
       title = "Count of anti-US protests")


ggplot(data = p.data, aes(x = troops, y = anti_us_mil)) +
  geom_jitter(width = 1, height = 0.1, alpha = .3) +
  theme_linedraw() +
  labs(x = "US troop deployment size",
       y = "Count",
       title = "Count of anti-US military protests")


# Scatterplot GDP and Protests
ggplot(data = p.data, aes(x = gdp, y = anti_us_protest)) +
  geom_jitter(width = 1, height = 1, alpha = .3) +
  theme_linedraw() +
  labs(x = "Real GDP",
       y = "Count",
       title = "Count of anti-US protests")

ggplot(data = p.data, aes(x = gdp, y = anti_us_mil)) +
  geom_jitter(width = 1, height = 0.1, alpha = .3) +
  theme_linedraw() +
  labs(x = "Real GDP",
       y = "Count",
       title = "Count of anti-US military protests")


# Scatterplot of Polyarchy index and protests
ggplot(data = p.data, aes(x = v2x_polyarchy, y = anti_us_protest)) +
  geom_jitter(width = 0.1, height = 0.5, alpha = 0.3) +
  theme_linedraw() +
  labs(x = "Polyarchy Index",
       y = "Count",
       title = "Count of anti-US protests")

ggplot(data = p.data, aes(x = v2x_polyarchy, y = anti_us_mil)) +
  geom_jitter(width = 0.1, height = 0.1, alpha = 0.3) +
  theme_linedraw() +
  labs(x = "Polyarchy Index",
       y = "Count",
       title = "Count of anti-US military protests")


# Scatterplot of idealpointdistance and protest
ggplot(data = p.data, aes(x = idealdistance_2, y = anti_us_protest)) +
  geom_jitter(width = 0.1, height = 0.5, alpha = 0.3) +
  theme_linedraw() +
  labs(x = "UN Ideal Point Distance from US",
       y = "Count",
       title = "Count of anti-US protests")

ggplot(data = p.data, aes(x = idealdistance_2, y = anti_us_mil)) +
  geom_jitter(width = 0.1, height = 0.1, alpha = 0.3) +
  theme_linedraw() +
  labs(x = "UN Ideal Point Distance from US",
       y = "Count",
       title = "Count of anti-US military protests")





```

# DAGs

## Protest DAG

```{r, protest-dag,  echo = FALSE, dpi=400}
library(tidygraph)
library(latex2exp)
library(dagitty)
library(ggraph)
# Draw DAG for Protest Count

coords <- list(x = c(Protest = 6, Troops = 5, Growth = 1, GDP = 0, Trade = 1, Population = 0, Regime = 3, Conflict = 1, Ally = 3),
               y = c(Protest = 6, Troops = 4, Growth = 4, GDP = 5, Trade = 2, Population = 7, Regime = 8, Conflict = 8, Ally = 4))

daglabels <- c(Protest = "Protest", Troops = "Troops[t-1]", Growth = "Growth", GDP = "GDP", Trade = "Trade", Population = "Population BIG", Regime = "Regime Type", Conflict = "War", Ally = "Alliance")

dagbase <- dagify(Protest ~ Troops + Growth + Population + Regime + Conflict,
                  Troops ~ Regime + Conflict + Ally + Trade,
                  Ally ~ Trade + GDP + Regime,
                  Trade ~ Ally + GDP + Regime,
                  GDP ~ Trade + Population + Conflict,
                  Growth ~ Conflict + Trade + GDP,
                  Regime ~ Conflict,
                  exposure = "Troops",
                  outcome = "Protest",
                  coords = coords,
                  labels = daglabels) %>% 
  tidy_dagitty() 

ggdag(dagbase)

dagbase2 <- dagitty(' dag{
                    "Troops[t]" [exposure]
                    "Protest[t]" [outcome]
                    
                    "Protest[t-1]" [pos="1,0"]
                    "Troops[t-1]" [pos = "0,-0.5"]
                    "Threat[t-1]" [pos="-1.1,1.5"]
                    "Growth[t-1]" [pos="-1,3"]
                    "Population[t-1]" [pos="-1.25,0"]
                    "Regime[t-1]" [pos="-1.25,-1.5"]
                    "GDP[t-1]" [pos="-1.1,-3"]
                    "Rebellion[t-1]" [pos="-0.75,-6"]
                    "Trade[t-1]" [pos="-0.5,-7"]
                    "Ally[t-1]" [pos="-1,-4.5"]
                    "Alignment[t-1]" [pos="-0.75,4.5"]
                    "ProtestEnvironment[t-1]" [pos="0,6"]
                    "USWar[t-1]" [pos="0,-8"]

                    "Protest[t]" [pos="5,0"]
                    "Troops[t]" [pos = "4,-0.5"]
                    "Threat[t]" [pos="2.9,1.5"]
                    "Growth[t]" [pos="3,3"]
                    "Population[t]" [pos="2.75,0"]
                    "Regime[t]" [pos="2.75,-1.5"]
                    "GDP[t]" [pos="2.9,-3"]
                    "Rebellion[t]" [pos="3.25,-6"]
                    "Trade[t]" [pos="3.5,-7"]
                    "Ally[t]" [pos="3,-4.5"]
                    "Alignment[t]" [pos="3.25,4.5"]
                    "ProtestEnvironment[t]" [pos="4,6"]
                    "USWar[t]" [pos="4,-8"]
                    
                    "Protest[t-1]" -> "Protest[t]"
                    "ProtestEnvironment[t-1]" -> "ProtestEnvironment[t]"
                    "Troops[t-1]" -> "Troops[t]"
                    "Population[t-1]" -> "Population[t]"
                    "Regime[t-1]" -> "Regime[t]"
                    "Threat[t-1]" -> "Threat[t]"
                    "GDP[t-1]" -> "GDP[t]"
                    "Growth[t-1]" -> "Growth[t]"
                    "Rebellion[t-1]" -> "Rebellion[t]"
                    "Trade[t-1]" -> "Trade[t]"
                    "Ally[t-1]" -> "Ally[t]"
                    "Alignment[t-1]" -> "Alignment[t]"
                    "ProtestEnvironment[t-1]" -> "ProtestEnvironment[t]"
                    "USWar[t-1]" -> "USWar[t]"
                    
                    
                    "Regime[t]" -> {"Troops[t]" "ProtestEnvironment[t]" "Trade[t]" "Rebellion[t]" "Alignment[t]" "USWar[t]"}
                    "Threat[t]" ->  {"Troops[t]" "Alignment[t]"}
                    "Population[t]" -> "ProtestEnvironment[t]"
                    "Population[t]" -> {"GDP[t]" "Trade[t]"}
                    "Troops[t]" -> {"Protest[t]" "Growth[t]"}
                    "Growth[t]" -> {"ProtestEnvironment[t]" "Protest[t]" "Rebellion[t]"}
                    "Ally[t]" -> {"Troops[t]" "Protest[t]" "Trade[t]" "USWar[t]"}
                    "Trade[t]" -> {"GDP[t]"}
                    "GDP[t]" -> {"Trade[t]" "Rebellion[t]"}
                    "Alignment[t]" -> {"Ally[t]" "USWar[t]" "Protest[t]"}
                    "ProtestEnvironment[t]" -> {"Rebellion[t]" "Protest[t]"}
                    "USWar[t]" -> {"Protest[t]" "Protest[t]"}
                    "Rebellion[t]" -> {"Protest[t]"}


                    "Regime[t-1]" -> {"Troops[t-1]" "ProtestEnvironment[t-1]" "Trade[t-1]" "Rebellion[t-1]" "Alignment[t-1]" "USWar[t-1]"}
                    "Threat[t-1]" ->  {"Troops[t-1]" "Alignment[t-1]"}
                    "Population[t-1]" -> "ProtestEnvironment[t-1]"
                    "Population[t-1]" -> {"GDP[t-1]" "Trade[t-1]"}
                    "Troops[t-1]" -> {"Protest[t-1]" "Growth[t-1]"}
                    "Growth[t-1]" -> {"ProtestEnvironment[t-1]" "Protest[t-1]" "Rebellion[t-1]"}
                    "Ally[t-1]" -> {"Troops[t-1]" "Protest[t-1]" "Trade[t-1]" "USWar[t-1]"}
                    "Trade[t-1]" -> {"GDP[t-1]"}
                    "GDP[t-1]" -> {"Trade[t-1]" "Rebellion[t-1]"}
                    "Alignment[t-1]" -> {"Ally[t-1]" "USWar[t-1]" "Protest[t-1]"}
                    "ProtestEnvironment[t-1]" -> {"Rebellion[t-1]" "Protest[t-1]"}
                    "USWar[t-1]" -> {"Protest[t-1]" "Protest[t-1]"}
                    "Rebellion[t-1]" -> {"Protest[t-1]"}


                    "Troops[t-1]" -> "Protest[t]"
                    "USWar[t-1]" -> "Troops[t]"

                    }') 

dagbasetidy <- tidy_dagitty(dagbase2)

dagbase2 %>% 
  tidy_dagitty() %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) + 
    geom_dag_edges_arc(curvature = 0.05) +
    geom_dag_text(parse = TRUE, color = "black", size = 4) +
    theme_dag_blank()

ggsave(here("/Figures/Chapter-Protests", "figure-protest-dag-troops.png"))
ggsave(here("/Figures/Chapter-Protests", "figure-protest-dag-troops.jpg"))


adjustmentSets(dagbase2)





# Prettier DAG for public consumption in text

dag.pretty <- dagitty(' dag{
                    "Troops[t]" [exposure]
                    "Protest[t]" [outcome]
                    
                    "Protest[t]" [pos="1,1"]
                    "Troops[t]" [pos = "0,0"]
                    "Z[t]" [pos="0,2"]
                    
                    "Protest[t-1]" [pos="-1,1"]
                    "Troops[t-1]" [pos = "-2,0"]
                    "Z[t-1]" [pos="-2,2"]

                    "Protest[t-1]" -> "Protest[t]"
                    "Troops[t]" -> "Protest[t]"
                    "Troops[t-1]" -> "Troops[t]"
                    "Troops[t-1]" -> "Protest[t-1]"
                    "Z[t-1]" -> "Z[t]"
                    "Z[t]" -> "Troops[t]"
                    
                    "Troops[t-1]" -> "Protest[t]"
                    "Z[t-1]" -> "Troops[t-1]"
                    "Z[t-1]" -> "Protest[t-1]"
                    "Z[t]" -> "Protest[t]"

                    }') 


dag.pretty.tidy <- tidy_dagitty(dag.pretty) %>% 
  mutate(.$data, 
         vartype = case_when(
           name == "Troops[t]" ~ "Exposure",
           name == "Protest[t]" ~ "Outcome",
           grepl("Z", name) ~ "Confounders",
           name == "Troops[t-1]" ~ "Lagged Treatment",
           name == "Protest[t-1]" ~ "Lagged Outcome"

         )) %>% 
  dag_label(labels = c("Troops[t]" = "Troops[t]", "Troops[t-1]" = "Troops[t-1]", "Protest[t-1]" = "Protest[t-1]",
                       "Protest[t]" = "Protest[t]", "Z[t]" = "Z[t]", "Z[t-1]" = "Z[t-1]")) 

 
chart <- ggplot(dag.pretty.tidy, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_point(aes(color = vartype)) +
  geom_dag_edges() +
  geom_dag_label_repel(aes(label = label), parse = TRUE) +
  theme_dag_blank() +
  guides(color = FALSE) +
  scale_color_manual(values = c("orange",  "#009E73", muted("dodgerblue1"), muted("009E73"), "dodgerblue1"))



ggsave(here("Figures/Chapter-Protests/fig-dag-protest-simple.png"), width = 8, height = 5, units = "in")

```

# Construct Propensity Score Weights

```{r propensity scores and weights, echo = FALSE}

# Filter data to ensure complete cases on key variables
# Mostly needed this for stan approach
#p.data.complete <- p.data %>% filter(!is.na(anti_us_protest) & !is.na(log_troops_z) & !is.na(log_troops_cumsum_z))


# Do denominator first because it has the most restricted sample. To calculate the weights we need both numerator and denominator values.
ITER = 8000
WARMUP = 4000
CHAINS = 4
CORES = 4
SEED = 66502

get_prior(bf(troops ~ log_troops_lag + log_troops_cumsum_z + (1 | ccode),
                   hu ~ log_troops_lag + log_troops_cumsum_z + (1 | ccode)),
          family = hurdle_lognormal,
          nl = TRUE,
                   data = p.data)

PRIOR.N <- c(set_prior("normal(0,2)", class = "b"),
             set_prior("normal(1,2)", class = "Intercept"),
             set_prior("gamma(1,1)", class = "sd"),
             set_prior("gamma(1,1)", class = "sd", group = "ccode"),
             set_prior("gamma(1,1)", class = "sd", coef = "Intercept", group = "ccode"),
             set_prior("gamma(1,1)", class = "sigma"))

m.numerator <- brm(troops ~ log_troops_lag + log_troops_cumsum_z + (1 | ccode),
                   hu ~ log_troops_lag + log_troops_cumsum_z + (1 | ccode),
                   data = p.data,
                   prior = PRIOR.N,
                   family = hurdle_lognormal(),
                   iter = ITER,
                   warmup = WARMUP,
                   chains = CHAINS,
                   cores = CORES,
                   seed = SEED,
                   file_refit = "on_change",
                   save_model = here::here("Output/Chapter-Protests/model-numerator.stan"),
                   file = here::here("Output/Chapter-Protests/model-numerator"),
                   control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
                   backend = "cmdstanr")

num.check <- brms::pp_check(m.numerator)

  num.check +
    scale_x_continuous(trans = "log1p")


  #### Denominator Model ####


# Adjustment set
# { Alignment[t], Ally[t], GDP[t], Growth[t-1], Population[t], ProtestEnvironment[t-1], Protest[t-1], Rebellion[t-1], Regime[t], Troops[t-1], USWar[t] }

get_prior(bf(troops ~ log_troops_lag + log_troops_cumsum_z + idealdistance_2_z + us_ally + gdp_z + gdp_growth_z + pop_z + log1p(protest_other) + anti_us_protest_lag + lag(conflict_dummy) + v2x_polyarchy_z + us_war + s(year) + (1 | ccode),
                      hu ~ log_troops_lag + log_troops_cumsum_z + idealdistance_2_z + us_ally + gdp_z + gdp_growth_z + pop_z + log1p(protest_other) + anti_us_protest_lag + lag(conflict_dummy) + v2x_polyarchy_z + us_war + s(year) + (1 | ccode)),
          family = hurdle_lognormal,
          nl = TRUE,
                   data = p.data)
  
PRIOR.D <- c(set_prior("normal(0,2)", class = "b"),
             set_prior("normal(1,2)", class = "Intercept"),
             set_prior("gamma(1,1)", class = "sd"),
             set_prior("gamma(1,1)", class = "sd", group = "ccode"),
             set_prior("gamma(1,1)", class = "sd", coef = "Intercept", group = "ccode"),
             set_prior("gamma(1,1)", class = "sigma"))

m.denominator <-  brm(troops ~ log_troops_lag + log_troops_cumsum_z + idealdistance_2_z + us_ally + gdp_z + gdp_growth_z + pop_z + log1p(protest_other) + anti_us_protest_lag + lag(conflict_dummy) + v2x_polyarchy_z + us_war + s(year, bs = "cr", k = 20) + (1 | ccode),
                      hu ~ log_troops_lag + log_troops_cumsum_z + idealdistance_2_z + us_ally + gdp_z + gdp_growth_z + pop_z + log1p(protest_other) + anti_us_protest_lag + lag(conflict_dummy) + v2x_polyarchy_z + us_war + s(year, bs = "cr", k = 20) + (1 | ccode),
                   data = p.data,
                   prior = PRIOR.D,
                   family = hurdle_lognormal(),
                   iter = ITER,
                   warmup = WARMUP,
                   chains = CHAINS,
                   cores = CORES,
                   seed = SEED,
                   file_refit = "on_change",
                   save_model = here::here("Output/Chapter-Protests/model-denominator.stan"),
                   file = here::here("Output/Chapter-Protests/model-denominator"),
                   control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
                   backend = "cmdstanr")

den.check <- brms::pp_check(m.denominator)

den.check + 
  scale_x_continuous(trans = "log1p")

#### Numerator and Denominator 

# Set hurdle value (i.e. proportion of 0s)
hu.val <- round(length(p.data$troops[p.data$troops==0])/length(p.data$troops), 2)


p.data$numerator <- brms::dhurdle_lognormal(x = p.data$log_troops_z, 
                          mu = predict(m.numerator, newdata = p.data, allow_new_levels = TRUE)[, 1], 
                          sigma = sd(residuals(m.numerator, newdata = p.data, allow_new_levels = TRUE)[, 1], na.rm = TRUE),
                          hu = hu.val)

p.data$denominator <- brms::dhurdle_lognormal(x = p.data$log_troops_z, 
                          mu = predict(m.denominator, newdata = p.data, allow_new_levels = TRUE)[, 1], 
                          sigma = sd(residuals(m.denominator, newdata = p.data, allow_new_levels = TRUE)[, 1], na.rm = TRUE),
                          hu = hu.val)

p.data <- p.data %>% 
  mutate(iptw = numerator/denominator) %>% 
  group_by(ccode) %>% 
  mutate(iptw.prod = cumprod(replace(iptw, is.na(iptw), 1)),
         iptw.10 = ifelse(iptw.prod > 10, 10, iptw.prod),
         iptw.50 = ifelse(iptw.prod > 50, 50, iptw.prod),
         iptw.100 = ifelse(iptw.prod > 100, 100, iptw.prod),
         iptw.1000 = ifelse(iptw.prod > 1000, 1000, iptw.prod))



iptw.10.df <- p.data %>% dplyr::select(ccode, anti_us_protest, anti_us_mil, log_troops_z, log_troops_cumsum_z, iptw.10) 
iptw.50.df <- p.data %>% dplyr::select(ccode, anti_us_protest, anti_us_mil, log_troops_z, log_troops_cumsum_z, iptw.50) 
iptw.100.df <- p.data %>% dplyr::select(ccode, anti_us_protest, anti_us_mil, log_troops_z, log_troops_cumsum_z, iptw.100) 
iptw.1000.df <- p.data %>% dplyr::select(ccode, anti_us_protest, anti_us_mil, log_troops_z, log_troops_cumsum_z, iptw.1000) 

#iptw.100000.df <- p.data %>% dplyr::select(ccode, anti_us_protest, anti_us_mil, log_troops_z, log_troops_cumsum_z, iptw.100000) 

iptw.list <- list(iptw.10.df, iptw.50.df, iptw.100.df, iptw.1000.df)

iptw.list <- lapply(iptw.list, function(x) {setNames(x, gsub(".*iptw.*", "iptw", names(x)))})

save(iptw.list, file = here("Data/Chapter-Protests/treatment-weight.RData"))



```

# Country-Year Models

## Anti-US protest models

### NBREG


These models look at the average treatment effect of US deployments

```{r ate-us-protest-models, echo = FALSE, }

# Conflicted pckage really fucks things up

load(here("Data/Chapter-Protests/treatment-weight-20211230.RData"))

job::job(import = "auto", us.ate.com = {

PRIOR <- c(set_prior("student_t(3.5, 0, 1)", class = "b", coef = "log_troops_z"),
           set_prior("student_t(3.5, 0, 2)", class = "b", coef = "log_troops_cumsum_z"),
           set_prior("student_t(3.5, 0, 3)", class = "Intercept"),
           set_prior("gamma(1, 1)", class = "shape"))

ITER <- 5000
WARMUP <-  2000
CORES <- 4
CHAINS <- 4
THIN <- 1
SEED <- 66502

#### Anti-US Protest Models with different IPTW scores ####
#### Note that the cumulative sum is for a two period lag ####

ate.troops <- bf(anti_us_protest | weights(iptw) ~ log_troops_z + log_troops_cumsum_z + (1 | ccode))

us.ate.com <- brm_multiple(ate.troops,
                           data = iptw.list,
                           family = negbinomial(),
                           combine = FALSE,
                           iter = ITER,
                           warmup = WARMUP,
                           prior = PRIOR,
                           chains = CHAINS,
                           cores = CORES,
                           thin = THIN,
                           silent = 0,
                           seed = SEED,
                           control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
                           backend = "cmdstanr")

save(us.ate.com, file = here::here("Output/Chapter-Protests/us-ate-com.20211230.RData"))

}
)

```


```{r ate-mil-protest-models}

# Load propensity score data
load(here("Data/Chapter-Protests/treatment-weight-20211230.RData"))

job::job(import = "auto", ate.troops.mil = {
#### Anti-US Military Protest Models with different IPTW scores ####
#### Note that the cumulative sum is for a two period lag ####

PRIOR <- c(set_prior("student_t(3.5, 0, 1)", class = "b", coef = "log_troops_z"),
           set_prior("student_t(3.5, 0, 2)", class = "b", coef = "log_troops_cumsum_z"),
           set_prior("student_t(3.5, 0, 3)", class = "Intercept"),
           set_prior("gamma(1, 1)", class = "shape"))

ITER <- 5000
WARMUP <-  2000
CORES <- 4
CHAINS <- 4
THIN <- 1
SEED <- 66502

  
ate.troops.mil <- bf(anti_us_mil | weights(iptw) ~ log_troops_z + log_troops_cumsum_z + (1 | ccode))

mil.ate.com <- brm_multiple(ate.troops.mil,
                           data = iptw.list,
                           family = negbinomial(),
                           combine = FALSE,
                           iter = ITER,
                           warmup = WARMUP,
                           prior = PRIOR,
                           chains = CHAINS,
                           cores = CORES,
                           thin = THIN,
                           seed = SEED,
                           control = list(adapt_delta = 0.80,
                                          max_treedepth = 10),
                           backend = "cmdstanr")

save(mil.ate.com, file = here::here("Output/Chapter-Protests/mil.ate.com.20211230.RData"))

}
)

```

### Figures for Average Treatment Effect

```{r Average Treatment Effect Figures}

load(here("Output/Chapter-Protests/us-ate-com.20211230.RData"))
load(here("Output/Chapter-Protests/mil.ate.com.20211230.RData"))


ate.us <- lapply(us.ate.com, function(x) {
  
  temp <- gather_draws(x,
                       b_log_troops_z,
                       b_log_troops_cumsum_z,
                       ndraws = 10000) %>% 
    mutate(model = glue::glue("IPTW {max(x$data$iptw)}"))
}
)

ate.mil <- lapply(mil.ate.com, function(x) {
  
  temp <- gather_draws(x,
                       b_log_troops_z,
                       b_log_troops_cumsum_z,
                       ndraws = 10000) %>% 
    mutate(model = glue::glue("IPTW {max(x$data$iptw)}"))
}
)

ate.com <- c("Anti-US Protests" = ate.us, 
             "Anti-US Military" = ate.mil)

ate.fig.com <- data.table::rbindlist(ate.com, idcol = TRUE) %>% 
  mutate(.id = gsub("\\d", "", .id),
         .id = factor(.id, levels = c("Anti-US Protests", "Anti-US Military")),
         .variable = factor(.variable, levels = c("b_log_troops_cumsum_z", "b_log_troops_z"),
                            labels = c("Cumulative Troops", "Troops")),
         grouping = factor(glue::glue("{.id}, {.variable}")),
         model = factor(model, levels = c("IPTW 1000", "IPTW 100", "IPTW 50", "IPTW 10")))




#### Plot Troops ATE on Protest ####
ggplot(ate.fig.com , aes(x = .value, y = .variable, group = model)) +
  ggdist::stat_pointinterval(.width = c(0.50, 0.80, 0.95),
                    position = position_dodge(width = 1), 
                    point_size = 3.8,
                    interval_size_range = c(1, 2.5, 4),
                    scale = 1.4,
                    aes(color = model)) +
  viridis::scale_color_viridis(option = "magma", begin = 0.1, end = 0.9, discrete = TRUE) +
  viridis::scale_fill_viridis(option = "magma", begin = 0.1, end = 0.9, discrete = TRUE) +
  geom_vline(xintercept = 0) +
  facet_wrap(.~.id, ncol = 1, scales = "free_y") +
  theme_flynn() +
  theme(plot.title.position = "plot",
        plot.title = element_text(size = basesize * 1.3),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = basesize * 1.1),
        axis.text.x = element_text(size = basesize * 1.1),
        axis.title.x = element_text(size = basesize * 1.1),
        axis.title.y = element_blank(),
        legend.text = element_text(size = basesize * 1.1),
        legend.title = element_text(lineheight = 0.4)) +
  guides(fill = FALSE,
         color = guide_legend(reverse = TRUE)) +
  labs(x = "ATE Estimate",
       y = "",
       color = "IPTW Truncation\nPoint",
       title = "Average Treatment Effect Estimate for US Troop Deployments")


  ggsave(here::here("Figures/Chapter-Protests/figure-ate-troops.jpg"), height = 6, width = 6, unit = "in")
  
  ate.pd <- ate.fig.com %>% 
    group_by(.id, .variable, model) %>% 
    summarise(median = round(median(.value), 2),
              pd = round(as.numeric(paste0(bayestestR::pd(.value))), 2))



  # Plot predicted values to help show the substantive magnitude of the effects  
newdata <- expand_grid(ccode = 732,
                       log_troops_z = seq_range(p.data$log_troops_z, 50),
                       log_troops_cumsum_z = mean(p.data$log_troops_cumsum_z, na.rm = TRUE))


tidy.pred <- lapply(us.ate.com, function(x) {
  
  temp.1 <- x %>% 
    epred_draws(newdata = newdata,
              re_forumla = ~(1 | country) ,
              seed = 123,
              ndraws = 100) %>% 
    mutate(medianline = median(.epred))

}
)


# Anti-US Protests
# Have to unscale the x axis values
plot.1 <- ggplot(tidy.pred[[1]], aes(x = exp(log_troops_z*2*sd(p.data$log_troops, na.rm = TRUE) + mean(p.data$log_troops, na.rm = TRUE)), y = .epred, group = .draw)) +
  geom_line(alpha = 0.4, color = "gray70") +
  geom_line(aes(y = medianline), size = 1) +
  scale_y_continuous(limits = c(-0.5, 13)) +
  scale_x_continuous(labels = comma_format()) +
  theme_flynn() + 
  theme(axis.title = element_text(size = basesize*0.9, margin = margin(0.1, 0.1, 0.1, 0.1, unit = "cm"))) +
  labs(x = "Troops",
       y = "Predicted Protest Count",
       title = "Anti-US Protests")
  
  ggsave(here::here("Figures/Chapter-Protests/figure-predicted-antius-protests.jpg"), height = 4, width = 5, unit = "in")
  
plot.2 <- # Have to unscale the x axis values
ggplot(tidy.pred[[3]], aes(x = exp(log_troops_z*2*sd(p.data$log_troops, na.rm = TRUE) + mean(p.data$log_troops, na.rm = TRUE)), y = .epred, group = .draw)) +
  geom_line(alpha = 0.4, color = "gray70") +
  geom_line(aes(y = medianline), size = 1) +
  scale_y_continuous(limits = c(-0.5, 13)) +
  scale_x_continuous(labels = comma_format()) +
  theme_flynn() + 
  theme(axis.title = element_text(size = basesize*0.9, margin = margin(0.1, 0.1, 0.1, 0.1, unit = "lines"))) +
  labs(x = "Troops",
       y = "Predicted Protest Count",
       title = "Anti-US Military Protests")
  
  ggsave(here::here("Figures/Chapter-Protests/figure-predicted-antiusmil-protests.jpg"), height = 4, width = 5, unit = "in")
  
  
  # Combine plots into one
  wrap_plots(plot.1, plot.2, ncol = 1) +
    plot_annotation(title = "Predicted Protest Counts",
                    theme = theme(plot.title = element_text(family = "oswald", face = "bold", size = basesize * 1.5)))

    ggsave(here::here("Figures/Chapter-Protests/figure-predicted-protests-combined.jpg"), height = 6, width = 5, unit = "in")

```



### Book Country Models

```{r anti-us models}

# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)
VAGUEPRIOR <- c(set_prior("normal(0, 2)", class = "b"),
                set_prior("normal(0, 10)", class = "Intercept"))

ITER <- 3000
WARMUP <-  1500
CORES <- 4
CHAINS <- 4
THIN <- 1
SEED <- 66502



# Base model
us.1 <- brm(anti_us_protest ~ log_troops_z +
              v2x_polyarchy_z +
              gdp_z + 
              gdp_growth_z +
              pop_z +
              protest_other_z +
              conflict_dummy +
              us_war + 
              us_war_w_mean +
              us_ally + 
              defburden_w_mean_z +
              anti_us_protest_w_mean_z + 
              (1 | ccode),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.85),
              backend = "cmdstanr",
            file = here::here("Output/Chapter-Protests/us.1.base"))

# Interaction model
us.2 <- brm(anti_us_protest ~ log_troops_z +
              v2x_polyarchy_z +
              v2x_polyarchy_z_sq +
              gdp_z + 
              gdp_growth_z +
              log_troops_z:gdp_growth_z +
              pop_z +
              protest_other_z +
              conflict_dummy +
              us_war + 
              us_war_w_mean +
              us_ally + 
              defburden_w_mean_z +
              anti_us_protest_w_mean_z + 
              (1 | ccode),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.85),
            backend = "cmdstanr",
            file = here::here("Output/Chapter-Protests", "us.2.base"))


mil.1 <- brm(anti_us_mil ~ log_troops_z +
              v2x_polyarchy_z +
              gdp_z + 
              gdp_growth_z +
              pop_z +
              protest_other_z +
              conflict_dummy +
              us_war + 
              us_war_w_mean +
              us_ally + 
              defburden_w_mean_z +
              anti_us_protest_w_mean_z + 
              (1 | ccode),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.85),
            backend = "cmdstanr",
            file = here::here("Output/Chapter-Protests", "mil.1.base"))

# Base model
mil.2 <- brm(anti_us_mil ~ log_troops_z +
              v2x_polyarchy_z +
              v2x_polyarchy_z_sq +
              gdp_z + 
              gdp_growth_z +
              log_troops_z:gdp_growth_z +
              pop_z +
              protest_other_z +
              conflict_dummy +
              us_war + 
              us_war_w_mean +
              us_ally + 
              defburden_w_mean_z +
              anti_us_protest_w_mean_z + 
              (1 | ccode),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.85),
            backend = "cmdstanr",
            file = here::here("Output/Chapter-Protests", "mil.2.base"))


```

Making tables for the basic regression tables

```{r tables}

us.1.base <- readRDS("C:/Users/flynn/Dropbox/Projects/Minerva grant documents/Book/Output/Chapter-Protests/us.1.base.rds")
us.2.base <- readRDS("C:/Users/flynn/Dropbox/Projects/Minerva grant documents/Book/Output/Chapter-Protests/us.2.base.rds")
mil.1.base <- readRDS("C:/Users/flynn/Dropbox/Projects/Minerva grant documents/Book/Output/Chapter-Protests/mil.1.base.rds")
mil.2.base <- readRDS("C:/Users/flynn/Dropbox/Projects/Minerva grant documents/Book/Output/Chapter-Protests/mil.2.base.rds")

model.list <- list(us.1.base, us.2.base, mil.1.base, mil.2.base)

tic()
loo.1 <- loo(us.1.base)
loo.2 <- loo(us.2.base)
loo.3 <- loo(mil.1.base)
loo.4 <- loo(mil.2.base)
toc()


class(model.list[[1]]) = c("custom", class(model.list[[1]]))
class(model.list[[2]]) = c("custom", class(model.list[[2]]))
class(model.list[[3]]) = c("custom", class(model.list[[3]]))
class(model.list[[4]]) = c("custom", class(model.list[[4]]))

addedrows <- tribble(~term, ~`Model 1`, ~`Model 2`, ~`Model 3`, ~`Model 4`,
                     "LOOIC", loo.1[["estimates"]][[3]], loo.2[["estimates"]][[3]], loo.3[["estimates"]][[3]], loo.4[["estimates"]][[3]])
  

coef.list <- c("log_troops_z" = "Troop Deployment", "v2x_polyarchy_z" = "Polyarchy Score", "v2x_polyarchy_z_sq" = "Polyarchy Squared",
               "gdp_z" = "GDP", "gdp_growth_z" = "Growth", "log_troops_z:gdp_growth_z" = "Troop Deployment × Growth", "pop_z" = "Population",
               "protest_other_z" = "Protest Environment", "conflict_dummy" = "Domestic Conflict", "us_war" = "US War", "us_war_w_mean" = "US War (Spatial)", "us_ally" = "US Ally", "defburden_w_mean_z" = "Regional Security Environment", "anti_us_protest_w_mean_z" = "Anti-US Protests (Spatial)", "(Intercept)" = "Intercept")

tidy.custom = broom.mixed:::tidy.brmsfit

glance.custom = function(x, ...) {
  ret <- data.frame(
    "Link" = x$family$link,
    "Family" = x$family$family,
    "N" = nrow(x$data),
    `Num Groups (Country)` = summary(x)$ngrps$ccode,
    "Std. Dev. Country" = summary(x)$random$ccode[1]
  )
  colnames(ret) <- c("Link", "Family", "N", "Num Groups (Country)", "Std. Dev. Country")
  ret
}


reg.tables.1 <- modelsummary(model.list,
                           statistic = "conf.int",
                           stars = FALSE,
                           coef_map = coef.list,
                           add_rows = addedrows,
                           caption = "Bayesian multilevel negative binomial regressions modeling anti-US protest events \\label{tab:antiusprotesteventmodels}",
                           output = "latex") 

reg.tables.2 <- reg.tables.1 %>%  
  kable_styling(latex_options = c("striped", "repeat_header"), protect_latex = TRUE, font_size = 8, position = "center") %>% 
  add_header_above(c(" ", "Anti-US" = 2, "Anti-US Military" = 2)) %>% 
  save_kable(., file = here("Tables/Chapter-Protests/model-country-protest-descriptive.tex"),
             keep_tex = TRUE)



```

#### Posterior Predictive Checks

```{r}
NSAMPLES <- 1000

p_value <- function(x) mean(x > max(y), na.rm = TRUE)

# Posterior Predictive Checks
y <- p.data %>% 
  dplyr::select(anti_us_protest) %>% 
  filter(!is.na(anti_us_protest)) %>% 
  as.vector()

y.max = max(y)

y.rep.1 <- brms::posterior_predict(us.1.base, nsamples = NSAMPLES)


p.value.us.1 <- apply(y.rep.1, 1, p_value) %>% 
  as.data.frame() %>%
  dplyr::rename("x" = 1) %>% 
  mutate(above = ifelse(x > 0, 1, 0)) %>% 
  dplyr::summarise(pvalue = sum(above, na.rm = TRUE)/1000)

hist(p.value.us.1)

```



### Country Model Coefficient Plots

```{r country coefficient plots} 

us.1 <- readRDS(here::here("Output/Chapter-Protests/us.1.base.rds"))
us.2 <- readRDS(here::here("Output/Chapter-Protests/us.2.base.rds"))
mil.1 <- readRDS(here::here("Output/Chapter-Protests/mil.1.base.rds"))
mil.2 <- readRDS(here::here("Output/Chapter-Protests/mil.2.base.rds"))

coefplot.us.1 <- us.1 %>% 
  gather_draws(`b_.*`, regex = TRUE) %>% 
  filter(.variable != "b_Intercept") %>% 
  mutate(model = "Model 1",
         DV = "Anti-US Protest",
         group = paste(model, DV, sep = ": "))

coefplot.us.2 <- us.2 %>% 
  gather_draws(`b_.*`, regex = TRUE) %>% 
  filter(.variable != "b_Intercept") %>% 
  mutate(model = "Model 2",
         DV = "Anti-US Protest",
         group = paste(model, DV, sep = ": "))

coefplot.mil.1 <- mil.1 %>% 
  gather_draws(`b_.*`, regex = TRUE) %>% 
  filter(.variable != "b_Intercept") %>% 
  mutate(model = "Model 3",
         DV = "Anti-US Military",
         group = paste(model, DV, sep = ": "))

coefplot.mil.2 <- mil.2 %>% 
  gather_draws(`b_.*`, regex = TRUE) %>% 
  filter(.variable != "b_Intercept") %>% 
  mutate(model = "Model 4",
         DV = "Anti-US Military",
         group = paste(model, DV, sep = ": "))

coefplot.combined <- bind_rows(coefplot.us.1, coefplot.us.2, coefplot.mil.1, coefplot.mil.2) %>% 
  mutate(group = factor(group, levels = c("Model 1: Anti-US Protest", "Model 2: Anti-US Protest", "Model 3: Anti-US Military", "Model 4: Anti-US Military"))) %>% 
  mutate(.variable = factor(.variable, 
                            levels = c("b_log_troops_z", "b_log_troops_z:gdp_growth_z", "b_us_war", "b_us_war_w_mean", "b_us_ally", "b_conflict_dummy", "b_defburden_w_mean_z", "b_v2x_polyarchy_z", "b_v2x_polyarchy_z_sq", "b_anti_us_protest_w_mean_z", "b_protest_other_z", "b_pop_z", "b_gdp_z", "b_gdp_growth_z"),
                            labels = c("Troops", "Troops X Growth", "US War", "US War (Regional)", "US Ally", "Domestic Conflict", "Regional Security Environment", "Polyarchy", "Polyarchy Squared", "Anti-US Protest (Regional)", "Protest Environment", "Population", "GDP", "Growth")),
         .variable = forcats::fct_rev(.variable),
         group = forcats::fct_rev(factor(group)))


ggplot(coefplot.combined, aes(x = .value, y = .variable, color = group, group = group)) +
  ggdist::stat_pointinterval(.width = c(0.50, 0.80, 0.95), position = position_dodge(width = 0.75)) +
  geom_vline(xintercept = 0, width = 1.2, color = "black") +
  viridis::scale_color_viridis(option = "magma", begin = 0.1, end = 0.9, discrete = TRUE) +
  theme_flynn() +
  theme(axis.text = element_text(size = basesize * 1.3),
        legend.text = element_text(size = basesize * 1.3, margin = margin(l = -0.1, unit = "cm")),
        legend.title = element_text(size = basesize * 1.3, margin = margin(b = -0.2, unit = "cm")),
        legend.position = "bottom",
        plot.title = element_text(size = basesize * 1.5),
        plot.title.position = "plot",
        axis.title.x = element_text(size = basesize * 1.3)) +
  guides(color = guide_legend(reverse = TRUE, ncol = 1)) +
  labs(x = "Coefficient Estimate",
       y = "",
       color = "Model",
       title = "Coefficient Plot for Anti-US Protest Events")

ggsave(here("Figures/Chapter-Protests/fig-country-coefficients.jpg"), width = 6, height = 9, units = "in")

country.pd <- coefplot.combined %>% 
  group_by(.variable, model, DV) %>% 
  dplyr::summarise(median = round(median(.value), 2),
                   pd = round(as.numeric(paste0(bayestestR::pd(.value))), 2))


```












These models focus on anti-US protests, broadly. Model specifications
are as follows:

1.  Full model with varying intercepts and AR1 correction
2.  Full model with varying intercepts and no AR1 correction
3.  Full model curvilinear regime type variable
4.  Full model with interactions between troops and economic growth and
    democratization

```{r US Protest NBREG Models}

# Conflicted pckage really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)
VAGUEPRIOR <- c(set_prior("normal(0, 2)", class = "b"),
                set_prior("normal(0, 10)", class = "Intercept"))

ITER <- 5000
WARMUP <-  2000
CORES <- 2
CHAINS <- 2
THIN <- 1
SEED <- 66502



# Base model
us.1 <- brm(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
              (1 | ccode) +
              ar(time = year, gr = ccode, p = 1, cov = TRUE), 
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.9),
            file = here::here("Output/Chapter-Protests", "us.1"))


# Base model no AR1 term
us.2 <- brm(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
              (1 | ccode), 
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.9),
            file = here::here("Output/Chapter-Protests", "us.2"))


# Base Model
# Nor AR1
# Curvilinear regime type variables
us.3 <- brm(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              v2x_polyarchy_c_mean_z_sq + v2x_polyarchy_c_demeaned_z_sq +
              exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
              (1 | ccode), 
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.85),
            file = here::here("Output/Chapter-Protests", "us.3"))



# No AR1
# Interaction between troops and democratic change variable and economic growth
us.4 <- brm(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              troops_c_mean_z:v2x_polyarchy_change_c_mean_z + troops_c_demeaned_z:v2x_polyarchy_change_c_demeaned_z +
              troops_c_mean_z:gdp_growth_c_mean_z + troops_c_demeaned_z:gdp_growth_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              v2x_polyarchy_change_c_mean_z + v2x_polyarchy_change_c_demeaned_z +
              exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
              (1 | ccode), 
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.85),
            file = here::here("Output/Chapter-Protests", "us.4"))





```

### Zero-Inflated Models

### Mean centered models

```{r mean-centered models}

# Conflicted package really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)
VAGUEPRIOR <- c(set_prior("cauchy(0, 10)", class = "b"),
                set_prior("cauchy(0, 20)", class = "Intercept"))

ITER <- 10000
WARMUP <-  5000
CORES <- 4
CHAINS <- 4
THIN <- 1
SEED <- 66502

# Base model no AR1 term with centered variables only
us.zi.1.cent <- brm(bf(anti_us_protest ~ troops_z +
                        troops_w_mean_z + 
                        v2x_polyarchy_z + 
                        gdp_z + 
                        pop_z + 
                        us_war +
                        us_ally +
                        anti_us_protest_w_mean_z_lag + 
                        ar(time = year, gr = ccode, p = 1, cov = TRUE) +
                        (1 | ccode), 
                      zi ~ troops_z + 
                        v2x_polyarchy_z +
                        idealdistance_2_z +
                        (1 | ccode)),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = zero_inflated_negbinomial(),
            control = list(adapt_delta = 0.95,
                           max_treedepth = 10),
            file = here::here("Output/Chapter-Protests", "us.zi.1.cent"))

# Base model no AR1 term with centered variables only
us.zi.2.cent <- brm(bf(anti_us_protest ~ troops_z +
              troops_w_mean_z + 
              v2x_polyarchy_z + 
              gdp_z + 
              pop_z + 
              us_war +
              us_ally +
              anti_us_protest_w_mean_z_lag + 
              (1 | ccode), 
            zi ~ troops_z + 
              v2x_polyarchy_z +
              idealdistance_2_z +
              (1 | ccode)),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = zero_inflated_negbinomial(),
            control = list(adapt_delta = 0.95,
                           max_treedepth = 10),
            file = here::here("Output/Chapter-Protests", "us.zi.2.cent"))


# Base Model
# No AR1 term
# Curvilinear regime type
us.zi.3.cent <- brm(bf(anti_us_protest ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         v2x_polyarchy_z_sq +
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         anti_us_protest_w_mean_z_lag + 
                         (1 | ccode), 
                       zi ~ troops_z + 
                         v2x_polyarchy_z +
                         idealdistance_2_z +
                         (1 | ccode)),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = zero_inflated_negbinomial(),
            control = list(adapt_delta = 0.95,
                           max_treedepth = 10),
            file = here::here("Output/Chapter-Protests", "us.zi.3.cent"))


# Base Model
# No AR1 term
# Curvilinear regime type
us.zi.4.cent <- brm(bf(anti_us_protest ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         gdp_growth_z + 
                         troops_z:gdp_growth_z +
                         troops_z:v2x_polyarchy_change_z +
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         anti_us_protest_w_mean_z_lag + 
                         (1 | ccode), 
                       zi ~ troops_z + 
                         v2x_polyarchy_z +
                         idealdistance_2_z +
                         (1 | ccode)),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = zero_inflated_negbinomial(),
            control = list(adapt_delta = 0.95,
                           max_treedepth = 10),
            file = here::here("Output/Chapter-Protests", "us.zi.4.cent"))


# Base Model
# No AR1 term
# Curvilinear regime type
us.zi.5.cent <- brm(bf(anti_us_protest ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         gdp_growth_z + 
                         troops_z:gdp_growth_z +
                         troops_z:v2x_polyarchy_change_z +
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         anti_us_protest_w_mean_z_lag + 
                         (1 | ccode), 
                       zi ~ troops_z + 
                         v2x_polyarchy_z +
                         idealdistance_2_z +
                         (1 | ccode),
                       shape ~ troops_z + 
                         (1 | ccode)),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = zero_inflated_negbinomial(),
            control = list(adapt_delta = 0.92,
                           max_treedepth = 10),
            file = here::here("Output/Chapter-Protests", "us.zi.5.cent"))

```

### Within-Between Models

```{r US Protest ZINBREG Models}


# Conflicted package really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)
VAGUEPRIOR <- c(set_prior("cauchy(0, 10)", class = "b"),
                set_prior("cauchy(0, 20)", class = "Intercept"))

ITER <- 8000
WARMUP <-  4000
CORES <- 4
CHAINS <- 4
THIN <- 1
SEED <- 66502



# Base model
us.zi.1 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
              (1 | ccode) +
              ar(time = year, gr = ccode, p = 1, cov = TRUE),
            zi ~ troops_c_mean_z + troops_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = zero_inflated_negbinomial(),
            control = list(adapt_delta = 0.90,
                           max_treedepth = 12),
            file = here::here("Output/Chapter-Protests", "us.zi.1"))




# Base model no AR1 term
us.zi.2 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
              (1 | ccode), 
            zi ~ troops_c_mean_z + troops_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = zero_inflated_negbinomial(),
            control = list(adapt_delta = 0.90,
                           max_treedepth = 12),
            file = here::here("Output/Chapter-Protests", "us.zi.2"))


# Base Model
# Nor AR1
# Curvilinear regime type variables
us.zi.3 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              v2x_polyarchy_c_mean_z_sq + v2x_polyarchy_c_demeaned_z_sq +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
              (1 | ccode), 
            zi ~ troops_c_mean_z + troops_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = zero_inflated_negbinomial(),
            control = list(adapt_delta = 0.90,
                           max_treedepth = 12),
            file = here::here("Output/Chapter-Protests", "us.zi.3"))



# No AR1
# Interaction between troops and democratic change variable and economic growth
us.zi.4 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              troops_c_mean_z:v2x_polyarchy_change_c_mean_z + troops_c_demeaned_z:v2x_polyarchy_change_c_demeaned_z +
              troops_c_mean_z:gdp_growth_c_mean_z + troops_c_demeaned_z:gdp_growth_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              v2x_polyarchy_change_c_mean_z + v2x_polyarchy_change_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
              (1 | ccode), 
            zi ~ troops_c_mean_z + troops_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = zero_inflated_negbinomial(),
            control = list(adapt_delta = 0.90,
                           max_treedepth = 12),
            file = here::here("Output/Chapter-Protests", "us.zi.4"))


# No AR1
# Interaction between troops and democratic change variable and economic growth
us.zi.5 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              v2x_polyarchy_change_c_mean_z + v2x_polyarchy_change_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
              (1 | ccode), 
            zi ~ troops_c_mean_z + troops_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z,
            shape ~ troops_c_mean_z + troops_c_demeaned_z),
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            thin = THIN,
            seed = SEED,
            family = zero_inflated_negbinomial(),
            control = list(adapt_delta = 0.80,
                           max_treedepth = 10),
            file = here::here("Output/Chapter-Protests", "us.zi.5"))





```

### Hurdle Models

```{r US Protest Hurdle Models}

# Conflicted package really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)
VAGUEPRIOR <- c(set_prior("cauchy(0, 5)", class = "b"),
                set_prior("cauchy(0, 10)", class = "Intercept"))

ITER <- 8000
WARMUP <-  4000
CORES <- 6
CHAINS <- 6
THIN <- 1
SEED <- 123



# Base model
us.hu.1 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
                    (1 | ccode) +
                    ar(time = year, gr = ccode, p = 1, cov = TRUE),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               inits = "random",
               thin = THIN,
               seed = SEED,
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.90,
                              max_treedepth = 12),
               file = here::here("Output/Chapter-Protests", "us.hu.1"))


# Base model no AR1 term
us.hu.2 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
                    (1 | ccode),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag + 
                    (1 | ccode)),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               thin = THIN,
               seed = SEED,
               inits = "0",
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.90,
                              max_treedepth = 12),
               file = here::here("Output/Chapter-Protests", "us.hu.2"))


# Base Model
# Nor AR1
# Curvilinear regime type variables
us.hu.3 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    v2x_polyarchy_c_mean_z_sq + v2x_polyarchy_c_demeaned_z_sq +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
                    (1 | ccode),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    v2x_polyarchy_c_mean_z_sq + v2x_polyarchy_c_demeaned_z_sq +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               thin = THIN,
               seed = SEED,
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.90,
                              max_treedepth = 12),
               file = here::here("Output/Chapter-Protests", "us.hu.3"))



# No AR1
# Interaction between troops and democratic change variable and economic growth
us.hu.4 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    troops_c_mean_z:v2x_polyarchy_change_c_mean_z + 
                    troops_c_demeaned_z:v2x_polyarchy_change_c_demeaned_z +
                    troops_c_mean_z:gdp_growth_c_mean_z + troops_c_demeaned_z:gdp_growth_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    v2x_polyarchy_change_c_mean_z + v2x_polyarchy_change_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
                    (1 | ccode),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    v2x_polyarchy_c_mean_z_sq + v2x_polyarchy_c_demeaned_z_sq +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               thin = THIN,
               seed = SEED,
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.90,
                              max_treedepth = 12),
               file = here::here("Output/Chapter-Protests", "us.hu.4"))



# Model shape parameter
us.hu.5 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
                    (1 | ccode),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag,
                  shape ~ troops_c_mean_z + troops_c_demeaned_z),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               thin = THIN,
               seed = SEED,
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.90,
                              max_treedepth = 12),
               file = here::here("Output/Chapter-Protests", "us.hu.5"))



# Base model no AR1 term
# Includes varying intercept for hurdle stage
us.hu.6 <- brm(bf(anti_us_protest ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
                    (1 | ccode),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_protest_w_mean_c_mean_z_lag + anti_us_protest_w_mean_c_demeaned_z_lag +
                    (1 | ccode)),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               thin = THIN,
               seed = SEED,
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.90,
                              max_treedepth = 12),
               file = here::here("Output/Chapter-Protests", "us.hu.6"))

```

### Mean-centered hurdle models

```{r mean-centered models}

# Conflicted package really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)
VAGUEPRIOR <- c(set_prior("cauchy(0, 10)", class = "b"),
                set_prior("cauchy(0, 20)", class = "Intercept"))

ITER <- 10000
WARMUP <-  5000
CORES <- 4
CHAINS <- 4
THIN <- 1
SEED <- 66502

# Base model no AR1 term with centered variables only
us.hu.1.cent <- brm(bf(anti_us_protest ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         idealdistance_2_z +
                         anti_us_protest_w_mean_z_lag + 
                         ar(time = year, gr = ccode, p = 1, cov = TRUE) +
                         (1 | ccode), 
                       hu ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         anti_us_protest_w_mean_z_lag +
                         idealdistance_2_z +
                         (1 | ccode)),
                    data = p.data,
                    iter = ITER,
                    warmup = WARMUP,
                    prior = VAGUEPRIOR,
                    chains = CHAINS,
                    cores = CORES,
                    thin = THIN,
                    seed = SEED,
                    family = hurdle_negbinomial(),
                    control = list(adapt_delta = 0.95,
                                   max_treedepth = 10),
                    file = here::here("Output/Chapter-Protests", "us.hu.1.cent"))


# Base model no AR1 term with centered variables only
us.hu.2.cent <- brm(bf(anti_us_protest ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         idealdistance_2_z +
                         anti_us_protest_w_mean_z_lag + 
                         (1 | ccode), 
                       hu ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         anti_us_protest_w_mean_z_lag +
                         idealdistance_2_z +
                         (1 | ccode)),
                    data = p.data,
                    iter = ITER,
                    warmup = WARMUP,
                    prior = VAGUEPRIOR,
                    chains = CHAINS,
                    cores = CORES,
                    thin = THIN,
                    seed = SEED,
                    family = hurdle_negbinomial(),
                    control = list(adapt_delta = 0.95,
                                   max_treedepth = 10),
                    file = here::here("Output/Chapter-Protests", "us.hu.2.cent"))


# Base Model
# No AR1 term
# Curvilinear regime type
us.hu.3.cent <- brm(bf(anti_us_protest ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         v2x_polyarchy_z_sq +
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         idealdistance_2_z +
                         anti_us_protest_w_mean_z_lag + 
                         (1 | ccode), 
                       hu ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         v2x_polyarchy_z_sq +
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         anti_us_protest_w_mean_z_lag +
                         idealdistance_2_z +
                         (1 | ccode)),
                    data = p.data,
                    iter = ITER,
                    warmup = WARMUP,
                    prior = VAGUEPRIOR,
                    chains = CHAINS,
                    cores = CORES,
                    thin = THIN,
                    seed = SEED,
                    family = hurdle_negbinomial(),
                    control = list(adapt_delta = 0.95,
                                   max_treedepth = 10),
                    file = here::here("Output/Chapter-Protests", "us.hu.3.cent"))


# Base Model
# No AR1 term
# Curvilinear regime type
us.hu.4.cent <- brm(bf(anti_us_protest ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         v2x_polyarchy_change_z +
                         troops_z:v2x_polyarchy_change_z +
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         idealdistance_2_z +
                         anti_us_protest_w_mean_z_lag + 
                         (1 | ccode), 
                       hu ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         v2x_polyarchy_change_z +
                         troops_z:v2x_polyarchy_change_z +
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         anti_us_protest_w_mean_z_lag +
                         idealdistance_2_z +
                         (1 | ccode)),
                    data = p.data,
                    iter = ITER,
                    warmup = WARMUP,
                    prior = VAGUEPRIOR,
                    chains = CHAINS,
                    cores = CORES,
                    thin = THIN,
                    seed = SEED,
                    family = hurdle_negbinomial(),
                    control = list(adapt_delta = 0.95,
                                   max_treedepth = 10),
                    file = here::here("Output/Chapter-Protests", "us.hu.4.cent"))


# Base Model
# No AR1 term
# Curvilinear regime type
us.hu.5.cent <- brm(bf(anti_us_protest ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         v2x_polyarchy_change_z +
                         troops_z:v2x_polyarchy_change_z +
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         idealdistance_2_z +
                         anti_us_protest_w_mean_z_lag + 
                         (1 | ccode), 
                       hu ~ troops_z +
                         troops_w_mean_z + 
                         v2x_polyarchy_z + 
                         v2x_polyarchy_change_z +
                         troops_z:v2x_polyarchy_change_z +
                         gdp_z + 
                         pop_z + 
                         us_war +
                         us_ally +
                         anti_us_protest_w_mean_z_lag +
                         idealdistance_2_z +
                         (1 | ccode),
                       shape ~ troops_z),
                    data = p.data,
                    iter = ITER,
                    warmup = WARMUP,
                    prior = VAGUEPRIOR,
                    chains = CHAINS,
                    cores = CORES,
                    thin = THIN,
                    seed = SEED,
                    family = hurdle_negbinomial(),
                    control = list(adapt_delta = 0.98,
                                   max_treedepth = 10),
                    file = here::here("Output/Chapter-Protests", "us.hu.5.cent"))


```

## Anti-US military protest models

### NBREG

These models focus on Anti-US military protests, broadly. Model
specifications are as follows:

1.  Full model with varying intercepts and AR1 correction
2.  Full model with varying intercepts and no AR1 correction
3.  Full model curvilinear regime type variable
4.  Full model with interactions between troops and economic growth and
    democratization

```{r US Protest NBREG Models}

# Conflicted pckage really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)
VAGUEPRIOR <- c(set_prior("normal(0, 10)", class = "b"),
                set_prior("normal(0, 50)", class = "Intercept"))

ITER <- 3000
WARMUP <-  1000
CORES <- 2
CHAINS <- 2
SEED <- 66502



# Base model
mil.1 <- brm(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
              (1 | ccode) +
              ar(time = year, gr = ccode, p = 1, cov = TRUE), 
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.85),
            file = here::here("Output/Chapter-Protests", "mil.1"))


# Base model no AR1 term
mil.2 <- brm(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
              (1 | ccode), 
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.85),
            file = here::here("Output/Chapter-Protests", "mil.2"))


# Base Model
# Nor AR1
# Curvilinear regime type variables
mil.3 <- brm(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              v2x_polyarchy_c_mean_z_sq + v2x_polyarchy_c_demeaned_z_sq +
              exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
              (1 | ccode), 
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.85),
            file = here::here("Output/Chapter-Protests", "mil.3"))



# No AR1
# Interaction between troops and democratic change variable and economic growth
mil.4 <- brm(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
              troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
              troops_c_mean_z:v2x_polyarchy_change_c_mean_z + troops_c_demeaned_z:v2x_polyarchy_change_c_demeaned_z +
              troops_c_mean_z:gdp_growth_c_mean_z + troops_c_demeaned_z:gdp_growth_c_demeaned_z +
              v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
              v2x_polyarchy_change_c_mean_z + v2x_polyarchy_change_c_demeaned_z +
              exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
              gdp_c_mean_z + gdp_c_demeaned_z +
              gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
              pop_c_mean_z + pop_c_demeaned_z +
              protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
              protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
              idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
              conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
              us_war_c_mean_z + us_war_c_demeaned_z + 
              us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
              us_ally_c_mean_z + us_ally_c_demeaned_z +
              defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
              anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
              (1 | ccode), 
            data = p.data,
            iter = ITER,
            warmup = WARMUP,
            prior = VAGUEPRIOR,
            chains = CHAINS,
            cores = CORES,
            seed = SEED,
            family = negbinomial(),
            control = list(adapt_delta = 0.85),
            file = here::here("Output/Chapter-Protests", "mil.4"))





```

### Zero-Inflated Models

```{r US Protest ZINBREG Models}


# Conflicted package really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)
VAGUEPRIOR <- c(set_prior("normal(0, 10)", class = "b"),
                set_prior("normal(0, 50)", class = "Intercept"))

ITER <- 5000
WARMUP <-  2000
CORES <- 2
CHAINS <- 2
SEED <- 66502



# Base model
mil.zi.1 <- brm(bf(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
                    (1 | ccode) +
                    ar(time = year, gr = ccode, p = 1, cov = TRUE),
                  zi ~ troops_c_mean_z + troops_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               seed = SEED,
               family = zero_inflated_negbinomial(),
               control = list(adapt_delta = 0.85),
               file = here::here("Output/Chapter-Protests", "mil.zi.1"))


# Base model no AR1 term
mil.zi.2 <- brm(bf(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
                    (1 | ccode), 
                  zi ~ troops_c_mean_z + troops_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               seed = SEED,
               family = zero_inflated_negbinomial(),
               control = list(adapt_delta = 0.85),
               file = here::here("Output/Chapter-Protests", "mil.zi.2"))


# Base Model
# Nor AR1
# Curvilinear regime type variables
mil.zi.3 <- brm(bf(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    v2x_polyarchy_c_mean_z_sq + v2x_polyarchy_c_demeaned_z_sq +
                    exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
                    (1 | ccode), 
                  zi ~ troops_c_mean_z + troops_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               seed = SEED,
               family = zero_inflated_negbinomial(),
               control = list(adapt_delta = 0.85),
               file = here::here("Output/Chapter-Protests", "mil.zi.3"))



# No AR1
# Interaction between troops and democratic change variable and economic growth
mil.zi.4 <- brm(bf(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    troops_c_mean_z:v2x_polyarchy_change_c_mean_z + troops_c_demeaned_z:v2x_polyarchy_change_c_demeaned_z +
                    troops_c_mean_z:gdp_growth_c_mean_z + troops_c_demeaned_z:gdp_growth_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    v2x_polyarchy_change_c_mean_z + v2x_polyarchy_change_c_demeaned_z +
                    exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
                    (1 | ccode), 
                  zi ~ troops_c_mean_z + troops_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               seed = SEED,
               family = zero_inflated_negbinomial(),
               control = list(adapt_delta = 0.85),
               file = here::here("Output/Chapter-Protests", "mil.zi.4"))





# Base model with no zero-inflated equation
mil.zi.5 <- brm(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
                 troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                 v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                 exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
                 gdp_c_mean_z + gdp_c_demeaned_z +
                 gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                 pop_c_mean_z + pop_c_demeaned_z +
                 protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                 protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                 idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                 conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                 us_war_c_mean_z + us_war_c_demeaned_z + 
                 us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z + +
                 us_ally_c_mean_z + us_ally_c_demeaned_z +
                 defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                 anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
                 (1 | ccode),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               seed = SEED,
               family = zero_inflated_negbinomial(),
               control = list(adapt_delta = 0.85),
               file = here::here("Output/Chapter-Protests", "mil.zi.5"))

```

### Hurdle Models

```{r US Protest Hurdle Models}

# Conflicted package really fucks things up
if(any(grepl("package:conflicted", search()))) detach("package:conflicted") else message("package conflicted not loaded")


# Parallelize machine
options(mc.cores = parallel::detectCores())
ncores <- parallel::detectCores()
rstan_options(auto_write = TRUE)
VAGUEPRIOR <- c(set_prior("normal(0, 10)", class = "b"),
                set_prior("normal(0, 50)", class = "Intercept"))

ITER <- 6000
WARMUP <-  3000
CORES <- 2
CHAINS <- 2
SEED <- 66502



# Base model
mil.hu.1 <- brm(bf(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
                    (1 | ccode) +
                    ar(time = year, gr = ccode, p = 1, cov = TRUE),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag + 
                    (1 | ccode)),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               seed = SEED,
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.9),
               file = here::here("Output/Chapter-Protests", "mil.hu.1"))


# Base model no AR1 term
mil.hu.2 <- brm(bf(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
                    (1 | ccode),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag + 
                    (1 | ccode)),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               seed = SEED,
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.9),
               file = here::here("Output/Chapter-Protests", "mil.hu.2"))


# Base Model
# Nor AR1
# Curvilinear regime type variables
mil.hu.3 <- brm(bf(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    v2x_polyarchy_c_mean_z_sq + v2x_polyarchy_c_demeaned_z_sq +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
                    (1 | ccode),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    v2x_polyarchy_c_mean_z_sq + v2x_polyarchy_c_demeaned_z_sq +
                    exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag + 
                    (1 | ccode)),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               seed = SEED,
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.9),
               file = here::here("Output/Chapter-Protests", "mil.hu.3"))



# No AR1
# Interaction between troops and democratic change variable and economic growth
mil.hu.4 <- brm(bf(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    troops_c_mean_z:v2x_polyarchy_change_c_mean_z + 
                    troops_c_demeaned_z:v2x_polyarchy_change_c_demeaned_z +
                    troops_c_mean_z:gdp_growth_c_mean_z + troops_c_demeaned_z:gdp_growth_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    v2x_polyarchy_change_c_mean_z + v2x_polyarchy_change_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
                    (1 | ccode),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    v2x_polyarchy_c_mean_z_sq + v2x_polyarchy_c_demeaned_z_sq +
                    exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag + 
                    (1 | ccode)),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               seed = SEED,
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.9),
               file = here::here("Output/Chapter-Protests", "mil.hu.4"))


# Base Model
# No AR1
# Modeling Sigma parameter
mil.hu.5 <- brm(bf(anti_us_mil ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    defburden_w_mean_c_mean_z + defburden_w_mean_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag +
                    (1 | ccode),
                  hu ~ troops_c_mean_z + troops_c_demeaned_z +
                    troops_w_mean_c_mean_z + troops_w_mean_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z +
                    exports_from_us_c_mean_z + exports_from_us_c_demeaned_z +
                    gdp_c_mean_z + gdp_c_demeaned_z +
                    gdp_growth_c_mean_z + gdp_growth_c_demeaned_z +
                    pop_c_mean_z + pop_c_demeaned_z +
                    protest_other_c_mean_z_lag + protest_other_c_demeaned_z_lag +
                    protest_other_w_mean_c_mean_z_lag + protest_other_w_mean_c_demeaned_z_lag +
                    conflict_dummy_c_mean_z + conflict_dummy_c_demeaned_z +
                    us_war_c_mean_z + us_war_c_demeaned_z + 
                    us_war_w_mean_c_mean_z + us_war_w_mean_c_demeaned_z +
                    us_ally_c_mean_z + us_ally_c_demeaned_z +
                    idealdistance_2_c_mean_z + idealdistance_2_c_demeaned_z +
                    anti_us_mil_w_mean_c_mean_z_lag + anti_us_mil_w_mean_c_demeaned_z_lag + 
                    (1 | ccode),
                  sigma ~ troops_c_mean_z + troops_c_demeaned_z +
                    v2x_polyarchy_c_mean_z + v2x_polyarchy_c_demeaned_z + 
                    (1 | ccode),
                  nl = TRUE),
               data = p.data,
               iter = ITER,
               warmup = WARMUP,
               prior = VAGUEPRIOR,
               chains = CHAINS,
               cores = CORES,
               seed = SEED,
               family = hurdle_negbinomial(),
               control = list(adapt_delta = 0.9),
               file = here::here("Output/Chapter-Protests", "mil.hu.5"))



```

# Opinion Models of Protest

## Predicting Protest

```{r protest-null}

job::job(import = "auto", op.protest.1 = {
# Note beta prior in the Base Model models, so get rid of it here. 

ITER <- 8000
WARMUP <-  4000
CORES <- 8
CHAINS <- 4
THIN <- 1
SEED <- 123

# Have to use separate correlation indicator because correlations can only be structured across common grouping factors (i.e. varying effects have to be associated with country OR year. can't do both.

protest.naive <- bf(protest_dummy ~ basecount_z + gdp_z + pop_z + troops_z + 
                      (1 + basecount_z + gdp_z + pop_z + troops_z |p| country) + 
                      (1 |r| year))

get_prior(protest.naive,
          data = training.data,
          faimly = bernoulli(link = "logit"))

PRIOR <- c(set_prior("normal(0, 1)", class = "Intercept"),
           set_prior("gamma(1, 3.5)", class = "sd"),
           set_prior("gamma(1, 3.5)", class = "sd", group = "country"),
           set_prior("gamma(1, 3.5)", class = "sd", group = "year"),
           set_prior("gamma(1, 3.5)", class = "sd", coef = "Intercept", group = "country"),
           set_prior("gamma(1, 3.5)", class = "sd", coef = "Intercept", group = "year"))


op.protest.1 <- brm(protest.naive,
                    data = training.data,
                    family = bernoulli(link = "logit"),
                    prior = PRIOR,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = THIN,
                    seed = SEED, 
                    threads = threading(threads = 2),
                    control = list(adapt_delta = 0.98,
                                   max_treedepth = 10),
                    save_pars = save_pars(all = TRUE),
                    file_refit = "on_change",
                    save_model = here::here("Output/Chapter-Protests/op.protest.1.stan"),
                    file = here::here("Output/Chapter-Protests/op.protest.1"),
                    backend = "cmdstanr")

}
)

```


```{r protest-demographic}

job::job(import = "auto", op.protest.2 = {

  
ITER <- 6000
WARMUP <-  3000
CORES <- 4
CHAINS <- 4
THIN <- 1
SEED <- 123

protest.demo <- bf(protest_dummy ~ age + ed_z + ideology_z + income.5.cat + gender + minority + basecount_z + gdp_z + pop_z + troops_z +
                     (1 + age + ed_z + ideology_z + income.5.cat + gender + minority |p| country) + 
                     (1 |r| year))

get_prior(protest.demo,
          data = training.data,
          family = bernoulli(link = "logit"))

PRIOR <- c(set_prior("normal(0, 1)", class = "b"),
           set_prior("normal(0, 2)", class = "Intercept"),
           set_prior("lkj(1)", class = "cor"),
           set_prior("lkj(1)", class = "cor", group = "country"),
           set_prior("gamma(1, 3.5)", class = "sd", group = "country"),
           set_prior("gamma(1, 3.5)", class = "sd", group = "year"))

op.protest.2 <- brm(protest.demo,
                    data = training.data,
                    family = bernoulli(link = "logit"),
                    prior = PRIOR,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = THIN,
                    seed = SEED, 
                    control = list(adapt_delta = 0.99,
                                   max_treedepth = 10),
                    file_refit = "on_change",
                    save_pars = save_pars(all = TRUE),
                    save_model = here::here("Output/Chapter-Protests", "op.protest.2.stan"),
                    file = here::here("Output/Chapter-Protests", "op.protest.2"),
                    backend = "cmdstanr")

}
)

```

```{r protest-attitudes}

job::job(import = "auto", op.protest.3 = {

ITER <- 6000
WARMUP <-  3000
CORES <- 4
CHAINS <- 4
THIN <- 1
SEED <- 123

protest.att <- bf(protest_dummy ~ age + ed_z + ideology_z + income.5.cat + gender + minority + troops_1 + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z +
                    (1 + age + ed_z + ideology_z + income.5.cat + gender + minority + troops_1 + american_inf_1 + american_inf_2 |p| country) + 
                    (1 |r| year))

get_prior(protest.att,
          data = training.data,
          family = bernoulli(link = "logit"))

PRIOR <- c(set_prior("normal(0, 1)", class = "b"),
           set_prior("normal(0, 2)", class = "Intercept"),
           set_prior("lkj(1)", class = "cor"),
           set_prior("lkj(1)", class = "cor", group = "country"),
           set_prior("gamma(1, 3.5)", class = "sd"),
           set_prior("gamma(1, 3.5)", class = "sd", group = "country"),
           set_prior("gamma(1, 3.5)", class = "sd", group = "year"),
           set_prior("gamma(1, 3.5)", class = "sd", coef = "Intercept", group = "year"))



op.protest.3 <- brm(protest.att,
                    data = training.data,
                    family = bernoulli(link = "logit"),
                    prior = PRIOR,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = THIN,
                    seed = SEED, 
                    control = list(adapt_delta = 0.99,
                                   max_treedepth = 10),
                    save_pars = save_pars(all = TRUE),
                    file_refit = "on_change",
                    save_model = here::here("Output/Chapter-Protests", "op.protest.3.stan"),
                    file = here::here("Output/Chapter-Protests", "op.protest.3"),
                    backend = "cmdstanr")

}
)

```


```{r protest-experiences}

job::job(import = "auto", op.protest.4 = {

ITER <- 6000
WARMUP <-  3000
CORES <- 4
CHAINS <- 4
THIN <- 1
SEED <- 66502

protest.experience <- bf(protest_dummy ~ age + ed_z + ideology_z + income.5.cat + gender + minority + troops_1 + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + troops_crime_pers + troops_crime_nonpers + american_inf_1 + american_inf_2 + basecount_z + gdp_z + pop_z + troops_z + 
                           (1 + age + ed_z + ideology_z + income.5.cat + gender + minority + troops_1 + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + troops_crime_pers + troops_crime_nonpers + american_inf_1 + american_inf_2 |p| country) + 
                           (1 |r| year))

get_prior(protest.experience,
          data = training.data,
          family = bernoulli(link = "logit"))

PRIOR <- c(set_prior("normal(0, 2)", class = "b"),
           set_prior("normal(0, 3)", class = "Intercept"),
           set_prior("lkj(1)", class = "cor"),
           set_prior("lkj(1)", class = "cor", group = "country"),
           set_prior("gamma(1, 3)", class = "sd"),
           set_prior("gamma(1, 3)", class = "sd", group = "country"),
           set_prior("gamma(1, 3)", class = "sd", group = "year"),
           set_prior("gamma(1, 3)", class = "sd", coef = "Intercept", group = "year"))


op.protest.4 <- brm(protest.experience,
                    data = training.data,
                    family = bernoulli(link = "logit"),
                    prior = PRIOR,
                    iter = ITER,
                    warmup = WARMUP,
                    cores = CORES,
                    chains = CHAINS,
                    thin = THIN,
                    seed = SEED, 
                    inits = 0,
                    control = list(adapt_delta = 0.99,
                                   max_treedepth = 10),
                    file_refit = "on_change",
                    save_pars = save_pars(all = TRUE),                    
                    save_model = here::here("Output/Chapter-Protests/op.protest.4.stan"),
                    file = here::here("Output/Chapter-Protests/op.protest.4"),
                    backend = "cmdstanr")

}
)

```




```{r individual-level-summary-table}

`Base Model` <- c("Base Count", "GDP", "Population", "Troops in country")
`Demographics` <- c("Age", "Education", "Ideology", "Gender", "Income", "Minority Status", "Base Count", "GDP", "Population", "Troops in country")
`Demographics and Attitudes` <- c("Age", "Education", "Ideology", "Gender", "Income", "Minority Status", "Attitude towards US military presence", "Assessment of US influence (Quantity)", "Assessment of US influence (Quality)", "Base Count", "GDP", "Population", "Troops in country")
`Demographics, Attitudes, and Experiences` <- c("Age", "Education", "Ideology", "Gender", "Income", "Minority Status", "Attitude towards US military presence", "Personal contact", "Network Contact", "Personal benefits", "Network benefits", "Personal experience with troops and crime", "Network experience with crime", "Assessment of US influence (Quantity)", "Assessment of US influence (Quality)", "Base Count", "GDP", "Population", "Troops in country")

list.length <- length(`Demographics, Attitudes, and Experiences`)
length(`Base Model`) <- list.length
length(`Demographics`) <- list.length
length(`Demographics and Attitudes`) <- list.length
length(`Demographics, Attitudes, and Experiences`) <- list.length

var.list <- as.data.frame(cbind(`Base Model`, 
                             `Demographics`, 
                             `Demographics and Attitudes`, 
                             `Demographics, Attitudes, and Experiences`)) %>% 
  mutate(across(everything(), ~ifelse(is.na(.x), "", .x)))



var.table <- kableExtra::kable(var.list, caption = "Predictive Model Specification for Individual Protest Activity \\label{tab:protestpredictionvariables}", booktabs = TRUE, "latex") %>% 
  kable_styling(latex_options = "striped", protect_latex = TRUE, font_size = 9) %>% 
  row_spec(0, bold = TRUE) %>% 
  column_spec(1, width = "3.0cm") %>% 
  column_spec(2, width = "3.0cm") %>% 
  column_spec(3, width = "3.0cm") %>% 
  column_spec(4, width = "3.0cm") %>% 
  footnote(number = c("Each model include varyings intercepts for country and year. All models also include the primary predictor variables as varying coefficients across the country grouping."),
           threeparttable = TRUE) %>% 
  save_kable(here("Tables/Chapter-Protests/model-protest-prediction-varlist.tex"),
             keep_tex = TRUE)


```

## Predictive Figures

```{r Predictive Protest Figures, dpi=400, echo = FALSE}


op.protest.1 <- readRDS(here::here("Output/Chapter-Protests/op.protest.1.rds"))
op.protest.2 <- readRDS(here::here("Output/Chapter-Protests/op.protest.2.rds"))
op.protest.3 <- readRDS(here::here("Output/Chapter-Protests/op.protest.3.rds"))
op.protest.4 <- readRDS(here::here("Output/Chapter-Protests/op.protest.4.rds"))

mod.list <- list("Base Model" = op.protest.1,
                 "Demographics" = op.protest.2,
                 "Demographics and Attitudes" = op.protest.3,
                 "Demographics, Attitudes, and Exeriences" = op.protest.4)

# Separation plot for the naive model
# Using `predict` command rather than fitted because it accounts for uncertainty at all levels of the model.
# NULL re_formula uses all group-level effects in prediction


sep.plot <- lapply(mod.list, function(x) {
  
  temp <- test.data %>% 
    bind_cols(as.data.frame(predict(x, 
                                    newdata = test.data,
                                    re_formula = NULL))) %>%
    arrange(Estimate) %>% 
    mutate(index = row_number()) %>% 
    filter(Estimate >= 0)

}
)


  
sep.plot.com <- data.table::rbindlist(sep.plot, idcol = TRUE) %>% 
  mutate(.id = factor(.id, levels = c("Base Model", "Demographics", "Demographics and Attitudes", "Demographics, Attitudes, and Experiences"))) %>% 
  ungroup() %>% 
  filter(Estimate >= 0)

ggplot(sep.plot.com, aes(x = index, y = Estimate)) +
            geom_rect(aes(x = index, xmin=index-0.05, xmax=index+0.05, y = Estimate, ymin = 0, ymax = 1, fill = protest_dummy)) + 
            geom_line(size = 1) +
            facet_wrap(. ~ .id, scales = "free_x", ncol = 1) +
            scale_x_continuous(expand = c(0, 0)) +
            scale_y_continuous(expand = c(0, 0)) +
            viridis::scale_fill_viridis(option = "magma", begin = 0.1, end = 0.9, guide = FALSE, discrete = TRUE) +
            guides(alpha = FALSE) +
            theme_flynn() +
            theme(axis.text.x = element_blank(),
                  axis.ticks.x = element_blank(),
                  axis.title.y = element_text(vjust = 3, size = basesize * 1.1),
                  axis.text.y = element_text(size = basesize * 1.1),
                  panel.grid.major =  element_blank(),
                  panel.grid.minor = element_blank(),
                  strip.text = element_text(size = basesize * 1.3),
                  plot.title = element_text(size = basesize * 1.5),
                  panel.spacing = unit(0.2, "cm")) +
            labs(x = "",
                 y = "Pr(Protest Activity)",
                 title = "Separation Plots for Individual Protest Models")

ggsave(here("Figures/Chapter-Protests/figure-sep-plot-combined.pdf"), height = 6, width = 7, units = "in", device = cairo_pdf())
ggsave(here("Figures/Chapter-Protests/figure-sep-plot-combined.png"), height = 6, width = 7, units = "in", dpi = 400)
ggsave(here("Figures/Chapter-Protests/figure-sep-plot-combined.tiff"), height = 6, width = 7, units = "in", dpi = 400)
ggsave(here("Figures/Chapter-Protests/figure-sep-plot-combined.jpg"), height = 6, width = 7, units = "in", dpi = 400)  



```

### Posterior Predictive Checks

```{r posterior predictive checks}

op.protest.1 <- readRDS(here::here("Output/Chapter-Protests/op.protest.1.rds"))
op.protest.2 <- readRDS(here::here("Output/Chapter-Protests/op.protest.2.rds"))
op.protest.3 <- readRDS(here::here("Output/Chapter-Protests/op.protest.3.rds"))
op.protest.4 <- readRDS(here::here("Output/Chapter-Protests/op.protest.4.rds"))

mod.list <- list("Base Model" = op.protest.1,
                 "Demographics" = op.protest.2,
                 "Demographics and Attitudes" = op.protest.3,
                 "Demographics, Attitudes, and Exeriences" = op.protest.4)

# Define function to calculate proportion of 0 values
prop_protest <- function(x) mean(x == 1, na.rm = TRUE)

y <- test.data %>% 
  dplyr::select(protest_dummy) %>% 
  filter(!is.na(protest_dummy)) %>% 
  mutate(protest_dummy = factor(protest_dummy, levels = c("No", "Yes"), labels = c("No", "Yes")),
         protest_dummy = as.numeric(protest_dummy) - 1) %>% 
  as.vector()


y.rep <- lapply(mod.list, function(x) {
  
  temp <- brms::posterior_predict(x, ndraws = 1000)
  protest.ppcheck  <- bayesplot::ppc_stat(y$protest_dummy, temp[,1:length(y$protest_dummy)], stat = "prop_protest", binwidth = 0.001) 
}
)


protest.ppcheck.fig <- patchwork::wrap_plots(y.rep[[1]], y.rep[[2]], y.rep[[3]], y.rep[[4]], ncol = 2)
protest.ppcheck.fig[[1]] <- protest.ppcheck.fig[[1]] + ggtitle("Base Model")
protest.ppcheck.fig[[2]] <- protest.ppcheck.fig[[2]] + ggtitle("Demographics")
protest.ppcheck.fig[[3]] <- protest.ppcheck.fig[[3]] + ggtitle("Demographics and Attitudes")
protest.ppcheck.fig[[4]] <- protest.ppcheck.fig[[4]] + ggtitle("Demographics, Attitudes, and Experiences")


protest.ppcheck.fig <- protest.ppcheck.fig +
  plot_layout(guides = "collect") &
  scale_x_continuous(limits = c(0.05, 0.11)) &
  scale_y_continuous(limits = c(0, 180)) &
  labs(fill = "Simulated Values",
       color = "Observed Proportion") &
  viridis::scale_fill_viridis(option = "magma", begin = 0.2, end = 0.2, discrete = TRUE) &
  theme_flynn() &
  theme(plot.title = element_text(size = basesize * 1.2),
        axis.text = element_text(size = basesize * 1.1),
        legend.text = element_text(size = basesize * 1.1))

protest.ppcheck.fig

#ggsave(here("Figures/Chapter-Protests/fig-opinion-ppcheck-plots.png"), height = 6, width = 8, units = "in")
ggsave(here("Figures/Chapter-Protests/fig-opinion-ppcheck-plots.jpg"), height = 6, width = 8, units = "in")


```



## Coefficient Figures

```{r protest prediction coefficients}

op.protest.1 <- readRDS(here::here("Output/Chapter-Protests/op.protest.1.rds"))
op.protest.2 <- readRDS(here::here("Output/Chapter-Protests/op.protest.2.rds"))
op.protest.3 <- readRDS(here::here("Output/Chapter-Protests/op.protest.3.rds"))
op.protest.4 <- readRDS(here::here("Output/Chapter-Protests/op.protest.4.rds"))

m2.fig <- op.protest.2 %>% 
  gather_draws(b_minorityYes,
               b_ed_z,
               b_ideology_z,
               b_genderFemale,
               b_age25to34years,
               b_age35to44years,
               b_age45to54years,
               b_age55to64years,
               b_ageAge65orolder,
               `b_income.5.cat21M40%`,
               `b_income.5.cat41M60%`,
               `b_income.5.cat61M80%`,
               `b_income.5.cat81M100%`
               ) %>% 
  mutate(model = "Demographics")

m3.fig <- op.protest.3 %>% 
  gather_draws(b_minorityYes,
               b_ed_z,
               b_ideology_z,
               b_genderFemale,
               b_age25to34years,
               b_age35to44years,
               b_age45to54years,
               b_age55to64years,
               b_ageAge65orolder,
               `b_income.5.cat21M40%`,
               `b_income.5.cat41M60%`,
               `b_income.5.cat61M80%`,
               `b_income.5.cat81M100%`,
               b_american_inf_2Verynegative,
               b_american_inf_2Negative,
               b_american_inf_2Positive,
               b_american_inf_2Verypositive,
               b_troops_1Veryunfavorable,
               b_troops_1Somewhatunfavorable,
               b_troops_1Somewhatfavorable,
               b_troops_1Veryfavorable) %>% 
  mutate(model = "Demographics and Attitudes")

m4.fig <- op.protest.4 %>% 
  gather_draws(b_minorityYes,
               b_ed_z,
               b_ideology_z,
               b_genderFemale,
               b_age25to34years,
               b_age35to44years,
               b_age45to54years,
               b_age55to64years,
               b_ageAge65orolder,
               `b_income.5.cat21M40%`,
               `b_income.5.cat41M60%`,
               `b_income.5.cat61M80%`,
               `b_income.5.cat81M100%`,
               b_american_inf_2Verynegative,
               b_american_inf_2Negative,
               b_american_inf_2Positive,
               b_american_inf_2Verypositive,
               b_contact_persYes,
               b_contact_nonpersYes,
               b_benefit_persYes,
               b_benefit_nonpersYes,
               b_troops_crime_nonpersYes,
               b_troops_crime_persYes,
               b_troops_1Veryunfavorable,
               b_troops_1Somewhatunfavorable,
               b_troops_1Somewhatfavorable,
               b_troops_1Veryfavorable) %>% 
  mutate(model = "Demographics, Attitudes, and Experiences") 



m4.wide <- op.protest.4 %>% 
  spread_draws(b_minorityYes,
               b_contact_persYes,
               b_contact_nonpersYes,
               b_troops_crime_persYes,
               b_troops_crime_nonpersYes,
               r_country[country, var],
               r_year[year, var2]) %>% 
  filter(var %in% c("minorityYes", "contact_persYes", "contact_nonpersYes", "troops_crime_persYes", "troops_crime_nonpersYes")) %>% 
  pivot_wider(id_cols = c(".chain", ".iteration", ".draw", "country", "year", "b_minorityYes", "b_contact_persYes", "b_contact_nonpersYes", "b_troops_crime_persYes", "b_troops_crime_nonpersYes"),
              values_from = c("r_country", "r_year"),
              names_from = "var") %>% 
  mutate(minority = b_minorityYes + r_country_minorityYes + r_year_minorityYes,
         contact = b_contact_persYes + r_country_contact_persYes + r_year_contact_persYes,
         network = b_contact_nonpersYes + r_country_contact_nonpersYes + r_year_contact_nonpersYes,
         crime = b_troops_crime_persYes + r_country_troops_crime_persYes + r_year_troops_crime_persYes,
         networkcrime = b_troops_crime_nonpersYes + r_country_troops_crime_nonpersYes + r_year_troops_crime_nonpersYes) %>% 
  dplyr::select(.chain, .iteration, .draw, country, minority, contact, network, crime, networkcrime) %>% 
  pivot_longer(cols = c(minority, network, contact, crime, networkcrime)) %>% 
  mutate(country = gsub("\\.", " ", country),
         name = factor(name, levels = c("minority", "contact", "network", "crime", "networkcrime"),
                        labels = c("Minority Status", "Personal Contact", "Network Contact", "Personal Crime", "Network Crime")))



# combined population figures
m.pops <- bind_rows(m2.fig, m3.fig, m4.fig) %>% 
  mutate(grouping = case_when(
           grepl(".*ed_z.*", .variable) ~ "Education",
           grepl(".*minor.*", .variable) ~ "Minority",
           grepl(".*ideo.*", .variable) ~ "Ideology",
           grepl(".*age.*", .variable) ~ "Age",
           grepl(".*incom.*", .variable) ~ "Income Quantile",
           grepl(".*inf_.*", .variable) ~ "US Influence (Quality)",
           grepl(".*contac.*", .variable) ~ "Contact",
           grepl(".*benefi.*", .variable) ~ "Benefits",
           grepl(".*crime.*", .variable) ~ "Crime",
           grepl(".*troops.*", .variable) ~ "US Troops"
         )) %>% 
  mutate(.variable = factor(.variable, 
                            levels = c("b_minorityYes",
                                       "b_ed_z",
                                       "b_ideology_z",
                                       "b_genderFemale",
                                       "b_age25to34years",
                                       "b_age35to44years",
                                       "b_age45to54years",
                                       "b_age55to64years",
                                       "b_ageAge65orolder",
                                       "b_income.5.cat21M40%",
                                       "b_income.5.cat41M60%",
                                       "b_income.5.cat61M80%",
                                       "b_income.5.cat81M100%",
                                       "b_american_inf_2Verynegative",
                                       "b_american_inf_2Negative",
                                       "b_american_inf_2Positive",
                                       "b_american_inf_2Verypositive",
                                       "b_troops_1Veryunfavorable",
                                       "b_troops_1Somewhatunfavorable",
                                       "b_troops_1Somewhatfavorable",
                                       "b_troops_1Veryfavorable",
                                       "b_benefit_persYes",
                                       "b_benefit_nonpersYes",
                                       "b_contact_persYes",
                                       "b_contact_nonpersYes",
                                       "b_troops_crime_nonpersYes",
                                       "b_troops_crime_persYes"),
                        labels = c("Minority Status: Yes", "Education", "Ideology", "Gender: Female", "Age: 25-34", "Age: 35-44", "Age: 45-54", "Age: 55-64", "Age: 65 or older", "Income: 21%-40%", "Income: 41%-60%", "Income: 61%-80%", "Income: 81%-100%", "US Influence: Very Negative", "US Influence: Negative", "US Influence: Positive", "US Influence: Very Positive", "US Presence: Very Unfavorable", "US Presence: Somewhat Unfavorable", "US Presence: Somewhat Favorable", "US Presence: Very Favorable", "Personal Benefits", "Network Benefits", "Personal Contact", "Network Contact", "Network Crime", "Personal Crime")))


population.figures <- ggplot(m.pops, aes(x = .value, y = .variable, color = model)) +
  stat_pointinterval(.width = c(0.50, 0.80, 0.95), position = position_dodge(width = 0.85)) +
  geom_vline(xintercept = 0, color = "black", width = 1.1) +
  scale_x_continuous(limits = c(-2.5, 2.5)) +
  theme_flynn() +
  theme(plot.title.position = "plot",
        legend.position = "bottom",
        legend.title = element_text(size = basesize * 1.1),
        legend.text = element_text(size = basesize * 1.1, margin = margin(l = -0.25, unit = "cm")),
        axis.text = element_text(size = basesize * 1.1),
        axis.title = element_text(size = basesize * 1.1)) +
  guides(color = guide_legend(reverse = TRUE, ncol = 1)) +
  viridis::scale_color_viridis(option = "magma", begin = 0.1, end = 0.9, discrete = TRUE) +
  labs(x = "Coefficient Value",
       y = "",
       color = "Model",
       title = "Population-Level Coefficient Values for Individual Protest Activity")

ggsave(here("Figures/Chapter-Protests/fig-coefplot-population-opinion-model-compare.png"), height = 8, width = 6, unit = "in")
ggsave(here("Figures/Chapter-Protests/fig-coefplot-population-opinion-model-compare.jpg"), height = 8, width = 6, unit = "in")


population.figures

country.figures <- ggplot(m4.wide, aes(x = value, y = country, color = name)) +
  stat_pointinterval(stat = median_hdi, .width = c(0.50, 0.80, 0.95), position = position_dodge(width = 0.85)) +
  geom_vline(xintercept = 0, color = "black", width = 1.1) +
  facet_grid(country~., switch = "y", scales = "free") +
  theme_flynn() +
  theme(plot.title.position = "plot",
        strip.text.y.left = element_text(size = basesize *1.4, angle = 0, hjust = 0, margin = margin(l = 0.2, r = 0.2, unit = "cm")),
        strip.background = element_rect(size = 0.75),
        axis.text.x = element_text(size = basesize * 1.4),
        axis.text.y = element_blank(),
        axis.title = element_text(size = basesize * 1.4),
        axis.ticks.y = element_blank(),
        panel.spacing = unit(0.05, "cm"),
        panel.background = element_rect(size = 0.75),
        plot.title = element_text(size = basesize*1.6),
        legend.position = "bottom",
        legend.title = element_text(size = basesize * 1.4, margin = margin(b = -0.0, unit = "cm")),
        legend.text = element_text(size = basesize * 1.4, margin = margin(l = -0.2, unit = "cm")),
        legend.key.height = unit(0.6, "cm"),
        legend.key.size = unit(0.9, "cm")) +
  guides(color = guide_legend(reverse = TRUE, ncol = 1)) +
  viridis::scale_color_viridis(option = "magma", discrete = TRUE, begin = 0.1, end = 0.9) +
  labs(color = "Variable",
       x = "Country-Level Coefficients",
       y = "",
       title = "Varying Coefficients for Individual Protest Activity")

ggsave(here("Figures/Chapter-Protests/fig-coefplot-varyingeffect-opinion-model-5.png"), height = 9.5, width = 7, unit = "in")
ggsave(here("Figures/Chapter-Protests/fig-coefplot-varyingeffect-opinion-model-5.jpg"), height = 9.5, width = 7, unit = "in")

country.figures




```

```{r Cross-national change in predicted probabilities for crime}

# Read in model files
# Read in model files

op.protest.4 <- readRDS(here::here("Output/Chapter-Protests/op.protest.4.rds"))

mod.list <- list("Anti-US Protest" = op.protest.4)

# Values set to typical values found worldwide
newdata <- expand_grid(country = unique(op.protest.4$data$country),
                       year = 2019,
                         troops_crime_pers = c("No", "Yes"),
                         troops_crime_nonpers = c("No", "Yes"),
                         minority = "No",
                         contact_pers = "No",
                         benefit_pers = "No",
                         contact_nonpers = "No",
                         benefit_nonpers = "No",
                         age = "45 to 54 years",
                         ed_z = mean(o.data$ed_z, na.rm = TRUE),
                         ideology_z = mean(o.data$ideology_z, na.rm = TRUE),
                         income.5.cat = "41-60%",
                         gender = "Female",
                         american_inf_1 = "Some",
                         american_inf_2 = "Neither positive nor negative",
                         troops_1 = "Neutral",
                         basecount_z = mean(o.data$basecount_z, na.rm = TRUE),
                         gdp_z = mean(o.data$gdp_z, na.rm = TRUE),
                         pop_z = mean(o.data$pop_z, na.rm = TRUE),
                         troops_z = mean(o.data$troops_z, na.rm = TRUE))


tidy.pred <- lapply(mod.list, function(x) {
  
  temp.1 <- x %>% 
    epred_draws(newdata = newdata,
              re_forumla = ~(1 + age + ed_z + ideology_z + income.5.cat + gender + minority + troops_1 + contact_pers + contact_nonpers + benefit_pers + benefit_nonpers + troops_crime_pers + troops_crime_nonpers + american_inf_1 + american_inf_2 | p | country) + (1 | r | year) ,
              seed = 123) #%>% 
    #compare_levels(.epred, by = minority)

}
)

# Show group predictions
tidy.pred.df <- data.table::rbindlist(tidy.pred, idcol = TRUE) %>% 
  mutate(grouping = glue::glue("Personal Crime: {troops_crime_pers}, Network Crime: {troops_crime_nonpers}")) %>% 
  filter(grouping == "Personal Crime: No, Network Crime: No" |
           grouping == "Personal Crime: Yes, Network Crime: No" |
           grouping == "Personal Crime: No, Network Crime: Yes")

# Show difference between group predictions
tidy.pred.df.wide <- tidy.pred.df %>% 
  pivot_wider(id_cols = c(country, .id, grouping, .draw),
              names_from = grouping,
              values_from = .epred) 

# Collapse posteriors into vectors to explore overlaps
# Nice and neat People
test <- bayestestR::overlap(x = tidy.pred.df.wide$`Personal Crime: No, Network Crime: No`[tidy.pred.df.wide$country=="United Kingdom"],
                            y = tidy.pred.df.wide$`Personal Crime: Yes, Network Crime: No`[tidy.pred.df.wide$country=="United Kingdom"])

test
# This is how you pull the actual data frame of the distribution and overlapping values.

# This will let us look at specific effect sizes
bayestestR::point_estimate(tidy.pred.df$.epred[tidy.pred.df$country=="South Korea" & tidy.pred.df$grouping == "Personal Crime: Yes, Network Crime: No"])

# Looks at the percent of the posterior that falls within the range you provide
bayestestR::equivalence_test(tidy.pred.df$.epred[tidy.pred.df$country=="South Korea" & tidy.pred.df$grouping == "Personal Crime: Yes, Network Crime: No"], 
                             range = c(0.1, 0.8))


#### Country Group Differences ####
#### 
ggplot(tidy.pred.df %>% filter(country != "Kuwait"), aes(y = country, x = .epred, color = grouping)) +
  stat_pointinterval(.width = c(0.50, 0.80, 0.95), point_interval = median_qi, position = position_dodge(width = 0.5))  +
  geom_vline(xintercept = 0, size = 1.1, show.legend = FALSE) +
  viridis::scale_color_viridis(option = "magma", discrete = TRUE, begin = 0.1, end = 0.9) +
  scale_y_discrete(expand = c(0, 0)) +
  facet_grid(country~., switch = "y", scales = "free") +
  theme_flynn() +
  theme(panel.border = element_rect(size = 0.2),
        plot.title = element_text(size = basesize*1.4, lineheight = 0.4),
        plot.title.position = "plot",
        strip.background = element_rect(size = 0.2),
        strip.text = element_text(size = basesize * 1.2),
        strip.text.y.left = element_text(angle = 0, margin = margin(l=0.2, r = 0.3, unit = "cm"), hjust = 0),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = basesize * 1.2),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = basesize * 1.2),
        legend.title = element_text(size = basesize*1.2, margin = margin(t = -0, unit = "cm")),
        legend.position = "bottom",
        legend.box = "vertical",
        legend.text = element_text(size = basesize*1.2, margin = margin(t = 0.0, l = -0.3, unit = "cm")),
        legend.box.margin = margin(t = 0.05, unit = "cm"),
        panel.spacing = unit(0.1, "cm")) +
  guides(color = guide_legend(nrow = 3, reverse = TRUE),
         interval_lour = "none",
         interval_size = "none",
         interval_shape = "none",
         interval_alpha = "none",
         interval_linetype = "none") +
  labs(x = "Predicted Probability",
       y = "",
       color = "Experience",
       title = "Predicted Probability of Reporting Protest Attendance Across\nCountries According to Crime Experience")

ggsave(here::here("Figures/Chapter-Protests/figure-expected-conditional-countries.jpg"), height = 7, width = 6, units = "in")
       
#### Japan Posterior Direction Results ####
country.pd <- tidy.pred.df.wide %>% 
    dplyr::group_by(country, .id, .category) %>% 
    dplyr::summarise(median = median(difference),
                     pd = paste0(bayestestR::pd(difference))) %>% 
  dplyr::select(.id, country, .category, median, pd) %>% 
  arrange(.id, country, .category)


```

# Tables

## Individual Protest Predictions


```{r Protest full specification model}


op.protest.1 <- readRDS(here::here("Output/Chapter-Protests/op.protest.1.rds"))
op.protest.2 <- readRDS(here::here("Output/Chapter-Protests/op.protest.2.rds"))
op.protest.3 <- readRDS(here::here("Output/Chapter-Protests/op.protest.3.rds"))
op.protest.4 <- readRDS(here::here("Output/Chapter-Protests/op.protest.4.rds"))

op.model.list <- list("Base Model" = op.protest.1, 
                      "Demographics Only" = op.protest.2,
                      "Demographics and Attitudinal" = op.protest.3,
                      "Country and Province Variables" = op.protest.4)


class(op.model.list[[1]]) = c("custom", class(op.model.list[[1]]))
class(op.model.list[[2]]) = c("custom", class(op.model.list[[2]]))
class(op.model.list[[3]]) = c("custom", class(op.model.list[[3]]))
class(op.model.list[[4]]) = c("custom", class(op.model.list[[4]]))


coef.list <- c("minorityYes" = "Minority: Yes",
               "minorityDeclinetoanswer" = "Minority: DK/Decline",
               "age25to34years" = "25-34",
               "age35to44years" = "35-44",
               "age45to54years" = "45-54",
               "age55to64years" = "55-65",
               "ageAge65orolder" = ">65",
               "ed_z" = "Education",
               "ideology_z" = "Ideology",
               "income.5.cat21M40%" = "21-40",
               "income.5.cat41M60%" = "41-60",
               "income.5.cat61M80%" = "61-80",
               "income.5.cat81M100%" = "81-100",
               "genderFemale" = "Female",
               "genderNonMbinary" = "Non-binary",
               "genderNoneoftheabove" = "None of the above",
               "contact_persDontknowDdeclinetoanswer" = "Contact: DK/Decline",
               "contact_persYes" = "Contact: Yes",
               "contact_nonpersDontknowDdeclinetoanswer" = "Network Contact: DK/Decline",
               "contact_nonpersYes" = "Network Contact: Yes",
               "benefit_persDontknowDdeclinetoanswer" = "Benefit: DK/Decline",
               "benefit_persYes" = "Benefit: Yes",
               "troops_crime_persYes" = "Crime Experience: Yes",
               "american_inf_1DontknowDdeclinetoanswer" = "Influence 1: DK/Decline",
               "american_inf_1Alittle" = "Influence 1: A little",
               "american_inf_1Some" = "Influence 1: Some",
               "american_inf_1Alot" = "Influence 1: A lot",
               "american_inf_2DontknowDdeclinetoanswer" = "Influence 2: DK/Decline",
               "american_inf_2Veryative" = "Influence 2: Very negative",
               "american_inf_2Negative" = "Influence 2: Negative",
               "american_inf_2Positive" = "Influence 2: Positive",
               "american_inf_2Veryitive" = "Influence 2: Very positive",
               "basecount_z" = "Base count",
               "gdp_z" = "GDP",
               "pop_z" = "Population",
               "troops_z" = "Troop deployment size",
               "Intercept" = "Intercept")


# Calculate LOO IC
tic()
loo.1 <- loo(op.protest.1)
loo.2 <- loo(op.protest.2)
loo.3 <- loo(op.protest.3)
loo.4 <- loo(op.protest.4)
toc()



addedrows <- tribble(~term, ~`Base Model`, ~`Demographics Only`, ~`Demographics and Attitudes`, ~`Country and Province Variables`, ~`Full w/Varying Coefficients`,
                     "LOOIC", loo.1[["estimates"]][[3]], loo.2[["estimates"]][[3]], loo.3[["estimates"]][[3]], loo.4[["estimates"]][[3]], loo.5[["estimates"]][[3]])
  
  
# tidy method extracts level names into new column
tidy.custom = broom.mixed:::tidy.brmsfit
glance.custom = function(x, ...) {
  ret <- data.frame(
    "Link" = x$family$link,
    "Family" = x$family$family,
    "N" = nrow(x$data),
    `Num Groups (Country)` = summary(x)$ngrps$country,
    `Num Groups (Year)` = summary(x)$ngrps$year
  )
  colnames(ret) <- c("Link", "Family", "N", "Num Groups (Country)", "Num Groups (Year)")
  ret
}



tic()
# Troops Model
panel.1 <- modelsummary::modelsummary(op.model.list,
                                      statistic = "conf.int",
                                      stars = FALSE,
                                      coef_map = coef.list,
                                      add_rows = addedrows,
                                      longtable = TRUE,
                                      caption = "Bayesian multilevel logistic regressions predicting protest \\label{tab:predictiveopinionmodels}",
                                      output = "latex") 


panel.2 <- panel.1 %>%  
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 7, position = "left",
                stripe_index = c(1:2, 5:6, 9:10, 13:14, 17:18, 21:22, 25:26, 29:30, 33:34, 37:38, 41:42, 45:46, 49:50, 53:54, 57:58, 61:62, 65:66, 69:70)) %>%
  pack_rows("Minority Status", 1, 4, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Age", 5, 14, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Income Quantile", 19, 24, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Gender Identification", 27, 32, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Interpersonal Contact", 33, 36, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Network Contact", 37, 40, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Economic Benefits", 41, 44, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Personal Experience with Crime", 45, 46, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Amount of US Influence", 47, 54, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Quality of US Influence", 55, 60, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Group-level Variables", 61, 68, bold = TRUE, background = "gray", color = "white") %>% 
  pack_rows("Model Fit and Performance", 69, 74, bold = TRUE, background = "gray", color = "white") %>% 
  landscape() %>% 
  save_kable(., file = here("Tables/Chapter-Protests/model-protest-full.tex"),
             keep_tex = TRUE)

toc()


```



```{r table-protest-individual-models}

library(parallel)

op.protest.1 <- readRDS(here::here("Output/Chapter-Protests/op.protest.1.rds"))
op.protest.2 <- readRDS(here::here("Output/Chapter-Protests/op.protest.2.rds"))
op.protest.3 <- readRDS(here::here("Output/Chapter-Protests/op.protest.3.rds"))
op.protest.4 <- readRDS(here::here("Output/Chapter-Protests/op.protest.4.rds"))

mod.list <- list("Base Model" = op.protest.1, 
                 "Demographics" = op.protest.2,
                 "Demographics and Attitudes" = op.protest.3,
                 "Demographics, Attitudes, and Experiences" = op.protest.4)


for (i in seq_along(mod.list)){
  class(mod.list[[i]]) <- c("custom", class(mod.list[[i]]))
}
#### 
#### Pay close attention to how brms and/or parameters is treating the % symbols in the income variable. 
#### Depending on the output the code below will need to be updated so the income variable isn't dropped.

# tidy method extracts level names into new column
tidy.custom <- function(x, conf.level=.95, ...) {
  out = parameters::parameters(x, ci=conf.level, effects = "fixed", verbose=FALSE) %>%
        parameters::standardize_names(style="broom")
  return(out)
}

glance.custom <- function(x, ...) {
  ret <- tibble::tibble(N = summary(x)$nobs)
  ret
}


rows <- mclapply(mod.list, mc.cores = 4, function(x){

  temp.sd <- parameters::parameters(x, effects = "random", keep = ".*sd_.*", group_level = FALSE)  %>% 
    filter(grepl(".*sd.*", Parameter)) %>% 
    filter(grepl(".*Intercept.*", Parameter)) %>% 
    dplyr::select(Parameter, Median) %>% 
    dplyr::mutate(col2 = as.character(round(Median, 2))) %>% 
    mutate(Parameter = case_when(
      grepl(".*Intercept.*", Parameter) ~ "sd(Intercept)",
      grepl(".*age.*", Parameter) ~ "sd(Age)",
      grepl(".*ed_z.*", Parameter) ~ "sd(Education)",
      grepl(".*ideology_z.*", Parameter) ~ "sd(Ideology)",
      grepl(".*income.*", Parameter) ~ "sd(Income)",
      grepl(".*gender.*", Parameter) ~ "sd(Gender)",
      grepl(".*minority.*", Parameter) ~ "sd(Minority)",
      grepl(".*troops_1.*", Parameter) ~ "sd(Troops)",
      grepl(".*contact_pers.*", Parameter) ~ "sd(Personal Contact)",
      grepl(".*contact_nonpers.*", Parameter) ~ "sd(Network Contact)",
      grepl(".*benefit_pers.*", Parameter) ~ "sd(Personal Benefits)",
      grepl(".*benefit_nonpers.*", Parameter) ~ "sd(Network Benefits)",
      grepl(".*troops_crime_pers.*", Parameter) ~ "sd(Personal Crime)",
      grepl(".*troops_crime_nonpers.*", Parameter) ~ "sd(Network Crime)",
      grepl(".*inf_1.*", Parameter) ~ "sd(US Influence (Quantity))",
      grepl(".*inf_2.*", Parameter) ~ "sd(US Influence(Quality))"
    )) %>% 
    dplyr::select(-Median)
  
  temp.obs <- tibble::tribble(~Parameter, ~col2,
                              "N", as.character(nobs(x)), 
                              "Group", "Country", "", "",
                              "\\# Groups", as.character(length(unique(x$data$country))), "", "")
  
# temp.loo <- tibble::tribble(~Parameter, ~col2,
#                            "LOOIC", as.character(loo::loo(x)))
  
  temp.com <- bind_rows(temp.obs, temp.sd)

  return(temp.com)
  
  }
)

rows.com <- bind_cols(rows[[1]], rows[[2]], rows[[3]], rows[[4]]) %>% 
  dplyr::select(1, 2, 4, 6, 8) 

names(rows.com) <- c("term", "col1", "col2", "col3", "col4")

# Turn off GOF stuff
gof.check <- modelsummary::gof_map
gof.check$omit <- TRUE

coef.list <- tibble::tribble(~raw, ~clean,
                            "b_mu_troops_crime_persYes", "Personal Crime: Yes",
                            "b_mu_troops_crime_nonpersYes", "Network Crime: Yes",
                            "b_mu_contact_persYes", "Personal Contact: Yes",
                            "b_mu_contact_persDontknowDdeclinetoanswer", "Personal Contact: DK/Decline",
                            "b_mu_contact_nonpersYes", "Network Contact: Yes",
                            "b_mu_contact_nonpersDontknowDdeclinetoanswer", "Network Contact: DK/Decline",
                            "b_mu_benefit_persYes", "Personal Benefit: Yes",
                            "b_mu_benefit_persDontknowDdeclinetoanswer", "Personal Benefit: DK/Decline",
                            "b_mu_benefit_nonpersYes", "Network Benefit: Yes",
                            "b_mu_benefit_nonpersDontknowDdeclinetoanswer", "Network Benefit: DK/Decline",
                            "b_mu_minorityYes", "Minority: Yes",
                            "b_mu_minorityDeclinetoanswer", "Minoriy: Decline to answer",
                            "b_mu_age25to34years", "25-34",
                            "b_mu_age35to44years", "35-44",
                            "b_mu_age45to54years", "45-54",
                            "b_mu_age55to64years", "55-65",
                            "b_mu_ageAge65orolder", ">65",
                            "b_mu_income.5.cat21M40%", "21-40",
                            "b_mu_income.5.cat41M60%", "41-60",
                            "b_mu_income.5.cat61M80%", "61-80",
                            "b_mu_income.5.cat81M100%", "81-100",
                            "b_mu_genderFemale", "Female",
                            "b_mu_genderNonMbinary", "Non-binary",
                            "b_mu_genderNoneoftheabove", "None of the above",
                            "b_mu_ed_z", "Education",
                            "b_mu_ideology_z", "Ideology",
                            "b_mu_american_inf_1DontknowDdeclinetoanswer", "Influence 1: DK/Decline",
                            "b_mu_american_inf_1Alittle", "Influence 1: A little",
                            "b_mu_american_inf_1Some", "Influence 1: Some",
                            "b_mu_american_inf_1Alot", "Influence 1: A lot",
                            "b_mu_american_inf_2DontknowDdeclinetoanswer", "Influence 2: DK/Decline",
                            "b_mu_american_inf_2Veryative", "Influence 2: Very negative",
                            "b_mu_american_inf_2Negative", "Influence 2: Negative",
                            "b_mu_american_inf_2Positive", "Influence 2: Positive",
                            "b_mu_american_inf_2Veryitive", "Influence 2: Very positive",
                            "b_mu_basecount_z", "Base count",
                            "b_mu_gdp_z", "GDP",
                            "b_mu_pop_z", "Population",
                            "b_mu_troops_z", "Troop deployment size",
                            "b_mu_Intercept", "Intercept")


coef.list <- coef.list %>% 
  mutate(group = case_when(
           grepl(".*ontact.*", raw) ~ "Contact Status",
           grepl(".*enefit.*", raw) ~ "Economic Benefits",
           grepl(".*age.*", raw) ~ "Age",
           grepl(".*ncome.*", raw) ~ "Income Quintile",
           grepl(".*gender.*", raw) ~ "Gender Identification",
           grepl(".*minority.*", raw) ~ "Minority Self-Identification",
           grepl(".*relig.*", raw) ~ "Religious Identification",
           grepl(".*ed_z.*", raw) ~ "Education",
           grepl(".*ideology_z.*", raw) ~ "Ideology",
           grepl(".*crime.*", raw) ~ "Crime Experience",
           grepl(".*inf_1.*", raw) ~ "American Influence (Amount)",
           grepl(".*inf_2.*", raw) ~ "American Influence (Quality)",
           TRUE ~ "Group-Level Variables"
         )) 


# Find how long the coefficient list is for the final table hline
last.line <- length(coef.list[[1]]) * 2

coef_map <- setNames(coef.list$clean, coef.list$raw)
idx <- rle(coef.list$group)
idx <- setNames(idx$lengths  * 2, idx$values)


panel.1 <- modelsummary::modelsummary(mod.list,
                  estimate = "{estimate}",
                  statistic = "conf.int",
                  fmt = 2,
                  group = term ~ model,
                  gof_map = gof.check,
                  coef_map = coef_map,
                  add_rows = rows.com,
                  stars = FALSE,
                  longtable = TRUE,
                  output = "latex",
                  escape = FALSE,
                  caption = "Bayesian multilevel multinomial logistic regressions predicting attitudes towards US actors. Interaction between crime and contact. \\label{tab:crimetab1}") %>% 
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header"), protect_latex = TRUE, font_size = 4, position = "float_left") %>%
  group_rows(index = idx, bold = TRUE, background = "gray", color = "white", hline_after = TRUE) %>% 
  row_spec(last.line, hline_after = TRUE) %>% 
  landscape() %>% 
  kableExtra::save_kable(here("Tables/Chapter-Protests/model-protest-individual.tex"),
             keep_tex = TRUE)

```



## Prediction Assessment

### Percent Predicted Correctly

```{r Percent predicted correctly}

op.protest.1 <- readRDS(here::here("Output/Chapter-Protests/op.protest.1.rds"))
op.protest.2 <- readRDS(here::here("Output/Chapter-Protests/op.protest.2.rds"))
op.protest.3 <- readRDS(here::here("Output/Chapter-Protests/op.protest.3.rds"))
op.protest.4 <- readRDS(here::here("Output/Chapter-Protests/op.protest.4.rds"))

op.protest.1$data$predicted <- as.data.frame(predict(op.protest.1))
op.protest.2$data$predicted <- as.data.frame(predict(op.protest.2))
op.protest.3$data$predicted <- as.data.frame(predict(op.protest.3))
op.protest.4$data$predicted <- as.data.frame(predict(op.protest.4))


op.predict.list <- list(op.protest.1$data, 
                        op.protest.2$data, 
                        op.protest.3$data, 
                        op.protest.4$data)

prob = 0.01

# Huzzah!
op.predict.list.2 <- lapply(op.predict.list, function(x) 
                         dplyr::select(x, predicted, protest_dummy) %>% 
                         mutate(predicted.value = ifelse(predicted$Estimate >= 0.5, 1, 0),
                                match = ifelse(protest_dummy == "Yes" & predicted.value == 1 | protest_dummy == "No" & predicted.value == 0, 1, 0),
                         percent.correct = sum(match)/length(match),
                         false.neg = ifelse(predicted.value == 0 & protest_dummy == "Yes", 1, 0),
                         false.pos = ifelse(predicted.value == 1 & protest_dummy == "No", 1, 0),
                         true.neg = ifelse(protest_dummy == "No" & predicted.value == 0, 1, 0),
                         true.pos = ifelse(protest_dummy == "Yes" & predicted.value == 1, 1, 0),
                         total.no = ifelse(protest_dummy == "No", 1, 0),
                         total.yes = ifelse(protest_dummy == "Yes", 1, 0)) %>% 
                         dplyr::summarise(percent.correct = mean(percent.correct),
                                          false.neg = sum(false.neg),
                                          false.pos = sum(false.pos),
                                          true.neg = sum(true.neg),
                                          true.pos = sum(true.pos),
                                          total.no = sum(total.no),
                                          total.yes = sum(total.yes)) %>% 
                         mutate(`False Positive Rate` = false.pos/total.no,
                                `False Negative Rate` = false.neg/total.yes,
                                `Sensitivity` = true.pos/total.yes,
                                `Specificity` = true.neg/total.no))

op.predict.df <- bind_rows(op.predict.list.2) %>% 
  mutate(Model = c("Base Model", "Demographics", "Demographics and Attitudes", "Demographics, Attitudes, and Experiences")) %>% 
  dplyr::select(Model, percent.correct, `False Positive Rate`, `False Negative Rate`, `Sensitivity`, `Specificity`) %>% 
  mutate_at(vars(2:6),
            ~ paste((round(., 3)*100), "%", sep = ""))

names(op.predict.df) <- c("Model", "Correct", "False Positive", "False Negative", "Sensitivity", "Specificity")

op.predict.table <- kable(op.predict.df, "latex", align = "lrrrrr", caption = "Predictive model performance \\label{tab:predictivecheck}", booktabs = TRUE) %>% 
  kable_styling(latex_options = "striped", font_size = 9) %>% 
  column_spec(1, width = "6.4cm") %>% 
  column_spec(2, width = "1.5cm") %>% 
  column_spec(3, width = "1.5cm") %>% 
  column_spec(4, width = "1.5cm") %>% 
  column_spec(5, width = "1.5cm") %>% 
  column_spec(6, width = "1.5cm") %>% 
  footnote(number = c("\\\\scriptsize Correct predictions is the number of predicted values that match observed values divided by the total number of observations.",
                      "False positive rate is the number of incorrect positive predicted cases divided by the total number of actual observed negative cases. Rather, the percent of negative cases incorrectly classified as positive.", 
                      "False negative rate is the number of incorrect negative predicted cases divided by the total number of actual observed positive cases. Rather, the percent of positive cases incorrectly classified as negative.",
                      "Sensitivity is the number of predicted positive values divided by the total number of true positive values. Rather, the percent of positive cases that are correctly classified.",
                      "Specificity is the number of predicted negative values divided by the total number of true negative values. Rather, the percent of negative cases that are correctly classified."),
           fixed_small_size = TRUE,
           footnote_as_chunk = FALSE,
           threeparttable = TRUE,
           escape = FALSE) %>% 
  save_kable(here("Tables/Chapter-Protests/model-protest-predict-stats.tex"),
             keep_tex = TRUE)

  
```


### ROC Plot

```{r ROC plot}


# Create loop to generate ROC curve for different p values
results <- list()

prob <-  1

for(prob in 1:1000) {
# Huzzah!
  
op.predict.list.2 <- lapply(op.predict.list, function(x) 
  dplyr::select(x, predicted, protest_dummy) %>% 
    mutate(predicted.value = ifelse(predicted$Estimate >= (prob/1000), 1, 0),
           match = ifelse(protest_dummy == "Yes" & predicted.value == 1 | protest_dummy == "No" & predicted.value == 0, 1, 0),
           percent.correct = sum(match)/length(match),
           false.neg = ifelse(predicted.value == 0 & protest_dummy == "Yes", 1, 0),
           false.pos = ifelse(predicted.value == 1 & protest_dummy == "No", 1, 0),
           true.neg = ifelse(protest_dummy == "No" & predicted.value == 0, 1, 0),
           true.pos = ifelse(protest_dummy == "Yes" & predicted.value == 1, 1, 0),
           total.no = ifelse(protest_dummy == "No", 1, 0),
           total.yes = ifelse(protest_dummy == "Yes", 1, 0)) %>% 
    dplyr::summarise(percent.correct = mean(percent.correct),
                     false.neg = sum(false.neg),
                     false.pos = sum(false.pos),
                     true.neg = sum(true.neg),
                     true.pos = sum(true.pos),
                     total.no = sum(total.no),
                     total.yes = sum(total.yes)) %>% 
    mutate(`False Positive Rate` = false.pos/total.no,
           `False Negative Rate` = false.neg/total.yes,
           `Sensitivity` = true.pos/total.yes,
           `Specificity` = true.neg/total.no,
           pvalue = prob/1000))

op.predict.df <- bind_rows(op.predict.list.2) %>% 
  mutate(Model = c("Base Model", "Demographics", "Demographics and Attitudes", "Demographics, Attitudes, and Experiences")) %>% 
  dplyr::select(Model, percent.correct, `False Positive Rate`, `False Negative Rate`, `Sensitivity`, `Specificity`, pvalue) 

results[[prob]] <- op.predict.df

prob <- prob + 1 
}

results.df <- bind_rows(results) %>% 
  mutate(Model = factor(Model, levels = c("Base Model", "Demographics", "Demographics and Attitudes", "Demographics, Attitudes, and Experiences")))


roc.plot <- ggplot(results.df, aes(x = 1- Specificity, y = Sensitivity, color = Model, linetype = Model)) +
  geom_line(size = 1) +
  geom_abline(intercept = 0, slope = 1, color = "black", size = 1, linetype = "solid") +
  scale_x_continuous(expand = c(0, 0), labels = percent_format()) +
  scale_y_continuous(expand = c(0, 0), labels = percent_format()) +
  viridis::scale_color_viridis(option = "magma", discrete = TRUE, begin = 0.3, end = 0.9) +
  theme_flynn() +
  theme(axis.text = element_text(size = basesize),
        plot.title = element_text(size = basesize * 1.3),
        axis.title = element_text(size = basesize * 1.1),
        legend.title = element_text(size = basesize * 1.1),
        legend.position = "bottom",
        legend.key.width = unit(1, "cm"),
        legend.text = element_text(size = basesize * 1.1, margin = margin(l = -0.30, unit = "cm"))) +
  guides(color = guide_legend(ncol = 1)) +
  labs(x = "False Positive Rate",
       y = "True Positive Rate",
       title = "ROC Curve for Individual Protest Models")

roc.plot

ggsave(here("Figures/Chapter-Protests/fig-roc-plot.png"), width = 6, height = 6, units = "in")
ggsave(here("Figures/Chapter-Protests/fig-roc-plot.jpg"), width = 6, height = 6, units = "in")


### p value comparison plot
ggplot(results.df) +
  geom_line(aes(x = pvalue, y = Sensitivity, color = "Sensitivity"), size = 1) +
  geom_line(aes(x = pvalue, y = Specificity, color = "Specificity"), linetype = "longdash", size = 1) +
  geom_line(aes(x = pvalue, y = percent.correct, color = "Percent Correct"), linetype = "dashed", size = 1) +
  facet_wrap(. ~ Model, ncol = 2) +
  scale_y_continuous(breaks = seq(0, 1, 0.20), labels = percent_format()) +
  scale_color_brewer(palette = "Set2") +
  theme_flynn() +
  labs(x = "Probability threshold",
       y = "Percent",
       color = "Statistic")

ggsave(here("Figures/Chapter-Protests/fig-pvalue-comparison.png"), width = 8, height = 6, units = "in")
ggsave(here("Figures/Chapter-Protests/fig-pvalue-comparison.jpg"), width = 8, height = 6, units = "in")


```

### Percent Predicted Correctly (Targeted)

```{r Percent Predicted Correctly Targeted, echo=FALSE}

# Get rough estimate for point at which sensitivity and specificity are equal
pval <- summary(results.df$pvalue[round(results.df$Sensitivity, 2) == round(results.df$Specificity, 2) & results.df$Model=="Demographics, Attitudes, and Experiences"])[[3]]


results.df.targeted <- results.df %>% 
  filter(pvalue == round(pval, 2)) %>% 
  dplyr::select(Model, percent.correct, `False Positive Rate`, `False Negative Rate`, `Sensitivity`, `Specificity`) %>% 
  mutate_at(vars(2:6),
            ~ paste((round(., 3)*100), "%", sep = ""))

names(results.df.targeted) <- c("Model", "Correct", "False Positive", "False Negative", "Sensitivity", "Specificity")

op.predict.table.targeted <- kable(results.df.targeted, "latex", align = "lrrrrr", caption = "Predictive Model Performance with targeted probability threshold of 0.10 \\label{tab:predictivechecktargeted}", booktabs = TRUE) %>% 
  kable_styling(latex_options = "striped", font_size = 9) %>% 
  column_spec(1, width = "6.4cm") %>% 
  column_spec(2, width = "1.5cm") %>% 
  column_spec(3, width = "1.5cm") %>% 
  column_spec(4, width = "1.5cm") %>% 
  column_spec(5, width = "1.5cm") %>% 
  column_spec(6, width = "1.5cm") %>% 
  footnote(number = c("Correct predictions is the number of predicted values that match observed values divided by the total number of observations.",
                      "False positive rate is the number of incorrect positive predicted cases divided by the total number of actual observed negative cases. Rather, the percent of negative cases incorrectly classified as positive.", 
                      "False negative rate is the number of incorrect negative predicted cases divided by the total number of actual observed positive cases. Rather, the percent of positive cases incorrectly classified as negative.",
                      "Sensitivity is the number of predicted positive values divided by the total number of true positive values. Rather, the percent of positive cases that are correctly classified.",
                      "Specificity is the number of predicted negative values divided by the total number of true negative values. Rather, the percent of negative cases that are correctly classified."),
           fixed_small_size = TRUE,
           footnote_as_chunk = FALSE,
           threeparttable = TRUE,
           escape = FALSE) %>% 
  save_kable(here("Tables/Chapter-Protests/model-protest-predict-stats-targeted.tex"),
             keep_tex = TRUE)


```


## Negative Binomial Tables

```{r}


coef.map <- list("Intercept" = "Intercept",
     "troops_c_mean_z" = "Troops (Between)", "troops_c_demeaned_z" = "Troops (Within)",
     "troops_w_mean_c_mean_z" = "Regional Troops (Between)", "troops_w_mean_c_demeaned_z" = "Regional Troops (Within)",
     "v2x_polyarchy_c_mean_z"= "Polyarchy (Between)", "v2x_polyarchy_c_demeaned_z" = "Polyarchy (Within)",
     "exports_from_us_c_mean_z" = "US Exports (Between)", "exports_from_us_c_demeaned_z" = "US Exports (Within)",
     "gdp_c_mean_z" = "GDP (Between)", "gdp_c_demeaned_z" = "GDP (Within)",
     "gdp_growth_c_mean_z" = "Growth (Between)", "gdp_growth_c_demeaned_z" = "Growth (Within)",
     "v2x_polyarchy_c_mean_z_sq" = "Polyarchy Squared (Between)", "v2x_polyarchy_c_demeaned_z_sq" = "Polyarchy Squared (Within)",
     "troops_c_mean_z:v2x_polyarchy_change_c_mean_z" = "Troops $\\times$ Polyarchy (Between)", "troops_c_demeaned_z:v2x_polyarchy_change_c_demeaned_z" = "Troops $\\times$ Polyarchy (Within)",
     "troops_c_mean_z:gdp_growth_c_mean_z" = "Troops $\\times$ Growth (Between)", "troops_c_demeaned_z:gdp_growth_c_demeaned_z" = "Troops $\\times$ Growth (Within)",
     "pop_c_mean_z" = "Population (Between)", "pop_c_demeaned_z" = "Population (Within)",
     "protest_other_c_mean_z_lag" = "Protests (Between)", "protest_other_c_demeaned_z_lag" = "Protests (Within)",
     "protest_other_w_mean_c_mean_z_lag" = "Regional Protests (Between)", "protest_other_w_mean_c_demeaned_z_lag" = "Regional Protests (Within)",
     "idealdistance_2_c_mean_z" = "Ideal Distance (Between)", "idealdistance_2_c_demeaned_z" = "Ideal Distance (Within)",
     "conflict_dummy_c_mean_z" = "Conflict (Between)", "conflict_dummy_c_demeaned_z" = "Conflict (Within)",
     "us_war_c_mean" = "US War (Between)", "us_war_c_demeaned" = "US War (Within)",
     "us_war_w_mean_c_mean_z" = "US War in Region (Between)", "us_war_w_mean_c_demeaned_z" = "US War in Region (Within)",
     "us_ally_c_mean" = "US Ally (Between)", "us_ally_c_demeaned" = "US Ally (Within)",
     "defburden_w_mean_c_mean_z" = "Regional Military Spending (Between)", "defburden_w_mean_c_demeaned_z" = "Regional Military Spending (Within)",
     "anti_us_protest_w_mean_c_mean_z_lag" = "Spatial Lag (Between)", "anti_us_protest_w_mean_c_demeaned_z_lag" = "Spatial Lag (Within)")


               
gof.stats <- list("Varying Intercepts" = c("Yes", "Yes", "Yes", "Yes"),
                  "Group" = c("Country", "Country", "Country", "Country"),
                  "\\# Groups" = c(us.1[["fit"]]@par_dims[["r_1_1"]], 
                                   us.2[["fit"]]@par_dims[["r_1_1"]], 
                                   us.3[["fit"]]@par_dims[["r_1_1"]], 
                                   us.4[["fit"]]@par_dims[["r_1_1"]]),
                  "Serial Correlation" = c(round(mean(us.1[["fit"]]@sim[["samples"]][[1]][["ar[1]"]]), 2), " ", " ", " "),
                  "Dispersion Parameter" = c(mean(us.1[["fit"]]@sim[["samples"]][[1]][["shape"]]),
                                             mean(us.2[["fit"]]@sim[["samples"]][[1]][["shape"]]),
                                             mean(us.3[["fit"]]@sim[["samples"]][[1]][["shape"]]),
                                             mean(us.4[["fit"]]@sim[["samples"]][[1]][["shape"]])))

table.us.list <- list(us.1, us.2, us.3, us.4)

table.us <- texreg(table.us.list,
                   pars = c("b", "ar[1]", "shape"),
                   custom.coef.map = coef.map,
                   custom.gof.rows = gof.stats,
                   custom.gof.names = c("Std. Dev.", "R$^2$", "N"),
                   reorder.gof = c(1, 2, 3, 4, 5, 6, 7, 8),
                   digits = 2,
                   single.row = TRUE,
                   leading.zero = TRUE,
                   regex = TRUE,
                   caption = "Bayesian Negative Binomial Models of Anti-US Protest Events.",
                   caption.above = TRUE,
                   table = TRUE,
                   scalebox = 0.5,
                   dcolumn = TRUE,
                   float.pos = "t",
                   booktabs = TRUE,
                   include.loo.ic = FALSE,
                   include.waic = FALSE,
                   file = here("Tables/Chapter-Protests", "models-us-protest-nbreg-20200605.tex"))



gof.stats <- list("Varying Intercepts" = c("Yes", "Yes", "Yes", "Yes"),
                  "Group" = c("Country", "Country", "Country", "Country"),
                  "\\# Groups" = c(mil.1[["fit"]]@par_dims[["r_1_1"]], mil.2[["fit"]]@par_dims[["r_1_1"]], mil.3[["fit"]]@par_dims[["r_1_1"]], mil.4[["fit"]]@par_dims[["r_1_1"]]))

table.mil.list <- list(mil.1, mil.2, mil.3, mil.4)

table.mil <- texreg(table.mil.list,
                   pars = c("b", "ar"),
                   include.loo.ic = FALSE,
                   include.waic = FALSE,
                   custom.coef.map = coef.map,
                   custom.gof.rows = gof.stats,
                   custom.gof.names = c("Std. Dev.", "R$^2$", "N"),
                   reorder.gof = c(1, 2, 3, 4, 5, 6),
                   digits = 2,
                   single.row = TRUE,
                   leading.zero = TRUE,
                   regex = TRUE,
                   caption = "Bayesian Negative Binomial Models of Anti-US Military Protest Events.",
                   caption.above = TRUE,
                   table = TRUE,
                   scalebox = 0.5,
                   dcolumn = TRUE,
                   float.pos = "t",
                   booktabs = TRUE,
                   file = here("Tables/Chapter-Protests", "models-mil-protest-nbreg-20200605.tex"))



```

